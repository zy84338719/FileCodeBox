name: Build and Release

on:
  push:
    tags:
      - 'v*'
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  packages: write

jobs:
  build:
    name: Build for multiple platforms
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            output: filecodebox-linux-amd64
          - goos: linux
            goarch: arm64
            output: filecodebox-linux-arm64
          - goos: darwin
            goarch: amd64
            output: filecodebox-darwin-amd64
          - goos: darwin
            goarch: arm64
            output: filecodebox-darwin-arm64
          - goos: windows
            goarch: amd64
            output: filecodebox-windows-amd64.exe
          - goos: windows
            goarch: arm64
            output: filecodebox-windows-arm64.exe

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24'

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Download dependencies
      run: go mod download

    - name: Run tests
      run: go test ./...

    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 0
      run: |
        # è®¾ç½®ç‰ˆæœ¬ä¿¡æ¯
        VERSION=${{ github.ref_name }}
        if [ "$VERSION" = "main" ]; then
          VERSION="dev-$(git rev-parse --short HEAD)"
        fi
        
        COMMIT=$(git rev-parse HEAD)
        DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        go build \
          -ldflags="-s -w -X main.version=${VERSION} -X main.commit=${COMMIT} -X main.date=${DATE}" \
          -o ${{ matrix.output }} .
        
    - name: Create build info
      run: |
        echo "Build Info:" > build-info-${{ matrix.goos }}-${{ matrix.goarch }}.txt
        echo "Platform: ${{ matrix.goos }}/${{ matrix.goarch }}" >> build-info-${{ matrix.goos }}-${{ matrix.goarch }}.txt
        echo "Go Version: $(go version)" >> build-info-${{ matrix.goos }}-${{ matrix.goarch }}.txt
        echo "Build Time: $(date)" >> build-info-${{ matrix.goos }}-${{ matrix.goarch }}.txt
        echo "Commit: ${{ github.sha }}" >> build-info-${{ matrix.goos }}-${{ matrix.goarch }}.txt
        echo "Branch: ${{ github.ref_name }}" >> build-info-${{ matrix.goos }}-${{ matrix.goarch }}.txt

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: filecodebox-${{ matrix.goos }}-${{ matrix.goarch }}
        path: |
          ${{ matrix.output }}
          build-info-${{ matrix.goos }}-${{ matrix.goarch }}.txt

  docker-test:
    name: Test Docker build
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Extract metadata for testing
      id: meta-test
      uses: docker/metadata-action@v5
      with:
        images: filecodebox-test
        tags: |
          type=ref,event=branch
          type=raw,value=test

    - name: Build Docker image for testing
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64  # ä»…å•å¹³å°ç”¨äºŽæµ‹è¯•
        load: true  # åŠ è½½åˆ°æœ¬åœ°è¿›è¡Œæµ‹è¯•
        tags: ${{ steps.meta-test.outputs.tags }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test Docker image
      run: |
        # èŽ·å–æž„å»ºçš„é•œåƒæ ‡ç­¾
        IMAGE_TAG=$(echo "${{ steps.meta-test.outputs.tags }}" | head -n1)
        echo "Testing image: $IMAGE_TAG"
        
        # å¯åŠ¨å®¹å™¨è¿›è¡ŒåŸºç¡€æµ‹è¯•
        docker run --rm -d --name filecodebox-test -p 12346:12345 $IMAGE_TAG
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 10
        
        # æµ‹è¯•æœåŠ¡æ˜¯å¦å“åº”
        if curl -f http://localhost:12346/ > /dev/null 2>&1; then
          echo "âœ… Docker é•œåƒæµ‹è¯•æˆåŠŸ"
        else
          echo "âŒ Docker é•œåƒæµ‹è¯•å¤±è´¥"
          docker logs filecodebox-test
          exit 1
        fi
        
        # æ¸…ç†æµ‹è¯•å®¹å™¨
        docker stop filecodebox-test || true

  docker:
    name: Build and push Docker image
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/zy84338719/filecodebox
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=raw,value=latest
        labels: |
          org.opencontainers.image.title=FileCodeBox
          org.opencontainers.image.description=é«˜æ€§èƒ½æ–‡ä»¶åˆ†äº«æœåŠ¡ - Goè¯­è¨€å®žçŽ°
          org.opencontainers.image.vendor=FileCodeBox
          org.opencontainers.image.url=https://github.com/${{ github.repository }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.documentation=https://github.com/${{ github.repository }}#readme
          org.opencontainers.image.licenses=MIT

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64  # å¤šå¹³å°æž„å»ºç”¨äºŽå‘å¸ƒ
        push: true  # æŽ¨é€åˆ°æ³¨å†Œè¡¨
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        outputs: |
          type=image,name=target,annotation-index.org.opencontainers.image.description=FileCodeBox - é«˜æ€§èƒ½æ–‡ä»¶åˆ†äº«æœåŠ¡

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build, docker]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Prepare release assets
      run: |
        mkdir -p release-assets
        
        # å¤„ç†æ¯ä¸ªå¹³å°çš„æž„å»ºäº§ç‰©
        for dir in artifacts/*/; do
          if [ -d "$dir" ]; then
            platform=$(basename "$dir" | sed 's/filecodebox-//')
            echo "Processing $platform"
            
            # åˆ›å»ºå‘å¸ƒåŒ…
            cd "$dir"
            
            # æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶
            executable=$(find . -name "filecodebox*" -executable -type f | head -1)
            if [ -n "$executable" ]; then
              # åˆ›å»ºå‘å¸ƒç›®å½•
              release_name="filecodebox-${platform}"
              mkdir -p "../release-assets/$release_name"
              
              # å¤åˆ¶æ–‡ä»¶
              cp "$executable" "../release-assets/$release_name/"
              cp build-info-*.txt "../release-assets/$release_name/" 2>/dev/null || true
              
              # åˆ›å»ºREADME
              cat > "../release-assets/$release_name/README.txt" << EOF
        FileCodeBox - æ–‡ä»¶åˆ†äº«æœåŠ¡
        
        å¹³å°: $platform
        ç‰ˆæœ¬: ${{ github.ref_name }}
        æž„å»ºæ—¶é—´: $(date)
        
        ä½¿ç”¨æ–¹æ³•:
        1. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶å¯åŠ¨æœåŠ¡
        2. è®¿é—® http://localhost:12345
        3. ç®¡ç†å‘˜è®¿é—® http://localhost:12345/admin
        
        æ›´å¤šä¿¡æ¯: https://github.com/${{ github.repository }}
        EOF
              
              # æ‰“åŒ…
              cd "../release-assets"
              if [[ "$platform" == *"windows"* ]]; then
                zip -r "${release_name}.zip" "$release_name/"
              else
                tar -czf "${release_name}.tar.gz" "$release_name/"
              fi
              rm -rf "$release_name"
            fi
            
            cd - > /dev/null
          fi
        done

    - name: Generate release notes
      run: |
        cat > release-notes.md << EOF
        ## FileCodeBox ${{ github.ref_name }}
        
        ### ðŸš€ æ–°ç‰¹æ€§
        - å¤šå¹³å°å¯æ‰§è¡Œæ–‡ä»¶æ”¯æŒ (Linux, macOS, Windows)
        - æ”¯æŒ AMD64 å’Œ ARM64 æž¶æž„
        - Docker é•œåƒè‡ªåŠ¨æž„å»º
        
        ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
        
        **å¯æ‰§è¡Œæ–‡ä»¶:**
        - \`filecodebox-linux-amd64.tar.gz\` - Linux x64
        - \`filecodebox-linux-arm64.tar.gz\` - Linux ARM64
        - \`filecodebox-darwin-amd64.tar.gz\` - macOS Intel
        - \`filecodebox-darwin-arm64.tar.gz\` - macOS Apple Silicon
        - \`filecodebox-windows-amd64.zip\` - Windows x64
        - \`filecodebox-windows-arm64.zip\` - Windows ARM64
        
        **Docker é•œåƒ:**
        \`\`\`bash
        docker pull ghcr.io/zy84338719/filecodebox:${{ github.ref_name }}
        # æˆ–è€…æœ€æ–°ç‰ˆæœ¬
        docker pull ghcr.io/zy84338719/filecodebox:latest
        \`\`\`
        
        ### ðŸ”§ å¿«é€Ÿå¼€å§‹
        
        1. ä¸‹è½½å¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶
        2. è§£åŽ‹åŽè¿è¡Œ filecodebox
        3. è®¿é—® http://localhost:12345
        4. ç®¡ç†å‘˜ç•Œé¢: http://localhost:12345/admin (é»˜è®¤å¯†ç : admin)
        
        ### ðŸ“‹ ç³»ç»Ÿè¦æ±‚
        - æ— ç‰¹æ®Šä¾èµ–
        - æ”¯æŒæ‰€æœ‰ä¸»æµæ“ä½œç³»ç»Ÿ
        - æœ€å°å†…å­˜: 64MB
        - æŽ¨èå†…å­˜: 256MB+
        
        ---
        
        **å®Œæ•´æ›´æ–°æ—¥å¿—å’Œæ–‡æ¡£:** https://github.com/${{ github.repository }}
        EOF

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: release-assets/*
        name: FileCodeBox ${{ github.ref_name }}
        body_path: release-notes.md
        draft: false
        prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
