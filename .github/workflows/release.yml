name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–æ‰€æœ‰åŽ†å²ä»¥ä¾¿ç”Ÿæˆå˜æ›´æ—¥å¿—

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'

    - name: Install bc (for cross-build script)
      run: sudo apt-get update && sudo apt-get install -y bc

    - name: Download dependencies
      run: make deps

    - name: Run tests
      run: make test

    - name: Cross compile all platforms
      run: |
        # ä½¿ç”¨æˆ‘ä»¬çš„äº¤å‰ç¼–è¯‘è„šæœ¬
        chmod +x scripts/cross-build.sh
        ./scripts/cross-build.sh

    - name: Generate release notes
      run: |
        # èŽ·å–å½“å‰å’Œå‰ä¸€ä¸ªæ ‡ç­¾
        CURRENT_TAG="${{ github.ref_name }}"
        PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -A1 "$CURRENT_TAG" | tail -1)
        
        # å¦‚æžœæ²¡æœ‰å‰ä¸€ä¸ªæ ‡ç­¾ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæäº¤
        if [ -z "$PREVIOUS_TAG" ] || [ "$PREVIOUS_TAG" = "$CURRENT_TAG" ]; then
          PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
        fi
        
        echo "ç”Ÿæˆä»Ž $PREVIOUS_TAG åˆ° $CURRENT_TAG çš„å˜æ›´æ—¥å¿—"
        
        # èŽ·å–æäº¤ä¿¡æ¯
        COMMITS=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..$CURRENT_TAG 2>/dev/null || git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD)
        
        # èŽ·å–æ–‡ä»¶å˜æ›´ç»Ÿè®¡
        STATS=$(git diff --stat $PREVIOUS_TAG..$CURRENT_TAG 2>/dev/null || git diff --stat $PREVIOUS_TAG..HEAD || echo "é¦–æ¬¡å‘å¸ƒ")
        
        cat > release-notes.md << EOF
        ## FileCodeBox $CURRENT_TAG
        
        ### ðŸ“ æœ¬æ¬¡æ›´æ–°
        
        $COMMITS
        
        ### ðŸ“Š å˜æ›´ç»Ÿè®¡
        \`\`\`
        $STATS
        \`\`\`
        
        ### ðŸš€ åŠŸèƒ½ç‰¹æ€§
        - âœ… å¤šå¹³å°å¯æ‰§è¡Œæ–‡ä»¶æ”¯æŒ (Linux, macOS, Windows)
        - âœ… æ”¯æŒ AMD64 å’Œ ARM64 æž¶æž„
        - âœ… Docker é•œåƒè‡ªåŠ¨æž„å»ºå’Œå‘å¸ƒ
        - âœ… æ–‡ä»¶ä¸Šä¼ ä¸‹è½½æœåŠ¡
        - âœ… ç”¨æˆ·è®¤è¯ç³»ç»Ÿ
        - âœ… ç®¡ç†å‘˜æŽ§åˆ¶é¢æ¿
        - âœ… å¤šç§å­˜å‚¨åŽç«¯æ”¯æŒ (æœ¬åœ°/S3/WebDAV/NFS)
        - âœ… åˆ†ç‰‡ä¸Šä¼ æ”¯æŒ
        - âœ… MCP (Model Context Protocol) æœåŠ¡å™¨æ”¯æŒ
        
        ### ðŸ“¦ å®‰è£…æ–¹å¼
        
        #### æ–¹å¼ä¸€ï¼šç›´æŽ¥ä¸‹è½½å¯æ‰§è¡Œæ–‡ä»¶
        
        é€‰æ‹©å¯¹åº”å¹³å°çš„æ–‡ä»¶ä¸‹è½½ï¼š
        - ðŸ§ **Linux x64**: \`filecodebox-$CURRENT_TAG-linux-amd64\`
        - ðŸ§ **Linux ARM64**: \`filecodebox-$CURRENT_TAG-linux-arm64\`
        - ðŸ§ **Linux x86**: \`filecodebox-$CURRENT_TAG-linux-386\`
        - ðŸ§ **Linux ARM**: \`filecodebox-$CURRENT_TAG-linux-arm\`
        - ðŸŽ **macOS Intel**: \`filecodebox-$CURRENT_TAG-darwin-amd64\`
        - ðŸŽ **macOS Apple Silicon**: \`filecodebox-$CURRENT_TAG-darwin-arm64\`
        - ðŸªŸ **Windows x64**: \`filecodebox-$CURRENT_TAG-windows-amd64.exe\`
        - ðŸªŸ **Windows x86**: \`filecodebox-$CURRENT_TAG-windows-386.exe\`
        - ðŸ”§ **FreeBSD x64**: \`filecodebox-$CURRENT_TAG-freebsd-amd64\`
        - ðŸ”§ **FreeBSD ARM64**: \`filecodebox-$CURRENT_TAG-freebsd-arm64\`
        
        #### æ–¹å¼äºŒï¼šDocker éƒ¨ç½²
        
        \`\`\`bash
        # æ‹‰å–é•œåƒ
        docker pull ghcr.io/zy84338719/filecodebox:$CURRENT_TAG
        
        # è¿è¡Œå®¹å™¨
        docker run -d \\
          --name filecodebox \\
          -p 12345:12345 \\
          -v ./data:/app/data \\
          ghcr.io/zy84338719/filecodebox:$CURRENT_TAG
        \`\`\`
        
        #### æ–¹å¼ä¸‰ï¼šDocker Compose
        
        \`\`\`yaml
        version: '3.8'
        services:
          filecodebox:
            image: ghcr.io/zy84338719/filecodebox:$CURRENT_TAG
            ports:
              - "12345:12345"
            volumes:
              - ./data:/app/data
            restart: unless-stopped
        \`\`\`
        
        #### æ–¹å¼å››ï¼šæºç ç¼–è¯‘
        
        \`\`\`bash
        git clone https://github.com/zy84338719/filecodebox.git
        cd filecodebox
        git checkout $CURRENT_TAG
        make build
        \`\`\`
        
        ### ðŸ”§ å¿«é€Ÿå¼€å§‹
        
        1. **ä¸‹è½½å¹¶å¯åŠ¨æœåŠ¡**
           - ä¸‹è½½å¯¹åº”å¹³å°çš„æ–‡ä»¶
           - è¿è¡Œ \`./filecodebox\` (Linux/macOS) æˆ– \`filecodebox.exe\` (Windows)
        
        2. **è®¿é—®æœåŠ¡**
           - ç”¨æˆ·ç•Œé¢: http://localhost:12345
           - ç®¡ç†å‘˜ç•Œé¢: http://localhost:12345/admin
           - API æ–‡æ¡£: http://localhost:12345/swagger/index.html
           - é»˜è®¤ç®¡ç†å‘˜å¯†ç : \`FileCodeBox2025\`
        
        3. **åŸºæœ¬é…ç½®**
           - ä¿®æ”¹ç®¡ç†å‘˜å¯†ç 
           - é…ç½®å­˜å‚¨åŽç«¯
           - è®¾ç½®ç”¨æˆ·ç³»ç»Ÿå¼€å…³
        
        ### ðŸ“‹ ç³»ç»Ÿè¦æ±‚
        
        - **æ“ä½œç³»ç»Ÿ**: Linux, macOS, Windows, FreeBSD
        - **æž¶æž„**: AMD64, ARM64, 386, ARM
        - **å†…å­˜**: æœ€å° 64MBï¼ŒæŽ¨è 256MB+
        - **å­˜å‚¨**: æ ¹æ®ä½¿ç”¨é‡è€Œå®š
        - **ç½‘ç»œ**: HTTP/HTTPS ç«¯å£è®¿é—®
        
        ### ðŸ”’ å®‰å…¨è¯´æ˜Ž
        
        - é¦–æ¬¡å¯åŠ¨è¯·ç«‹å³ä¿®æ”¹é»˜è®¤ç®¡ç†å‘˜å¯†ç 
        - ç”Ÿäº§çŽ¯å¢ƒå»ºè®®é…ç½® HTTPS
        - å®šæœŸå¤‡ä»½æ•°æ®ç›®å½•
        - å»ºè®®é…ç½®é˜²ç«å¢™è§„åˆ™
        
        ### ðŸ†˜ é—®é¢˜åé¦ˆ
        
        å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·è®¿é—®ï¼š
        - **GitHub Issues**: https://github.com/${{ github.repository }}/issues
        - **æ–‡æ¡£**: https://github.com/${{ github.repository }}#readme
        
        ### ðŸ“– æ›´æ–°è¯´æ˜Ž
        
        - æ”¯æŒé€šè¿‡ \`./filecodebox -version\` æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯
        - ç‰ˆæœ¬å·çŽ°åœ¨ä½¿ç”¨ Git tag è‡ªåŠ¨ç®¡ç†
        - æž„å»ºç³»ç»Ÿå·²ä¼˜åŒ–ï¼Œæ”¯æŒ Makefile å’Œè„šæœ¬æž„å»º
        
        ---
        
        **æž„å»ºä¿¡æ¯**
        - æž„å»ºæ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        - Git æäº¤: ${{ github.sha }}
        - Go ç‰ˆæœ¬: $(go version | cut -d' ' -f3)
        EOF

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: dist/*
        name: FileCodeBox ${{ github.ref_name }}
        body_path: release-notes.md
        draft: false
        prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker:
    name: Build and push Docker image
    runs-on: ubuntu-latest
    needs: release
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/zy84338719/filecodebox
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=raw,value=latest
        labels: |
          org.opencontainers.image.title=FileCodeBox
          org.opencontainers.image.description=é«˜æ€§èƒ½æ–‡ä»¶åˆ†äº«æœåŠ¡ - Goè¯­è¨€å®žçŽ°
          org.opencontainers.image.vendor=FileCodeBox
          org.opencontainers.image.url=https://github.com/${{ github.repository }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.documentation=https://github.com/${{ github.repository }}#readme
          org.opencontainers.image.licenses=MIT

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VERSION=${{ github.ref_name }}
          COMMIT=${{ github.sha }}
          BUILD_TIME=${{ github.event.head_commit.timestamp }}
