package main

// @title FileCodeBox API
// @version 1.0
// @description FileCodeBox 是一个用于文件分享和代码片段管理的 Web 应用程序
// @termsOfService http://swagger.io/terms/

// @contact.name API Support
// @contact.url http://www.swagger.io/support
// @contact.email support@swagger.io

// @license.name MIT
// @license.url https://github.com/zy84338719/filecodebox/blob/main/LICENSE

// @host localhost:12345
// @BasePath /

// @securityDefinitions.apikey ApiKeyAuth
// @in header
// @name X-API-Key

// @securityDefinitions.basic BasicAuth

import (
	"flag"
	"fmt"
	"os"
	"os/signal"
	"syscall"
	"time"

	"github.com/zy84338719/filecodebox/internal/config"
	"github.com/zy84338719/filecodebox/internal/dao"
	"github.com/zy84338719/filecodebox/internal/database"
	"github.com/zy84338719/filecodebox/internal/mcp"
	"github.com/zy84338719/filecodebox/internal/models"
	"github.com/zy84338719/filecodebox/internal/routes"
	"github.com/zy84338719/filecodebox/internal/services"
	"github.com/zy84338719/filecodebox/internal/storage"
	"github.com/zy84338719/filecodebox/internal/tasks"

	"github.com/sirupsen/logrus"

	// swagger docs
	_ "github.com/zy84338719/filecodebox/docs"
)

var (
	version = "dev"
	commit  = "unknown"
	date    = "unknown"
)

func main() {
	// 解析命令行参数
	var showVersion = flag.Bool("version", false, "show version information")
	flag.Parse()

	if *showVersion {
		fmt.Printf("FileCodeBox %s\n", version)
		fmt.Printf("Commit: %s\n", commit)
		fmt.Printf("Built: %s\n", date)
		fmt.Printf("Go Version: %s\n", "go1.21+")
		return
	}

	// 初始化配置
	cfg := config.Init()

	// 初始化日志
	logrus.SetLevel(logrus.InfoLevel)
	logrus.SetFormatter(&logrus.TextFormatter{
		FullTimestamp: true,
	})

	logrus.Info("正在初始化应用...")

	// 初始化数据库
	db, err := database.Init(cfg)
	if err != nil {
		logrus.Fatal("初始化数据库失败:", err)
	}

	// 自动迁移（需要在配置初始化前进行）
	err = db.AutoMigrate(&models.FileCode{},
		&models.UploadChunk{}, &models.KeyValue{}, &models.User{}, &models.UserSession{})
	if err != nil {
		logrus.Fatal("数据库迁移失败:", err)
	}

	// 使用数据库初始化配置
	if err := cfg.InitWithDB(db); err != nil {
		logrus.Fatal("初始化配置失败:", err)
	}

	// 初始化存储
	storageManager := storage.NewStorageManager(cfg)

	// 初始化 DAO 管理器
	daoManager := dao.NewDAOManager(db)

	// 初始化服务（为了MCP服务器）
	userService := services.NewUserService(daoManager, cfg)
	shareService := services.NewShareService(daoManager, cfg, storageManager, userService)
	adminService := services.NewAdminService(daoManager, cfg, storageManager)

	// 初始化清理任务
	taskManager := tasks.NewTaskManager(daoManager, storageManager, cfg.DataPath)
	taskManager.Start()
	defer taskManager.Stop()

	// 创建并配置路由（包含Gin初始化、中间件、路由设置）
	srv, err := routes.CreateAndStartServer(cfg, daoManager, storageManager)
	if err != nil {
		logrus.Fatal("创建服务器失败:", err)
	}

	// 启动 MCP 服务器（可选，通过环境变量控制）
	if os.Getenv("ENABLE_MCP_SERVER") == "true" {
		mcpPort := os.Getenv("MCP_PORT")
		if mcpPort == "" {
			mcpPort = "8081" // 默认端口
		}
		
		mcpServer := mcp.NewFileCodeBoxMCPServer(cfg, daoManager, storageManager, shareService, adminService, userService)
		
		// 在后台启动 MCP 服务器
		go func() {
			logrus.Infof("启动 MCP 服务器，监听端口: %s", mcpPort)
			if err := mcpServer.ServeTCP(":" + mcpPort); err != nil {
				logrus.Errorf("MCP 服务器启动失败: %v", err)
			}
		}()
	}

	logrus.Info("应用初始化完成")

	// 等待中断信号
	quit := make(chan os.Signal, 1)
	signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)
	<-quit

	logrus.Info("正在关闭服务器...")

	// 优雅关闭
	if err := routes.GracefulShutdown(srv, 30*time.Second); err != nil {
		logrus.Fatal("关闭服务器失败:", err)
	}
}
