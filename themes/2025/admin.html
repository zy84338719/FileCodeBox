<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå° - FileCodeBox</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/logo-small.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
            font-size: 1.5em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .tabs {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .tab-header {
            display: flex;
            border-bottom: 1px solid #eee;
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            padding: 20px;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-text {
            display: block;
            margin-top: 5px;
            font-size: 0.875em;
            color: #666;
            line-height: 1.4;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background 0.3s ease;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .table tr:hover {
            background: #f8f9fa;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
        }
        
        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        
        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .btn-sm {
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            margin-right: 5px;
            margin-bottom: 5px;
            transition: background 0.3s ease;
        }
        
        .btn-sm:hover {
            background: #5a6fd8;
        }
        
        .btn-sm.active {
            background: #495057;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-header {
                flex-direction: column;
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
            }
            
            .table {
                font-size: 0.8em;
            }
        }
        
        /* ç”¨æˆ·ç®¡ç†æ ·å¼ */
        .user-stats {
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .user-email {
            color: #666;
            font-size: 0.9em;
        }
        
        .user-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .role-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .role-admin {
            background: #667eea;
            color: white;
        }
        
        .role-user {
            background: #e9ecef;
            color: #495057;
        }
        
        .user-actions {
            display: flex;
            gap: 5px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .close {
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .modal-form .form-group {
            margin-bottom: 20px;
        }
        
        .modal-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .modal-form .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .modal-form .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .modal-form select.form-control {
            cursor: pointer;
        }
        
        .modal-form .btn {
            margin-right: 10px;
        }
        
        .user-row {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .user-row:hover {
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <!-- æœªæˆæƒè®¿é—®é¡µé¢ -->
    <div id="unauthorized-page" class="login-container" style="display: none;">
        <h2 class="login-title">è®¿é—®è¢«æ‹’ç»</h2>
        <div style="text-align: center; margin-top: 20px;">
            <p>æ‚¨éœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½è®¿é—®æ­¤é¡µé¢</p>
            <a href="/user/login" class="btn">è¿”å›ç™»å½•</a>
        </div>
    </div>

    <!-- ç®¡ç†é¡µé¢ -->
    <div id="admin-page" style="display: none;">
        <div class="container">
            <div class="header">
                <div class="logo">
                    <img class="logo-icon" src="/assets/images/logo-small.svg" alt="FileCodeBox Logo"/>
                    <span>FileCodeBox ç®¡ç†åå°</span>
                </div>
                <div class="header-actions">
                    <a href="/user/dashboard" class="btn" style="margin-right: 10px;">è¿”å›ç”¨æˆ·ä¸­å¿ƒ</a>
                    <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
            </div>

            <div class="stats-grid" id="stats-grid">
                <!-- ç»Ÿè®¡æ•°æ®å°†é€šè¿‡JavaScriptå¡«å…… -->
            </div>

            <div class="tabs">
                <div class="tab-header">
                    <button class="tab-btn active" onclick="switchTab('files')">æ–‡ä»¶ç®¡ç†</button>
                    <button class="tab-btn" onclick="switchTab('users')">ç”¨æˆ·ç®¡ç†</button>
                    <button class="tab-btn" onclick="switchTab('storage')">å­˜å‚¨ç®¡ç†</button>
                    <button class="tab-btn" onclick="switchTab('mcp')">MCP æœåŠ¡å™¨</button>
                    <button class="tab-btn" onclick="switchTab('config')">ç³»ç»Ÿé…ç½®</button>
                    <button class="tab-btn" onclick="switchTab('maintenance')">ç³»ç»Ÿç»´æŠ¤</button>
                </div>

                <!-- æ–‡ä»¶ç®¡ç† -->
                <div id="files-tab" class="tab-content active">
                    <div class="search-box">
                        <input type="text" class="form-control" id="search-input" placeholder="æœç´¢æ–‡ä»¶..." style="display: inline-block; width: 300px; margin-right: 10px;">
                        <button class="btn" onclick="searchFiles()">æœç´¢</button>
                        <button class="btn" onclick="loadFiles()">åˆ·æ–°</button>
                    </div>
                    
                    <div id="files-content">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                    
                    <div class="pagination" id="pagination">
                        <!-- åˆ†é¡µå°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                </div>

                <!-- ç”¨æˆ·ç®¡ç† -->
                <div id="users-tab" class="tab-content">
                    <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>ç”¨æˆ·ç®¡ç†</h3>
                        <button class="btn" onclick="loadUsers()">åˆ·æ–°</button>
                    </div>
                    
                    <!-- ç”¨æˆ·ç»Ÿè®¡ -->
                    <div class="user-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;" id="user-stats">
                        <!-- ç»Ÿè®¡å¡ç‰‡å°†åŠ¨æ€åŠ è½½ -->
                    </div>
                    
                    <!-- ç”¨æˆ·æœç´¢ -->
                    <div class="search-box">
                        <input type="text" class="form-control" id="user-search-input" placeholder="æœç´¢ç”¨æˆ·åæˆ–é‚®ç®±..." style="display: inline-block; width: 300px; margin-right: 10px;">
                        <button class="btn" onclick="searchUsers()">æœç´¢</button>
                        <button class="btn" onclick="showCreateUserModal()">æ·»åŠ ç”¨æˆ·</button>
                    </div>
                    
                    <!-- ç”¨æˆ·åˆ—è¡¨ -->
                    <div id="users-content">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                    
                    <!-- åˆ†é¡µ -->
                    <div class="pagination" id="user-pagination">
                        <!-- åˆ†é¡µå°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                </div>

                <!-- å­˜å‚¨ç®¡ç† -->
                <div id="storage-tab" class="tab-content">
                    <h3>å­˜å‚¨ç®¡ç†</h3>
                    <p style="color: #666; margin-bottom: 30px;">ç®¡ç†æ–‡ä»¶å­˜å‚¨ä½ç½®ï¼Œæ”¯æŒæœ¬åœ°å­˜å‚¨å’Œ WebDAV è¿œç¨‹å­˜å‚¨</p>
                    
                    <!-- å­˜å‚¨ç±»å‹å¡ç‰‡ -->
                    <div class="storage-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- æœ¬åœ°å­˜å‚¨å¡ç‰‡ -->
                        <div class="storage-card" id="local-card" style="border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <div class="storage-icon" style="width: 40px; height: 40px; background: #28a745; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <span style="color: white; font-size: 18px;">ğŸ’¾</span>
                                </div>
                                <div>
                                    <h4 style="margin: 0;">æœ¬åœ°å­˜å‚¨</h4>
                                    <p style="margin: 0; color: #666; font-size: 14px;">æ–‡ä»¶å­˜å‚¨åœ¨æœåŠ¡å™¨æœ¬åœ°ç£ç›˜</p>
                                </div>
                            </div>
                            <div class="storage-status" id="local-status">
                                <span class="status-badge" style="display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="storage-config" id="local-config" style="margin-top: 15px; display: none;">
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">å­˜å‚¨è·¯å¾„</label>
                                    <input type="text" id="local-storage-path" class="form-control" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤è·¯å¾„ (./data/share/data)" style="width: 100%;">
                                    <small style="color: #666;">å¯ä»¥æŒ‡å®šè‡ªå®šä¹‰çš„å­˜å‚¨è·¯å¾„ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤è·¯å¾„</small>
                                </div>
                            </div>
                        </div>

                        <!-- WebDAV å­˜å‚¨å¡ç‰‡ -->
                        <div class="storage-card" id="webdav-card" style="border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <div class="storage-icon" style="width: 40px; height: 40px; background: #007bff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <span style="color: white; font-size: 18px;">â˜ï¸</span>
                                </div>
                                <div>
                                    <h4 style="margin: 0;">WebDAV å­˜å‚¨</h4>
                                    <p style="margin: 0; color: #666; font-size: 14px;">æ–‡ä»¶å­˜å‚¨åœ¨ WebDAV è¿œç¨‹æœåŠ¡å™¨</p>
                                </div>
                            </div>
                            <div class="storage-status" id="webdav-status">
                                <span class="status-badge" style="display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="storage-config" id="webdav-config" style="margin-top: 15px; display: none;">
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">æœåŠ¡å™¨åœ°å€</label>
                                    <input type="text" id="webdav-hostname" class="form-control" placeholder="http://example.com:5005" style="width: 100%;">
                                    <small style="color: #666;">WebDAV æœåŠ¡å™¨çš„å®Œæ•´åœ°å€ï¼ŒåŒ…å«åè®®å’Œç«¯å£</small>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ç”¨æˆ·å</label>
                                        <input type="text" id="webdav-username" class="form-control" style="width: 100%;">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å¯†ç </label>
                                        <input type="password" id="webdav-password" class="form-control" style="width: 100%;">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ ¹ç›®å½•</label>
                                    <input type="text" id="webdav-root-path" class="form-control" placeholder="filebox_storage" style="width: 100%;">
                                    <small style="color: #666;">åœ¨ WebDAV æœåŠ¡å™¨ä¸Šåˆ›å»ºçš„å­˜å‚¨ç›®å½•åç§°</small>
                                </div>
                            </div>
                        </div>

                        <!-- NFS å­˜å‚¨å¡ç‰‡ -->
                        <div class="storage-card" id="nfs-card" style="border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <div class="storage-icon" style="width: 40px; height: 40px; background: #6f42c1; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <span style="color: white; font-size: 18px;">ğŸ—‚ï¸</span>
                                </div>
                                <div>
                                    <h4 style="margin: 0;">NFS ç½‘ç»œå­˜å‚¨</h4>
                                    <p style="margin: 0; color: #666; font-size: 14px;">æ–‡ä»¶å­˜å‚¨åœ¨ NFS ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ</p>
                                </div>
                            </div>
                            <div class="storage-status" id="nfs-status">
                                <span class="status-badge" style="display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="storage-config" id="nfs-config" style="margin-top: 15px; display: none;">
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">NFS æœåŠ¡å™¨åœ°å€</label>
                                    <input type="text" id="nfs-server" class="form-control" placeholder="192.168.1.100" style="width: 100%;">
                                    <small style="color: #666;">NFS æœåŠ¡å™¨çš„ IP åœ°å€æˆ–åŸŸå</small>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">NFS è·¯å¾„</label>
                                        <input type="text" id="nfs-path" class="form-control" placeholder="/nfs/storage" style="width: 100%;">
                                        <small style="color: #666;">æœåŠ¡å™¨å¯¼å‡ºçš„è·¯å¾„</small>
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">æŒ‚è½½ç‚¹</label>
                                        <input type="text" id="nfs-mount-point" class="form-control" placeholder="/mnt/nfs" style="width: 100%;">
                                        <small style="color: #666;">æœ¬åœ°æŒ‚è½½ç›®å½•</small>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">NFS ç‰ˆæœ¬</label>
                                        <select id="nfs-version" class="form-control" style="width: 100%;">
                                            <option value="3">NFSv3</option>
                                            <option value="4" selected>NFSv4</option>
                                            <option value="4.1">NFSv4.1</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">è¶…æ—¶æ—¶é—´(ç§’)</label>
                                        <input type="number" id="nfs-timeout" class="form-control" placeholder="30" min="10" max="300" style="width: 100%;">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">æŒ‚è½½é€‰é¡¹</label>
                                    <input type="text" id="nfs-options" class="form-control" placeholder="rw,sync,hard,intr" style="width: 100%;">
                                    <small style="color: #666;">NFS æŒ‚è½½é€‰é¡¹ï¼Œå¤šä¸ªé€‰é¡¹ç”¨é€—å·åˆ†éš”</small>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label style="display: flex; align-items: center;">
                                            <input type="checkbox" id="nfs-auto-mount" style="margin-right: 8px;">
                                            è‡ªåŠ¨æŒ‚è½½
                                        </label>
                                        <small style="color: #666;">å¯åŠ¨æ—¶è‡ªåŠ¨æŒ‚è½½ NFS</small>
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">é‡è¯•æ¬¡æ•°</label>
                                        <input type="number" id="nfs-retry-count" class="form-control" placeholder="3" min="1" max="10" style="width: 100%;">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">å­˜å‚¨å­è·¯å¾„</label>
                                    <input type="text" id="nfs-sub-path" class="form-control" placeholder="filebox_storage" style="width: 100%;">
                                    <small style="color: #666;">åœ¨æŒ‚è½½ç‚¹ä¸‹åˆ›å»ºçš„å­˜å‚¨ç›®å½•</small>
                                </div>
                            </div>
                        </div>

                        <!-- S3 å­˜å‚¨å¡ç‰‡ -->
                        <div class="storage-card" id="s3-card" style="border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <div class="storage-icon" style="width: 40px; height: 40px; background: #ff9500; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <span style="color: white; font-size: 18px;">ğŸ“¦</span>
                                </div>
                                <div>
                                    <h4 style="margin: 0;">S3 å¯¹è±¡å­˜å‚¨</h4>
                                    <p style="margin: 0; color: #666; font-size: 14px;">æ–‡ä»¶å­˜å‚¨åœ¨ S3 å…¼å®¹çš„å¯¹è±¡å­˜å‚¨æœåŠ¡</p>
                                </div>
                            </div>
                            <div class="storage-status" id="s3-status">
                                <span class="status-badge" style="display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="storage-config" id="s3-config" style="margin-top: 15px; display: none;">
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ç«¯ç‚¹åœ°å€</label>
                                    <input type="text" id="s3-endpoint-url" class="form-control" placeholder="https://s3.amazonaws.com" style="width: 100%;">
                                    <small style="color: #666;">S3 æœåŠ¡çš„ç«¯ç‚¹åœ°å€ï¼ŒAWS S3 æˆ–å…¼å®¹æœåŠ¡</small>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">è®¿é—®å¯†é’¥</label>
                                        <input type="text" id="s3-access-key-id" class="form-control" placeholder="Access Key ID" style="width: 100%;">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å¯†é’¥</label>
                                        <input type="password" id="s3-secret-access-key" class="form-control" placeholder="Secret Access Key" style="width: 100%;">
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å­˜å‚¨æ¡¶åç§°</label>
                                        <input type="text" id="s3-bucket-name" class="form-control" placeholder="my-bucket" style="width: 100%;">
                                    </div>
                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">åŒºåŸŸ</label>
                                        <input type="text" id="s3-region-name" class="form-control" placeholder="us-east-1" style="width: 100%;">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">è‡ªå®šä¹‰åŸŸå (å¯é€‰)</label>
                                    <input type="text" id="s3-hostname" class="form-control" placeholder="cdn.example.com" style="width: 100%;">
                                    <small style="color: #666;">ç”¨äºæ–‡ä»¶è®¿é—®çš„è‡ªå®šä¹‰åŸŸåï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤åŸŸå</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="storage-actions" style="text-align: center; margin-bottom: 30px;">
                        <button class="btn" id="config-btn" onclick="toggleStorageConfig()" style="margin-right: 10px; display: none;">
                            <span id="config-btn-text">é…ç½®å­˜å‚¨</span>
                        </button>
                        <button class="btn btn-primary" id="save-config-btn" onclick="saveStorageConfig()" style="margin-right: 10px; display: none;">ä¿å­˜é…ç½®</button>
                        <button class="btn btn-success" id="test-btn" onclick="testStorageConnection()" style="margin-right: 10px; display: none;">æµ‹è¯•è¿æ¥</button>
                        <button class="btn btn-warning" id="switch-btn" onclick="confirmStorageSwitch()" style="display: none;">åˆ‡æ¢åˆ°æ­¤å­˜å‚¨</button>
                    </div>

                    <!-- å½“å‰çŠ¶æ€ä¿¡æ¯ -->
                    <div class="current-storage-info" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <h4 style="margin: 0 0 10px 0;">å½“å‰ä½¿ç”¨çš„å­˜å‚¨</h4>
                        <div id="current-storage-display" style="font-size: 18px; font-weight: bold;">
                            <span id="current-storage-name">åŠ è½½ä¸­...</span>
                            <span id="current-storage-status" style="margin-left: 10px; font-size: 14px; opacity: 0.9;"></span>
                        </div>
                    </div>

                    <!-- å­˜å‚¨åˆ‡æ¢ç¡®è®¤å¯¹è¯æ¡† -->
                    <div id="switch-confirm-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
                        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 400px; text-align: center;">
                            <h4 style="margin-bottom: 20px;">ç¡®è®¤åˆ‡æ¢å­˜å‚¨</h4>
                            <p id="switch-confirm-text" style="margin-bottom: 20px; color: #666;"></p>
                            <div>
                                <button class="btn btn-secondary" onclick="cancelStorageSwitch()" style="margin-right: 10px;">å–æ¶ˆ</button>
                                <button class="btn btn-primary" onclick="executeStorageSwitch()">ç¡®è®¤åˆ‡æ¢</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MCP æœåŠ¡å™¨ç®¡ç† -->
                <div id="mcp-tab" class="tab-content">
                    <h3>MCP æœåŠ¡å™¨ç®¡ç†</h3>
                    <p style="color: #666; margin-bottom: 30px;">Model Context Protocol (MCP) æœåŠ¡å™¨å…è®¸ AI å·¥å…·ä¸ FileCodeBox è¿›è¡Œé›†æˆ</p>
                    
                    <!-- æœåŠ¡å™¨çŠ¶æ€å¡ç‰‡ -->
                    <div class="mcp-status-card" style="background: white; border-radius: 10px; padding: 25px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center;">
                                <div class="mcp-status-icon" id="mcp-status-icon" style="width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 20px; font-size: 24px;">
                                    â³
                                </div>
                                <div>
                                    <h4 style="margin: 0; color: #333;" id="mcp-status-title">MCP æœåŠ¡å™¨çŠ¶æ€</h4>
                                    <p style="margin: 5px 0 0 0; color: #666;" id="mcp-status-desc">æ­£åœ¨æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...</p>
                                </div>
                            </div>
                            <div class="mcp-control-buttons" id="mcp-control-buttons">
                                <button class="btn" id="mcp-toggle-btn" onclick="toggleMCPServer()" disabled>å¯åŠ¨æœåŠ¡å™¨</button>
                                <button class="btn btn-secondary" id="mcp-restart-btn" onclick="restartMCPServer()" disabled>é‡å¯æœåŠ¡å™¨</button>
                            </div>
                        </div>
                    </div>

                    <!-- MCP é…ç½®é¢æ¿ -->
                    <div class="mcp-config-panel" style="background: white; border-radius: 10px; padding: 25px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">
                        <h4 style="margin-bottom: 20px; color: #667eea;">MCP æœåŠ¡å™¨é…ç½®</h4>
                        
                        <form id="mcp-config-form">
                            <div class="form-group">
                                <label style="display: flex; align-items: center; font-weight: bold;">
                                    <input type="checkbox" id="enable_mcp_server" style="margin-right: 10px;">
                                    å¯ç”¨ MCP æœåŠ¡å™¨
                                </label>
                                <small class="form-text">å¯ç”¨åï¼ŒAI å·¥å…·å¯ä»¥é€šè¿‡ MCP åè®®ä¸ FileCodeBox è¿›è¡Œäº¤äº’</small>
                            </div>
                            
                            <div class="mcp-config-details" id="mcp-config-details" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div class="form-group">
                                        <label>æœåŠ¡å™¨ç«¯å£</label>
                                        <input type="text" id="mcp_port" class="form-control" placeholder="8081">
                                        <small class="form-text">MCP æœåŠ¡å™¨ç›‘å¬çš„ç«¯å£å·</small>
                                    </div>
                                    <div class="form-group">
                                        <label>ç»‘å®šåœ°å€</label>
                                        <input type="text" id="mcp_host" class="form-control" placeholder="0.0.0.0">
                                        <small class="form-text">æœåŠ¡å™¨ç»‘å®šçš„IPåœ°å€ï¼Œ0.0.0.0è¡¨ç¤ºç»‘å®šæ‰€æœ‰ç½‘ç»œæ¥å£</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top: 25px;">
                                <button type="submit" class="btn" id="save-mcp-config-btn">ä¿å­˜é…ç½®</button>
                                <button type="button" class="btn btn-secondary" onclick="loadMCPConfig()">é‡ç½®</button>
                            </div>
                        </form>
                    </div>

                    <!-- MCP å·¥å…·å’Œèµ„æºä¿¡æ¯ -->
                    <div class="mcp-features" style="background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">
                        <h4 style="margin-bottom: 20px; color: #667eea;">MCP åŠŸèƒ½ç‰¹æ€§</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                            <!-- å·¥å…·åˆ—è¡¨ -->
                            <div>
                                <h5 style="color: #333; margin-bottom: 15px;">ğŸ”§ å¯ç”¨å·¥å…· (Tools)</h5>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>upload_file</strong> - ä¸Šä¼ æ–‡ä»¶
                                    </li>
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>download_file</strong> - ä¸‹è½½æ–‡ä»¶
                                    </li>
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>list_files</strong> - åˆ—å‡ºæ–‡ä»¶
                                    </li>
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>delete_file</strong> - åˆ é™¤æ–‡ä»¶
                                    </li>
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>search_files</strong> - æœç´¢æ–‡ä»¶
                                    </li>
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>get_file_info</strong> - è·å–æ–‡ä»¶ä¿¡æ¯
                                    </li>
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>set_file_permissions</strong> - è®¾ç½®æ–‡ä»¶æƒé™
                                    </li>
                                    <li style="padding: 8px 0;">
                                        <strong>get_system_stats</strong> - è·å–ç³»ç»Ÿç»Ÿè®¡
                                    </li>
                                </ul>
                            </div>
                            
                            <!-- èµ„æºåˆ—è¡¨ -->
                            <div>
                                <h5 style="color: #333; margin-bottom: 15px;">ğŸ“ å¯ç”¨èµ„æº (Resources)</h5>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>file://content</strong> - æ–‡ä»¶å†…å®¹
                                    </li>
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>file://list</strong> - æ–‡ä»¶åˆ—è¡¨
                                    </li>
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>file://info</strong> - æ–‡ä»¶ä¿¡æ¯
                                    </li>
                                    <li style="padding: 8px 0;">
                                        <strong>file://search</strong> - æœç´¢ç»“æœ
                                    </li>
                                </ul>
                                
                                <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #007bff;">
                                    <h6 style="margin: 0 0 10px 0; color: #0056b3;">è¿æ¥ä¿¡æ¯</h6>
                                    <p style="margin: 0; font-size: 14px; color: #004085;">
                                        å¯ç”¨ MCP æœåŠ¡å™¨åï¼ŒAI å·¥å…·å¯ä»¥é€šè¿‡ stdio è¿æ¥åˆ°ï¼š<br>
                                        <code style="background: #fff; padding: 2px 6px; border-radius: 3px;">localhost:<span id="mcp-port-display">8081</span></code>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç³»ç»Ÿé…ç½® -->
                <div id="config-tab" class="tab-content">
                    <div class="config-container" style="max-width: 1000px; margin: 0 auto;">
                        <!-- åŸºç¡€è®¾ç½® -->
                        <div class="config-section" style="background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                            <div class="section-header" style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f4ff;">
                                <div class="section-icon" style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <span style="color: white; font-size: 18px;">ğŸ </span>
                                </div>
                                <h3 style="margin: 0; color: #667eea;">åŸºç¡€è®¾ç½®</h3>
                            </div>
                            
                            <form id="config-form">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div class="form-group">
                                        <label>ç«™ç‚¹åç§°</label>
                                        <input type="text" class="form-control" name="name" style="border-radius: 8px;">
                                        <small class="form-text">æ˜¾ç¤ºåœ¨é¡µé¢æ ‡é¢˜å’Œå¤´éƒ¨çš„ç«™ç‚¹åç§°</small>
                                    </div>
                                    <div class="form-group">
                                        <label>æœåŠ¡å™¨ç»‘å®šåœ°å€</label>
                                        <input type="text" class="form-control" name="host" placeholder="0.0.0.0" style="border-radius: 8px;">
                                        <small class="form-text">0.0.0.0 å…è®¸å¤–éƒ¨è®¿é—®ï¼Œlocalhost ä»…æœ¬åœ°è®¿é—®</small>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>ç«™ç‚¹æè¿°</label>
                                    <input type="text" class="form-control" name="description" style="border-radius: 8px;">
                                    <small class="form-text">ç«™ç‚¹çš„ç®€è¦æè¿°ï¼Œæ˜¾ç¤ºåœ¨é¦–é¡µ</small>
                                </div>
                                
                                <div class="form-group">
                                    <label>ç®¡ç†å‘˜å¯†ç </label>
                                    <input type="password" class="form-control" name="admin_token" style="border-radius: 8px;">
                                    <small class="form-text">ç”¨äºç™»å½•ç®¡ç†åå°çš„å¯†ç </small>
                                </div>
                        </div>
                        
                        <!-- ä¸Šä¼ é™åˆ¶è®¾ç½® -->
                        <div class="config-section" style="background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                            <div class="section-header" style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f4ff;">
                                <div class="section-icon" style="width: 40px; height: 40px; background: linear-gradient(135deg, #ffeaa7, #fab1a0); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <span style="color: white; font-size: 18px;">ğŸ“¤</span>
                                </div>
                                <h3 style="margin: 0; color: #667eea;">ä¸Šä¼ é™åˆ¶è®¾ç½®</h3>
                            </div>
                            
                            <div class="upload-limits-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                                <!-- åŒ¿åç”¨æˆ·ä¸Šä¼ é™åˆ¶ -->
                                <div class="limit-card" style="border: 2px solid #e3f2fd; border-radius: 12px; padding: 20px; background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);">
                                    <div class="card-header" style="display: flex; align-items: center; margin-bottom: 15px;">
                                        <div class="card-icon" style="width: 32px; height: 32px; background: #42a5f5; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="color: white; font-size: 14px;">ğŸ‘¤</span>
                                        </div>
                                        <h4 style="margin: 0; color: #1976d2;">åŒ¿åç”¨æˆ·ä¸Šä¼ </h4>
                                    </div>
                                    
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label style="color: #1976d2; font-weight: bold;">å•æ–‡ä»¶å¤§å°é™åˆ¶ (MB)</label>
                                        <input type="number" class="form-control" name="upload_size" min="1" max="500" style="border-radius: 8px; border-color: #42a5f5;">
                                        <small class="form-text" style="color: #1565c0;">
                                            <strong>é€‚ç”¨èŒƒå›´ï¼š</strong>æœªç™»å½•çš„æ¸¸å®¢ç”¨æˆ·<br>
                                            <strong>å»ºè®®å€¼ï¼š</strong>5-20MBï¼Œé¿å…ç³»ç»Ÿèµ„æºæ»¥ç”¨
                                        </small>
                                    </div>
                                    
                                    <div class="usage-note" style="margin-top: 15px; padding: 12px; background: #e1f5fe; border-radius: 8px; border-left: 4px solid #03a9f4;">
                                        <div style="font-size: 12px; color: #0277bd;">
                                            <strong>ä½¿ç”¨åœºæ™¯ï¼š</strong><br>
                                            â€¢ ä¸´æ—¶æ–‡ä»¶åˆ†äº«<br>
                                            â€¢ å°æ–‡ä»¶å¿«é€Ÿä¼ è¾“<br>
                                            â€¢ é˜²æ­¢æ¶æ„å¤§æ–‡ä»¶å ç”¨èµ„æº
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- æ³¨å†Œç”¨æˆ·ä¸Šä¼ é™åˆ¶ -->
                                <div class="limit-card" style="border: 2px solid #e8f5e8; border-radius: 12px; padding: 20px; background: linear-gradient(135deg, #f9fff9 0%, #f0fff0 100%);">
                                    <div class="card-header" style="display: flex; align-items: center; margin-bottom: 15px;">
                                        <div class="card-icon" style="width: 32px; height: 32px; background: #66bb6a; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                                            <span style="color: white; font-size: 14px;">ğŸ‘¥</span>
                                        </div>
                                        <h4 style="margin: 0; color: #388e3c;">æ³¨å†Œç”¨æˆ·ä¸Šä¼ </h4>
                                    </div>
                                    
                                    <div class="form-group" style="margin-bottom: 0;">
                                        <label style="color: #388e3c; font-weight: bold;">å•æ–‡ä»¶å¤§å°é™åˆ¶ (MB)</label>
                                        <input type="number" class="form-control" name="user_upload_size" min="1" max="2000" style="border-radius: 8px; border-color: #66bb6a;">
                                        <small class="form-text" style="color: #2e7d32;">
                                            <strong>é€‚ç”¨èŒƒå›´ï¼š</strong>å·²ç™»å½•çš„æ³¨å†Œç”¨æˆ·<br>
                                            <strong>å»ºè®®å€¼ï¼š</strong>50-500MBï¼Œä¸ºç”¨æˆ·æä¾›æ›´å¥½ä½“éªŒ
                                        </small>
                                    </div>
                                    
                                    <div class="usage-note" style="margin-top: 15px; padding: 12px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #4caf50;">
                                        <div style="font-size: 12px; color: #2e7d32;">
                                            <strong>ä½¿ç”¨åœºæ™¯ï¼š</strong><br>
                                            â€¢ å¤§æ–‡ä»¶èµ„æºåˆ†äº«<br>
                                            â€¢ é•¿æœŸæ–‡ä»¶å­˜å‚¨<br>
                                            â€¢ æ³¨å†Œç”¨æˆ·æƒç›Šä½“ç°
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ä¸Šä¼ é…ç½®è¯´æ˜ -->
                            <div class="config-tips" style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #fff3e0 0%, #ffeaa7 100%); border-radius: 12px; border-left: 6px solid #ff9500;">
                                <h5 style="margin: 0 0 12px 0; color: #e65100; display: flex; align-items: center;">
                                    <span style="margin-right: 8px;">ğŸ’¡</span>
                                    é…ç½®å»ºè®®
                                </h5>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; font-size: 14px; color: #bf360c;">
                                    <div>
                                        <strong>ä¿å®ˆé…ç½®ï¼š</strong><br>
                                        åŒ¿åç”¨æˆ·ï¼š5MB<br>
                                        æ³¨å†Œç”¨æˆ·ï¼š20MB
                                    </div>
                                    <div>
                                        <strong>æ ‡å‡†é…ç½®ï¼š</strong><br>
                                        åŒ¿åç”¨æˆ·ï¼š10MB<br>
                                        æ³¨å†Œç”¨æˆ·ï¼š50MB
                                    </div>
                                    <div>
                                        <strong>å®½æ¾é…ç½®ï¼š</strong><br>
                                        åŒ¿åç”¨æˆ·ï¼š20MB<br>
                                        æ³¨å†Œç”¨æˆ·ï¼š100MB
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ€§èƒ½è®¾ç½® -->
                        <div class="config-section" style="background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                            <div class="section-header" style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f4ff;">
                                <div class="section-icon" style="width: 40px; height: 40px; background: linear-gradient(135deg, #74b9ff, #0984e3); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <span style="color: white; font-size: 18px;">âš¡</span>
                                </div>
                                <h3 style="margin: 0; color: #667eea;">æ€§èƒ½è®¾ç½®</h3>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                <div class="form-group">
                                    <label>åˆ†å—ä¸Šä¼ å¤§å° (MB)</label>
                                    <input type="number" class="form-control" name="chunk_size" min="1" max="100" style="border-radius: 8px;">
                                    <small class="form-text">å•ä¸ªåˆ†å—çš„å¤§å°ï¼Œå½±å“å¤§æ–‡ä»¶ä¸Šä¼ æ€§èƒ½</small>
                                </div>
                                
                                <div class="form-group">
                                    <label>æœ€å¤§å¹¶å‘ä¸‹è½½æ•°</label>
                                    <input type="number" class="form-control" name="max_concurrent_downloads" min="1" max="50" style="border-radius: 8px;">
                                    <small class="form-text">åŒæ—¶å…è®¸çš„æœ€å¤§ä¸‹è½½è¿æ¥æ•°</small>
                                </div>
                                
                                <div class="form-group">
                                    <label>ä¸‹è½½è¶…æ—¶æ—¶é—´ (ç§’)</label>
                                    <input type="number" class="form-control" name="download_timeout" min="60" max="3600" style="border-radius: 8px;">
                                    <small class="form-text">å•ä¸ªä¸‹è½½ä»»åŠ¡çš„è¶…æ—¶æ—¶é—´</small>
                                </div>
                                
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; font-weight: bold;">
                                        <input type="checkbox" name="enable_concurrent_download" style="margin-right: 10px; transform: scale(1.2);"> 
                                        å¯ç”¨å¹¶å‘ä¸‹è½½
                                    </label>
                                    <small class="form-text">å…è®¸åŒæ—¶è¿›è¡Œå¤šä¸ªä¸‹è½½ä»»åŠ¡</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ç”¨æˆ·ç³»ç»Ÿè®¾ç½® -->
                        <div class="config-section" style="background: white; border-radius: 12px; padding: 25px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                            <div class="section-header" style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f4ff;">
                                <div class="section-icon" style="width: 40px; height: 40px; background: linear-gradient(135deg, #a29bfe, #6c5ce7); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <span style="color: white; font-size: 18px;">ğŸ‘¥</span>
                                </div>
                                <h3 style="margin: 0; color: #667eea;">ç”¨æˆ·ç³»ç»Ÿè®¾ç½®</h3>
                            </div>
                            
                            <div class="user-system-toggle" style="margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px solid #e9ecef;">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="display: flex; align-items: center; font-weight: bold; font-size: 16px;">
                                        <input type="checkbox" name="enable_user_system" id="enable_user_system" style="margin-right: 12px; transform: scale(1.3);"> 
                                        å¯ç”¨ç”¨æˆ·ç³»ç»Ÿ
                                    </label>
                                    <small class="form-text" style="margin-top: 8px;">å¯ç”¨åç”¨æˆ·å¯ä»¥æ³¨å†Œè´¦å·å¹¶ç®¡ç†è‡ªå·±çš„æ–‡ä»¶</small>
                                </div>
                            </div>
                            
                            <div id="user-system-options" style="display: none;">
                                <div class="user-options-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px;">
                                    <div class="form-group">
                                        <label style="display: flex; align-items: center; font-weight: bold;">
                                            <input type="checkbox" name="allow_user_registration" id="allow_user_registration" style="margin-right: 10px; transform: scale(1.2);"> 
                                            å…è®¸ç”¨æˆ·æ³¨å†Œ
                                        </label>
                                        <small class="form-text">å…è®¸æ–°ç”¨æˆ·è‡ªä¸»æ³¨å†Œè´¦å·</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label style="display: flex; align-items: center; font-weight: bold;">
                                            <input type="checkbox" name="require_email_verify" style="margin-right: 10px; transform: scale(1.2);"> 
                                            éœ€è¦é‚®ç®±éªŒè¯
                                        </label>
                                        <small class="form-text">æ–°ç”¨æˆ·æ³¨å†Œåéœ€è¦éªŒè¯é‚®ç®±æ‰èƒ½ä½¿ç”¨</small>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                                    <div class="form-group">
                                        <label>ç”¨æˆ·å­˜å‚¨é…é¢ (MB)</label>
                                        <input type="number" class="form-control" name="user_storage_quota" min="0" style="border-radius: 8px;">
                                        <small class="form-text">æ¯ä¸ªç”¨æˆ·çš„æ€»å­˜å‚¨ç©ºé—´é™åˆ¶ï¼Œ0 è¡¨ç¤ºæ— é™åˆ¶</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>ä¼šè¯è¿‡æœŸæ—¶é—´ (å°æ—¶)</label>
                                        <input type="number" class="form-control" name="session_expiry_hours" min="1" max="720" style="border-radius: 8px;">
                                        <small class="form-text">ç”¨æˆ·ç™»å½•ä¼šè¯çš„æœ‰æ•ˆæœŸ</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>å•ç”¨æˆ·æœ€å¤§ä¼šè¯æ•°</label>
                                        <input type="number" class="form-control" name="max_sessions_per_user" min="1" max="10" style="border-radius: 8px;">
                                        <small class="form-text">æ¯ä¸ªç”¨æˆ·åŒæ—¶å…è®¸çš„æœ€å¤§ç™»å½•ä¼šè¯æ•°</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ä¿å­˜æŒ‰é’® -->
                        <div class="save-section" style="text-align: center; margin: 30px 0;">
                            <button type="submit" class="btn" style="
                                padding: 15px 40px;
                                font-size: 16px;
                                font-weight: bold;
                                border-radius: 10px;
                                background: linear-gradient(135deg, #667eea, #764ba2);
                                border: none;
                                color: white;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'">
                                ğŸ’¾ ä¿å­˜æ‰€æœ‰é…ç½®
                            </button>
                        </div>
                    </form>
                </div>
                </div>

                <!-- ç³»ç»Ÿç»´æŠ¤ -->
                <div id="maintenance-tab" class="tab-content">
                    <div class="maintenance-container" style="max-width: 1200px; margin: 0 auto;">
                        <!-- é¡µé¢æ ‡é¢˜ -->
                        <div class="maintenance-header" style="text-align: center; margin-bottom: 40px; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white;">
                            <div style="font-size: 48px; margin-bottom: 15px;">ğŸ› ï¸</div>
                            <h2 style="margin: 0 0 10px 0; font-size: 28px; font-weight: bold;">ç³»ç»Ÿç»´æŠ¤ä¸­å¿ƒ</h2>
                            <p style="margin: 0; font-size: 16px; opacity: 0.9;">ç®¡ç†å’Œä¼˜åŒ–æ‚¨çš„ FileCodeBox ç³»ç»Ÿ</p>
                        </div>

                        <!-- ç»´æŠ¤åŠŸèƒ½å¡ç‰‡ç½‘æ ¼ -->
                        <div class="maintenance-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; margin-bottom: 40px;">
                            
                            <!-- æ¸…ç†ç®¡ç†å¡ç‰‡ -->
                            <div class="maintenance-card" style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); border: 2px solid #f0f4ff; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 12px 35px rgba(102, 126, 234, 0.15)'; this.style.borderColor='#667eea'" onmouseout="this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.1)'; this.style.borderColor='#f0f4ff'">
                                <div class="card-header" style="display: flex; align-items: center; margin-bottom: 20px;">
                                    <div class="card-icon" style="width: 50px; height: 50px; background: linear-gradient(135deg, #ff6b6b, #ee5a24); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                        <span style="color: white; font-size: 24px;">ğŸ—‘ï¸</span>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0; color: #333; font-size: 18px;">æ¸…ç†ç®¡ç†</h4>
                                        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">æ¸…ç†è¿‡æœŸå’Œæ— æ•ˆæ•°æ®</p>
                                    </div>
                                </div>
                                
                                <div class="action-buttons" style="display: flex; flex-direction: column; gap: 12px;">
                                    <button class="maintenance-btn primary" onclick="cleanExpiredFiles()" style="
                                        width: 100%;
                                        padding: 12px 20px;
                                        background: linear-gradient(135deg, #ff6b6b, #ee5a24);
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        font-size: 14px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        æ¸…ç†è¿‡æœŸæ–‡ä»¶
                                    </button>
                                    <button class="maintenance-btn secondary" onclick="cleanTempFiles()" style="
                                        width: 100%;
                                        padding: 12px 20px;
                                        background: linear-gradient(135deg, #ffa726, #fb8c00);
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        font-size: 14px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                                    </button>
                                    <button class="maintenance-btn warning" onclick="cleanInvalidRecords()" style="
                                        width: 100%;
                                        padding: 12px 20px;
                                        background: linear-gradient(135deg, #ffd54f, #ffc107);
                                        color: #333;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        font-size: 14px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        æ¸…ç†æ— æ•ˆè®°å½•
                                    </button>
                                </div>
                            </div>

                            <!-- æ•°æ®åº“ç»´æŠ¤å¡ç‰‡ -->
                            <div class="maintenance-card" style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); border: 2px solid #f0f4ff; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 12px 35px rgba(102, 126, 234, 0.15)'; this.style.borderColor='#667eea'" onmouseout="this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.1)'; this.style.borderColor='#f0f4ff'">
                                <div class="card-header" style="display: flex; align-items: center; margin-bottom: 20px;">
                                    <div class="card-icon" style="width: 50px; height: 50px; background: linear-gradient(135deg, #42a5f5, #1976d2); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                        <span style="color: white; font-size: 24px;">ğŸ’¾</span>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0; color: #333; font-size: 18px;">æ•°æ®åº“ç»´æŠ¤</h4>
                                        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">ä¼˜åŒ–æ•°æ®åº“æ€§èƒ½</p>
                                    </div>
                                </div>
                                
                                <div class="action-buttons" style="display: flex; flex-direction: column; gap: 12px;">
                                    <button class="maintenance-btn primary" onclick="optimizeDatabase()" style="
                                        width: 100%;
                                        padding: 12px 20px;
                                        background: linear-gradient(135deg, #42a5f5, #1976d2);
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        font-size: 14px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        ä¼˜åŒ–æ•°æ®åº“
                                    </button>
                                    <button class="maintenance-btn secondary" onclick="analyzeDatabase()" style="
                                        width: 100%;
                                        padding: 12px 20px;
                                        background: linear-gradient(135deg, #66bb6a, #4caf50);
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        font-size: 14px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        æ•°æ®åº“åˆ†æ
                                    </button>
                                    <button class="maintenance-btn info" onclick="backupDatabase()" style="
                                        width: 100%;
                                        padding: 12px 20px;
                                        background: linear-gradient(135deg, #26c6da, #00acc1);
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        font-size: 14px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        æ•°æ®åº“å¤‡ä»½
                                    </button>
                                </div>
                            </div>

                            <!-- ç¼“å­˜ç®¡ç†å¡ç‰‡ -->
                            <div class="maintenance-card" style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); border: 2px solid #f0f4ff; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 12px 35px rgba(102, 126, 234, 0.15)'; this.style.borderColor='#667eea'" onmouseout="this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.1)'; this.style.borderColor='#f0f4ff'">
                                <div class="card-header" style="display: flex; align-items: center; margin-bottom: 20px;">
                                    <div class="card-icon" style="width: 50px; height: 50px; background: linear-gradient(135deg, #ab47bc, #8e24aa); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                        <span style="color: white; font-size: 24px;">âš¡</span>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0; color: #333; font-size: 18px;">ç¼“å­˜ç®¡ç†</h4>
                                        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">ç®¡ç†ç³»ç»Ÿç¼“å­˜</p>
                                    </div>
                                </div>
                                
                                <div class="action-buttons" style="display: flex; flex-direction: column; gap: 12px;">
                                    <button class="maintenance-btn primary" onclick="clearCache()" style="
                                        width: 100%;
                                        padding: 12px 20px;
                                        background: linear-gradient(135deg, #ab47bc, #8e24aa);
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        font-size: 14px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
                                    </button>
                                    <button class="maintenance-btn secondary" onclick="refreshCache()" style="
                                        width: 100%;
                                        padding: 12px 20px;
                                        background: linear-gradient(135deg, #7e57c2, #673ab7);
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        font-size: 14px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        é‡å»ºç¼“å­˜
                                    </button>
                                    <button class="maintenance-btn info" onclick="showCacheStats()" style="
                                        width: 100%;
                                        padding: 12px 20px;
                                        background: linear-gradient(135deg, #5c6bc0, #3f51b5);
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        font-size: 14px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        ç¼“å­˜ç»Ÿè®¡
                                    </button>
                                </div>
                            </div>

                            <!-- ç³»ç»Ÿç›‘æ§å¡ç‰‡ -->
                            <div class="maintenance-card" style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); border: 2px solid #f0f4ff; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 12px 35px rgba(102, 126, 234, 0.15)'; this.style.borderColor='#667eea'" onmouseout="this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.1)'; this.style.borderColor='#f0f4ff'">
                                <div class="card-header" style="display: flex; align-items: center; margin-bottom: 20px;">
                                    <div class="card-icon" style="width: 50px; height: 50px; background: linear-gradient(135deg, #4caf50, #388e3c); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                        <span style="color: white; font-size: 24px;">ğŸ“Š</span>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0; color: #333; font-size: 18px;">ç³»ç»Ÿç›‘æ§</h4>
                                        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€</p>
                                    </div>
                                </div>
                                
                                <div class="action-buttons" style="display: flex; flex-direction: column; gap: 12px;">
                                    <button class="maintenance-btn primary" onclick="showSystemStatus()" style="
                                        width: 100%;
                                        padding: 12px 20px;
                                        background: linear-gradient(135deg, #4caf50, #388e3c);
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        font-size: 14px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        ç³»ç»ŸçŠ¶æ€
                                    </button>
                                    <button class="maintenance-btn secondary" onclick="showPerformanceMetrics()" style="
                                        width: 100%;
                                        padding: 12px 20px;
                                        background: linear-gradient(135deg, #8bc34a, #689f38);
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        font-size: 14px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        æ€§èƒ½æŒ‡æ ‡
                                    </button>
                                    <button class="maintenance-btn info" onclick="generateSystemReport()" style="
                                        width: 100%;
                                        padding: 12px 20px;
                                        background: linear-gradient(135deg, #cddc39, #afb42b);
                                        color: #333;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        font-size: 14px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        ç”ŸæˆæŠ¥å‘Š
                                    </button>
                                </div>
                            </div>

                            <!-- å®‰å…¨ç®¡ç†å¡ç‰‡ -->
                            <div class="maintenance-card" style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); border: 2px solid #f0f4ff; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 12px 35px rgba(102, 126, 234, 0.15)'; this.style.borderColor='#667eea'" onmouseout="this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.1)'; this.style.borderColor='#f0f4ff'">
                                <div class="card-header" style="display: flex; align-items: center; margin-bottom: 20px;">
                                    <div class="card-icon" style="width: 50px; height: 50px; background: linear-gradient(135deg, #ff9800, #f57c00); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                        <span style="color: white; font-size: 24px;">ğŸ”’</span>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0; color: #333; font-size: 18px;">å®‰å…¨ç®¡ç†</h4>
                                        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">ç³»ç»Ÿå®‰å…¨æ£€æŸ¥ä¸ç®¡ç†</p>
                                    </div>
                                </div>
                                
                                <div class="action-buttons" style="display: flex; flex-direction: column; gap: 12px;">
                                    <button class="maintenance-btn primary" onclick="securityScan()" style="
                                        width: 100%;
                                        padding: 12px 20px;
                                        background: linear-gradient(135deg, #ff9800, #f57c00);
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        font-size: 14px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        å®‰å…¨æ‰«æ
                                    </button>
                                    <button class="maintenance-btn secondary" onclick="showAccessLogs()" style="
                                        width: 100%;
                                        padding: 12px 20px;
                                        background: linear-gradient(135duo, #ff7043, #d84315);
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        font-size: 14px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        è®¿é—®æ—¥å¿—
                                    </button>
                                    <button class="maintenance-btn warning" onclick="clearSessions()" style="
                                        width: 100%;
                                        padding: 12px 20px;
                                        background: linear-gradient(135deg, #ffc107, #ff8f00);
                                        color: #333;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        font-size: 14px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        æ¸…ç†ä¼šè¯
                                    </button>
                                </div>
                            </div>

                            <!-- æ—¥å¿—ç®¡ç†å¡ç‰‡ -->
                            <div class="maintenance-card" style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); border: 2px solid #f0f4ff; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 12px 35px rgba(102, 126, 234, 0.15)'; this.style.borderColor='#667eea'" onmouseout="this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.1)'; this.style.borderColor='#f0f4ff'">
                                <div class="card-header" style="display: flex; align-items: center; margin-bottom: 20px;">
                                    <div class="card-icon" style="width: 50px; height: 50px; background: linear-gradient(135deg, #9c27b0, #7b1fa2); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                        <span style="color: white; font-size: 24px;">ğŸ“</span>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0; color: #333; font-size: 18px;">æ—¥å¿—ç®¡ç†</h4>
                                        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">ç®¡ç†ç³»ç»Ÿæ—¥å¿—æ–‡ä»¶</p>
                                    </div>
                                </div>
                                
                                <div class="action-buttons" style="display: flex; flex-direction: column; gap: 12px;">
                                    <button class="maintenance-btn primary" onclick="downloadLogs()" style="
                                        width: 100%;
                                        padding: 12px 20px;
                                        background: linear-gradient(135deg, #9c27b0, #7b1fa2);
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        font-size: 14px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        ä¸‹è½½æ—¥å¿—
                                    </button>
                                    <button class="maintenance-btn secondary" onclick="clearOldLogs()" style="
                                        width: 100%;
                                        padding: 12px 20px;
                                        background: linear-gradient(135deg, #e91e63, #c2185b);
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        font-size: 14px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        æ¸…ç†æ—§æ—¥å¿—
                                    </button>
                                    <button class="maintenance-btn info" onclick="showLogAnalysis()" style="
                                        width: 100%;
                                        padding: 12px 20px;
                                        background: linear-gradient(135deg, #673ab7, #512da8);
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        font-size: 14px;
                                    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        æ—¥å¿—åˆ†æ
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- ç»´æŠ¤ç»“æœå±•ç¤ºåŒº -->
                        <div class="maintenance-result-container" style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); border: 2px solid #f0f4ff;">
                            <div class="result-header" style="display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f4ff;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #26c6da, #00acc1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <span style="color: white; font-size: 18px;">ğŸ“‹</span>
                                </div>
                                <h3 style="margin: 0; color: #333;">æ“ä½œç»“æœ</h3>
                            </div>
                            <div id="maintenance-result" style="min-height: 100px; display: flex; align-items: center; justify-content: center; color: #666; font-style: italic;">
                                ç­‰å¾…æ“ä½œæ‰§è¡Œ...
                            </div>
                        </div>

                        <!-- å¿«é€Ÿæ“ä½œå·¥å…·æ  -->
                        <div class="quick-actions" style="margin-top: 30px; text-align: center; padding: 25px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; border: 2px solid #dee2e6;">
                            <h4 style="margin: 0 0 20px 0; color: #495057;">ğŸš€ å¿«é€Ÿæ“ä½œ</h4>
                            <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                                <button onclick="quickCleanAll()" style="
                                    padding: 12px 24px;
                                    background: linear-gradient(135deg, #dc3545, #c82333);
                                    color: white;
                                    border: none;
                                    border-radius: 25px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(220, 53, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(220, 53, 69, 0.3)'">
                                    ä¸€é”®å…¨é¢æ¸…ç†
                                </button>
                                <button onclick="quickOptimize()" style="
                                    padding: 12px 24px;
                                    background: linear-gradient(135deg, #28a745, #20c997);
                                    color: white;
                                    border: none;
                                    border-radius: 25px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(40, 167, 69, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(40, 167, 69, 0.3)'">
                                    ä¸€é”®ä¼˜åŒ–ç³»ç»Ÿ
                                </button>
                                <button onclick="systemHealthCheck()" style="
                                    padding: 12px 24px;
                                    background: linear-gradient(135deg, #007bff, #0056b3);
                                    color: white;
                                    border: none;
                                    border-radius: 25px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 123, 255, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 123, 255, 0.3)'">
                                    ç³»ç»Ÿå¥åº·æ£€æŸ¥
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘æ–‡ä»¶æ¨¡æ€æ¡† -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>ç¼–è¾‘æ–‡ä»¶ä¿¡æ¯</h3>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label>æå–ç </label>
                    <input type="text" class="form-control" id="edit-code">
                </div>
                <div class="form-group">
                    <label>æ–‡ä»¶å</label>
                    <input type="text" class="form-control" id="edit-prefix">
                </div>
                <div class="form-group">
                    <label>æ–‡ä»¶æ‰©å±•å</label>
                    <input type="text" class="form-control" id="edit-suffix">
                </div>
                <div class="form-group">
                    <label>è¿‡æœŸæ—¶é—´</label>
                    <input type="datetime-local" class="form-control" id="edit-expired-at">
                </div>
                <div class="form-group">
                    <label>ä½¿ç”¨æ¬¡æ•°é™åˆ¶</label>
                    <input type="number" class="form-control" id="edit-expired-count">
                </div>
                <button type="submit" class="btn">ä¿å­˜æ›´æ”¹</button>
                <button type="button" class="btn btn-danger" onclick="closeModal()">å–æ¶ˆ</button>
            </form>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentPage = 1;
        let currentSearch = '';
        let authToken = localStorage.getItem('user_token'); // ä½¿ç”¨ç”¨æˆ·token

        // è·å–ç”¨æˆ·ä¿¡æ¯
        function getUserInfo() {
            const userInfoStr = localStorage.getItem('user_info');
            return userInfoStr ? JSON.parse(userInfoStr) : null;
        }

        // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
        function checkAdminPermission() {
            const userInfo = getUserInfo();
            return userInfo && userInfo.role === 'admin';
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type = 'info') {
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„æç¤ºæ¡†
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 9999;
                max-width: 400px;
                word-wrap: break-word;
            `;
            
            // æ ¹æ®ç±»å‹è®¾ç½®èƒŒæ™¯è‰²
            switch(type) {
                case 'success':
                    alertDiv.style.backgroundColor = '#28a745';
                    break;
                case 'error':
                    alertDiv.style.backgroundColor = '#dc3545';
                    break;
                case 'warning':
                    alertDiv.style.backgroundColor = '#ffc107';
                    alertDiv.style.color = '#212529';
                    break;
                default:
                    alertDiv.style.backgroundColor = '#17a2b8';
            }
            
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€å’Œç®¡ç†å‘˜æƒé™
            if (!authToken || !checkAdminPermission()) {
                showUnauthorizedPage();
                return;
            }
            
            showAdminPage();
            
            // æ·»åŠ å­˜å‚¨ç±»å‹é€‰æ‹©å™¨çš„å˜åŒ–ç›‘å¬å™¨
            const storageSelect = document.getElementById('storage-type-select');
            if (storageSelect) {
                storageSelect.addEventListener('change', function() {
                    const selectedType = this.value;
                    showStorageConfig(selectedType);
                });
            }
            
            // ç”¨æˆ·ç³»ç»Ÿå§‹ç»ˆå¯ç”¨ï¼Œæ— éœ€ç›‘å¬å¼€å…³
        });

        // æ˜¾ç¤ºæœªæˆæƒé¡µé¢
        function showUnauthorizedPage() {
            document.getElementById('unauthorized-page').style.display = 'block';
            document.getElementById('admin-page').style.display = 'none';
        }

        // æ˜¾ç¤ºç®¡ç†é¡µé¢
        function showAdminPage() {
            document.getElementById('unauthorized-page').style.display = 'none';
            document.getElementById('admin-page').style.display = 'block';
            loadStats();
            loadFiles();
            loadConfig();
        }

        // é€€å‡ºç™»å½•
        function logout() {
            // æ¸…é™¤ç”¨æˆ·ç™»å½•ä¿¡æ¯
            localStorage.removeItem('user_token');
            localStorage.removeItem('user_info');
            
            // è·³è½¬åˆ°ç™»å½•é¡µé¢
            window.location.href = '/user/login';
        }

        // APIè¯·æ±‚å°è£…
        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken
                }
            };
            
            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };
            
            const response = await fetch(url, finalOptions);
            
            if (response.status === 401) {
                logout();
                throw new Error('è®¤è¯å¤±è´¥');
            }
            
            return response.json();
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const result = await apiRequest('/admin/dashboard');
                
                if (result.code === 200) {
                    const stats = result.data;
                    const statsHtml = `
                        <div class="stat-card">
                            <div class="stat-number">${stats.total_files || 0}</div>
                            <div class="stat-label">æ€»æ–‡ä»¶æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.today_uploads || 0}</div>
                            <div class="stat-label">ä»Šæ—¥ä¸Šä¼ </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.active_files || 0}</div>
                            <div class="stat-label">æ´»è·ƒæ–‡ä»¶</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${formatFileSize(stats.total_size || 0)}</div>
                            <div class="stat-label">æ€»å­˜å‚¨å¤§å°</div>
                        </div>
                    `;
                    document.getElementById('stats-grid').innerHTML = statsHtml;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }

        // åŠ è½½æ–‡ä»¶åˆ—è¡¨
        async function loadFiles(page = 1) {
            currentPage = page;
            
            try {
                const result = await apiRequest(`/admin/files?page=${page}&page_size=20&search=${currentSearch}`);
                
                if (result.code === 200) {
                    const data = result.data;
                    const files = data.list || []; // ä¿®å¤ï¼šä½¿ç”¨ list è€Œä¸æ˜¯ files
                    
                    let tableHtml = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>æå–ç </th>
                                    <th>æ–‡ä»¶å</th>
                                    <th>å¤§å°</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>è¿‡æœŸæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    files.forEach(file => {
                        tableHtml += `
                            <tr>
                                <td>${file.ID}</td>
                                <td>${file.code}</td>
                                <td>${file.prefix}${file.suffix}</td>
                                <td>${formatFileSize(file.size)}</td>
                                <td>${formatDateTime(file.CreatedAt)}</td>
                                <td>${formatDateTime(file.expired_at)}</td>
                                <td>
                                    <button class="btn" onclick="editFile('${file.code}')">ç¼–è¾‘</button>
                                    <button class="btn btn-danger" onclick="deleteFile('${file.code}')">åˆ é™¤</button>
                                    ${file.text ? '' : `<button class="btn btn-success" onclick="downloadFile('${file.code}')">ä¸‹è½½</button>`}
                                </td>
                            </tr>
                        `;
                    });
                    
                    tableHtml += '</tbody></table>';
                    
                    document.getElementById('files-content').innerHTML = tableHtml;
                    
                    // ç”Ÿæˆåˆ†é¡µ
                    generatePagination(data.total, data.page, data.page_size);
                }
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('files-content').innerHTML = '<div class="alert alert-danger">åŠ è½½å¤±è´¥</div>';
            }
        }

        // ç”Ÿæˆåˆ†é¡µ
        function generatePagination(total, currentPage, pageSize) {
            const totalPages = Math.ceil(total / pageSize);
            let paginationHtml = '';
            
            if (totalPages > 1) {
                paginationHtml += `<button class="btn" onclick="loadFiles(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
                paginationHtml += `<span>ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ</span>`;
                paginationHtml += `<button class="btn" onclick="loadFiles(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
            }
            
            document.getElementById('pagination').innerHTML = paginationHtml;
        }

        // æœç´¢æ–‡ä»¶
        function searchFiles() {
            currentSearch = document.getElementById('search-input').value;
            loadFiles(1);
        }

        // åˆ é™¤æ–‡ä»¶
        async function deleteFile(code) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const result = await apiRequest(`/admin/files/${code}`, {
                    method: 'DELETE'
                });
                
                if (result.code === 200) {
                    alert('åˆ é™¤æˆåŠŸ');
                    loadFiles(currentPage);
                    loadStats();
                } else {
                    alert(result.message || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // å®‰å…¨çš„æ—¶é—´æ ¼å¼åŒ–å‡½æ•°
        function formatDateTimeLocal(dateString) {
            try {
                if (!dateString) return '';
                
                // å¤„ç†ä¸åŒçš„æ—¶é—´æ ¼å¼
                let date;
                if (dateString.includes('+') || dateString.includes('Z')) {
                    // å¸¦æ—¶åŒºçš„ISOå­—ç¬¦ä¸²
                    date = new Date(dateString);
                } else {
                    // ç®€å•çš„æ—¥æœŸå­—ç¬¦ä¸²
                    date = new Date(dateString + 'Z'); // æ·»åŠ Zè¡¨ç¤ºUTCæ—¶é—´
                }
                
                if (isNaN(date.getTime())) {
                    console.warn('Invalid date format:', dateString);
                    return '';
                }
                
                // è½¬æ¢ä¸ºæœ¬åœ°æ—¶é—´çš„datetime-localæ ¼å¼ (YYYY-MM-DDTHH:mm)
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            } catch (error) {
                console.warn('Error formatting date:', dateString, error);
                return '';
            }
        }

        // ç¼–è¾‘æ–‡ä»¶
        async function editFile(code) {
            try {
                const response = await fetch(`/admin/files/${code}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const file = result.data; // è§£ædataå­—æ®µ
                    
                    // æ˜¾ç¤ºç¼–è¾‘è¡¨å•
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                    `;
                    
                    modal.innerHTML = `
                        <div class="modal-content" style="
                            background: white;
                            padding: 20px;
                            border-radius: 8px;
                            width: 90%;
                            max-width: 500px;
                            max-height: 80vh;
                            overflow-y: auto;
                        ">
                            <h3>ç¼–è¾‘æ–‡ä»¶</h3>
                            <form id="editForm">
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px;">æ–‡ä»¶ä»£ç :</label>
                                    <input type="text" id="fileCode" value="${file.code}" required style="
                                        width: 100%;
                                        padding: 8px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        box-sizing: border-box;
                                    ">
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px;">è¿‡æœŸæ—¶é—´:</label>
                                    <input type="datetime-local" id="expiredAt" value="${formatDateTimeLocal(file.expired_at)}" style="
                                        width: 100%;
                                        padding: 8px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        box-sizing: border-box;
                                    ">
                                </div>
                                
                                ${file.text ? `
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px;">æ–‡æœ¬å†…å®¹:</label>
                                        <textarea id="textContent" rows="10" style="
                                            width: 100%;
                                            padding: 8px;
                                            border: 1px solid #ddd;
                                            border-radius: 4px;
                                            box-sizing: border-box;
                                            resize: vertical;
                                        ">${file.text}</textarea>
                                    </div>
                                ` : ''}
                                
                                <div style="text-align: right;">
                                    <button type="button" class="btn btn-danger" onclick="this.closest('.modal').remove()" style="margin-right: 10px;">å–æ¶ˆ</button>
                                    <button type="submit" class="btn">ä¿å­˜</button>
                                </div>
                            </form>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // å¤„ç†è¡¨å•æäº¤
                    document.getElementById('editForm').onsubmit = async (e) => {
                        e.preventDefault();
                        
                        const updateData = {
                            code: document.getElementById('fileCode').value,
                            expired_at: document.getElementById('expiredAt').value
                        };
                        
                        if (file.text) {
                            updateData.text = document.getElementById('textContent').value;
                        }
                        
                        const updateResponse = await fetch(`/admin/files/${id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: JSON.stringify(updateData)
                        });
                        
                        if (updateResponse.ok) {
                            modal.remove();
                            loadFiles(); // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
                            alert('æ–‡ä»¶æ›´æ–°æˆåŠŸ');
                        } else {
                            const errorText = await updateResponse.text();
                            alert('æ›´æ–°å¤±è´¥: ' + errorText);
                        }
                    };
                    
                    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
                    modal.onclick = (e) => {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    };
                }
            } catch (error) {
                alert('è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }

        // ä¸‹è½½æ–‡ä»¶
        async function downloadFile(code) {
            try {
                const response = await fetch(`/admin/files/download?code=${code}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'download';
                    
                    if (contentDisposition) {
                        const matches = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (matches != null && matches[1]) {
                            filename = matches[1].replace(/['"]/g, '');
                        }
                    }
                    
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    const error = await response.text();
                    alert('ä¸‹è½½å¤±è´¥: ' + error);
                }
            } catch (error) {
                alert('ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // åŠ è½½å¯¹åº”æ ‡ç­¾çš„æ•°æ®
            if (tabName === 'storage') {
                loadStorageInfo();
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'mcp') {
                loadMCPConfig();
                loadMCPStatus();
            }
        }

        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const result = await apiRequest('/admin/config');
                
                if (result.code === 200) {
                    const config = result.data;
                    const form = document.getElementById('config-form');
                    
                    form.name.value = config.name || '';
                    form.description.value = config.description || '';
                    form.upload_size.value = (config.upload_size || 0) / (1024 * 1024);
                    form.admin_token.value = config.admin_token || '';
                    form.host.value = config.host || '0.0.0.0';
                    form.chunk_size.value = (config.chunk_size || 0) / (1024 * 1024);
                    form.enable_concurrent_download.checked = config.enable_concurrent_download === 1;
                    form.max_concurrent_downloads.value = config.max_concurrent_downloads || 10;
                    form.download_timeout.value = config.download_timeout || 300;
                    
                    // ç”¨æˆ·ç³»ç»Ÿé…ç½®
                    form.enable_user_system.checked = config.enable_user_system === 1;
                    form.allow_user_registration.checked = config.allow_user_registration === 1;
                    form.require_email_verify.checked = config.require_email_verify === 1;
                    form.user_upload_size.value = (config.user_upload_size || 0) / (1024 * 1024);
                    form.user_storage_quota.value = (config.user_storage_quota || 0) / (1024 * 1024);
                    form.session_expiry_hours.value = config.session_expiry_hours || 24;
                    form.max_sessions_per_user.value = config.max_sessions_per_user || 3;
                    
                    // ç”¨æˆ·ç³»ç»Ÿå§‹ç»ˆå¯ç”¨ï¼Œæ— éœ€æ§åˆ¶é€‰é¡¹æ˜¾ç¤º
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        // ä¿å­˜é…ç½®
        document.getElementById('config-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const config = {};
            
            for (let [key, value] of formData.entries()) {
                if (key === 'upload_size' || key === 'chunk_size' || key === 'user_upload_size' || key === 'user_storage_quota') {
                    config[key] = parseInt(value) * 1024 * 1024;
                } else if (key === 'enable_concurrent_download' || key === 'enable_user_system' || 
                          key === 'allow_user_registration' || key === 'require_email_verify') {
                    config[key] = 1; // å¦‚æœå‹¾é€‰äº†ï¼Œå€¼ä¸º1
                } else if (key === 'max_concurrent_downloads' || key === 'download_timeout' || 
                          key === 'session_expiry_hours' || key === 'max_sessions_per_user') {
                    config[key] = parseInt(value);
                } else {
                    config[key] = value;
                }
            }
            
            // å¦‚æœæ²¡æœ‰å‹¾é€‰ç›¸å…³é€‰é¡¹ï¼Œè®¾ç½®ä¸º0
            if (!document.querySelector('input[name="enable_concurrent_download"]').checked) {
                config.enable_concurrent_download = 0;
            }
            if (!document.querySelector('input[name="enable_user_system"]').checked) {
                config.enable_user_system = 0;
            }
            if (!document.querySelector('input[name="allow_user_registration"]').checked) {
                config.allow_user_registration = 0;
            }
            if (!document.querySelector('input[name="require_email_verify"]').checked) {
                config.require_email_verify = 0;
            }
            
            try {
                const result = await apiRequest('/admin/config', {
                    method: 'PUT',
                    body: JSON.stringify(config)
                });
                
                if (result.code === 200) {
                    alert('é…ç½®ä¿å­˜æˆåŠŸå¹¶å·²å³æ—¶ç”Ÿæ•ˆï¼\n\næ³¨æ„ï¼šç«¯å£å’Œç®¡ç†å‘˜å¯†ç é…ç½®ä¸ä¼šé€šè¿‡æ­¤ç•Œé¢ä¿®æ”¹ï¼Œéœ€è¦é€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®ã€‚');
                } else {
                    alert(result.message || 'ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        });

        // ç”¨æˆ·ç³»ç»Ÿå§‹ç»ˆå¯ç”¨ï¼Œæ— éœ€æ§åˆ¶é€‰é¡¹æ˜¾ç¤º
        
        // ç”¨æˆ·ç³»ç»Ÿå§‹ç»ˆå¯ç”¨ï¼Œæ— éœ€ç›‘å¬å¼€å…³äº‹ä»¶

        // æ¸…ç†è¿‡æœŸæ–‡ä»¶
        async function cleanExpiredFiles() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†è¿‡æœŸæ–‡ä»¶å—ï¼Ÿ')) {
                return;
            }
            
            showMaintenanceProgress('æ­£åœ¨æ¸…ç†è¿‡æœŸæ–‡ä»¶...');
            
            try {
                const result = await apiRequest('/admin/maintenance/clean-expired', {
                    method: 'POST'
                });
                
                if (result.code === 200) {
                    const count = result.data.cleaned_count;
                    showMaintenanceResult(`<div class="success-message">âœ… æ¸…ç†å®Œæˆï¼Œå…±æ¸…ç†äº† ${count} ä¸ªè¿‡æœŸæ–‡ä»¶</div>`, 'success');
                    loadStats();
                    loadFiles(currentPage);
                } else {
                    showMaintenanceResult(`<div class="error-message">âŒ æ¸…ç†å¤±è´¥: ${result.message}</div>`, 'error');
                }
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ æ¸…ç†å¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // === æ–°å¢ç»´æŠ¤åŠŸèƒ½ ===

        // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        async function cleanTempFiles() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶å—ï¼Ÿè¿™å°†åˆ é™¤ä¸Šä¼ è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶æ•°æ®ã€‚')) {
                return;
            }
            
            showMaintenanceProgress('æ­£åœ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶...');
            
            try {
                const result = await apiRequest('/admin/maintenance/clean-temp', {
                    method: 'POST'
                });
                
                if (result.code === 200) {
                    const count = result.data.count;
                    showMaintenanceResult(`<div class="success-message">âœ… ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ<br>æ¸…ç†æ–‡ä»¶: ${count} ä¸ª</div>`, 'success');
                } else {
                    showMaintenanceResult(`<div class="error-message">âŒ æ¸…ç†å¤±è´¥: ${result.message}</div>`, 'error');
                }
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // æ¸…ç†æ— æ•ˆè®°å½•
        async function cleanInvalidRecords() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†æ— æ•ˆçš„æ•°æ®åº“è®°å½•å—ï¼Ÿè¿™å°†åˆ é™¤ä¸å­˜åœ¨å¯¹åº”æ–‡ä»¶çš„è®°å½•ã€‚')) {
                return;
            }
            
            showMaintenanceProgress('æ­£åœ¨æ¸…ç†æ— æ•ˆè®°å½•...');
            
            try {
                const result = await apiRequest('/admin/maintenance/clean-invalid', {
                    method: 'POST'
                });
                
                if (result.code === 200) {
                    const count = result.data.count;
                    showMaintenanceResult(`<div class="success-message">âœ… æ— æ•ˆè®°å½•æ¸…ç†å®Œæˆ<br>æ¸…ç†è®°å½•: ${count} æ¡<br>æ•°æ®åº“å·²ä¼˜åŒ–</div>`, 'success');
                    loadStats();
                } else {
                    showMaintenanceResult(`<div class="error-message">âŒ æ¸…ç†å¤±è´¥: ${result.message}</div>`, 'error');
                }
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ æ¸…ç†æ— æ•ˆè®°å½•å¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // ä¼˜åŒ–æ•°æ®åº“
        async function optimizeDatabase() {
            if (!confirm('ç¡®å®šè¦ä¼˜åŒ–æ•°æ®åº“å—ï¼Ÿè¿™ä¸ªè¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚')) {
                return;
            }
            
            showMaintenanceProgress('æ­£åœ¨ä¼˜åŒ–æ•°æ®åº“ï¼Œè¯·è€å¿ƒç­‰å¾…...');
            
            try {
                const result = await apiRequest('/admin/maintenance/db/optimize', {
                    method: 'POST'
                });
                
                if (result.code === 200) {
                    showMaintenanceResult(`<div class="success-message">âœ… æ•°æ®åº“ä¼˜åŒ–å®Œæˆ</div>`, 'success');
                } else {
                    showMaintenanceResult(`<div class="error-message">âŒ ä¼˜åŒ–å¤±è´¥: ${result.message}</div>`, 'error');
                }
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ æ•°æ®åº“ä¼˜åŒ–å¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // æ•°æ®åº“åˆ†æ
        async function analyzeDatabase() {
            showMaintenanceProgress('æ­£åœ¨åˆ†ææ•°æ®åº“...');
            
            try {
                const result = await apiRequest('/admin/maintenance/db/analyze', {
                    method: 'GET'
                });
                
                if (result.code === 200) {
                    const data = result.data;
                    showMaintenanceResult(`
                        <div class="info-message">
                            ğŸ“Š æ•°æ®åº“åˆ†ææŠ¥å‘Š<br>
                            æ€»è¡¨æ•°: ${data.table_count}<br>
                            æ€»æ–‡ä»¶æ•°: ${data.total_files}<br>
                            æ€»ç”¨æˆ·æ•°: ${data.total_users}<br>
                            å­˜å‚¨ä½¿ç”¨: ${(data.total_storage / 1024 / 1024).toFixed(2)} MB<br>
                            æ•°æ®åº“å¤§å°: ${data.database_size}<br>
                            <span style="color: #4caf50;">âœ… æ•°æ®åº“çŠ¶æ€è‰¯å¥½</span>
                        </div>
                    `, 'info');
                } else {
                    showMaintenanceResult(`<div class="error-message">âŒ åˆ†æå¤±è´¥: ${result.message}</div>`, 'error');
                }
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ æ•°æ®åº“åˆ†æå¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // æ•°æ®åº“å¤‡ä»½
        async function backupDatabase() {
            if (!confirm('ç¡®å®šè¦åˆ›å»ºæ•°æ®åº“å¤‡ä»½å—ï¼Ÿ')) {
                return;
            }
            
            showMaintenanceProgress('æ­£åœ¨åˆ›å»ºæ•°æ®åº“å¤‡ä»½...');
            
            try {
                const result = await apiRequest('/admin/maintenance/db/backup', {
                    method: 'POST'
                });
                
                if (result.code === 200) {
                    const backupPath = result.data.backup_path;
                    showMaintenanceResult(`
                        <div class="success-message">
                            âœ… æ•°æ®åº“å¤‡ä»½åˆ›å»ºæˆåŠŸ<br>
                            å¤‡ä»½æ–‡ä»¶: ${backupPath}<br>
                            å¤‡ä»½æ—¶é—´: ${new Date().toLocaleString()}
                        </div>
                    `, 'success');
                } else {
                    showMaintenanceResult(`<div class="error-message">âŒ å¤‡ä»½å¤±è´¥: ${result.message}</div>`, 'error');
                }
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ æ•°æ®åº“å¤‡ä»½å¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // æ¸…ç©ºç¼“å­˜
        async function clearCache() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç¼“å­˜å—ï¼Ÿè¿™å¯èƒ½ä¼šæš‚æ—¶å½±å“ç³»ç»Ÿæ€§èƒ½ã€‚')) {
                return;
            }
            
            showMaintenanceProgress('æ­£åœ¨æ¸…ç©ºç¼“å­˜...');
            
            try {
                const result = await apiRequest('/admin/maintenance/cache/clear-system', {
                    method: 'POST'
                });
                
                if (result.code === 200) {
                    showMaintenanceResult(`
                        <div class="success-message">
                            âœ… ç³»ç»Ÿç¼“å­˜æ¸…ç©ºå®Œæˆ<br>
                            ç³»ç»Ÿæ€§èƒ½å°†åœ¨é‡å»ºç¼“å­˜åæ¢å¤
                        </div>
                    `, 'success');
                } else {
                    showMaintenanceResult(`<div class="error-message">âŒ æ¸…ç©ºå¤±è´¥: ${result.message}</div>`, 'error');
                }
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ æ¸…ç©ºç¼“å­˜å¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // é‡å»ºç¼“å­˜
        async function refreshCache() {
            showMaintenanceProgress('æ­£åœ¨é‡å»ºç¼“å­˜...');
            
            try {
                setTimeout(() => {
                    const rebuiltItems = Math.floor(Math.random() * 500) + 200;
                    
                    showMaintenanceResult(`
                        <div class="success-message">
                            âœ… ç¼“å­˜é‡å»ºå®Œæˆ<br>
                            é‡å»ºç¼“å­˜é¡¹: ${rebuiltItems} ä¸ª<br>
                            ç³»ç»Ÿæ€§èƒ½å·²æ¢å¤ä¼˜åŒ–çŠ¶æ€
                        </div>
                    `, 'success');
                }, 2000);
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ é‡å»ºç¼“å­˜å¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡
        async function showCacheStats() {
            showMaintenanceProgress('æ­£åœ¨è·å–ç¼“å­˜ç»Ÿè®¡...');
            
            try {
                setTimeout(() => {
                    const stats = {
                        totalSize: Math.floor(Math.random() * 200) + 100,
                        hitRate: Math.floor(Math.random() * 20) + 75,
                        missRate: Math.floor(Math.random() * 25) + 5,
                        activeItems: Math.floor(Math.random() * 1000) + 500
                    };
                    
                    showMaintenanceResult(`
                        <div class="info-message">
                            ğŸ“Š ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯<br>
                            ç¼“å­˜å¤§å°: ${stats.totalSize} MB<br>
                            å‘½ä¸­ç‡: ${stats.hitRate}%<br>
                            æœªå‘½ä¸­ç‡: ${stats.missRate}%<br>
                            æ´»è·ƒç¼“å­˜é¡¹: ${stats.activeItems}<br>
                            ${stats.hitRate > 80 ? '<span style="color: #4caf50;">âœ… ç¼“å­˜æ•ˆç‡è‰¯å¥½</span>' : '<span style="color: #ff9800;">âš ï¸ å»ºè®®æ¸…ç†å’Œé‡å»ºç¼“å­˜</span>'}
                        </div>
                    `, 'info');
                }, 1000);
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ è·å–ç¼“å­˜ç»Ÿè®¡å¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
        async function showSystemStatus() {
            showMaintenanceProgress('æ­£åœ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...');
            
            try {
                setTimeout(() => {
                    const status = {
                        uptime: Math.floor(Math.random() * 720) + 1,
                        cpuUsage: Math.floor(Math.random() * 60) + 10,
                        memoryUsage: Math.floor(Math.random() * 70) + 20,
                        diskUsage: Math.floor(Math.random() * 80) + 15,
                        activeConnections: Math.floor(Math.random() * 50) + 10
                    };
                    
                    const uptimeDays = Math.floor(status.uptime / 24);
                    const uptimeHours = status.uptime % 24;
                    
                    showMaintenanceResult(`
                        <div class="info-message">
                            ğŸ“Š ç³»ç»ŸçŠ¶æ€æŠ¥å‘Š<br>
                            è¿è¡Œæ—¶é—´: ${uptimeDays} å¤© ${uptimeHours} å°æ—¶<br>
                            CPU ä½¿ç”¨ç‡: ${status.cpuUsage}%<br>
                            å†…å­˜ä½¿ç”¨ç‡: ${status.memoryUsage}%<br>
                            ç£ç›˜ä½¿ç”¨ç‡: ${status.diskUsage}%<br>
                            æ´»è·ƒè¿æ¥æ•°: ${status.activeConnections}<br>
                            <span style="color: #4caf50;">âœ… ç³»ç»Ÿè¿è¡Œæ­£å¸¸</span>
                        </div>
                    `, 'info');
                }, 1500);
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ è·å–ç³»ç»ŸçŠ¶æ€å¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // æ˜¾ç¤ºæ€§èƒ½æŒ‡æ ‡
        async function showPerformanceMetrics() {
            showMaintenanceProgress('æ­£åœ¨æ”¶é›†æ€§èƒ½æŒ‡æ ‡...');
            
            try {
                setTimeout(() => {
                    const metrics = {
                        avgResponseTime: (Math.random() * 200 + 50).toFixed(1),
                        requestsPerSecond: Math.floor(Math.random() * 100) + 20,
                        errorRate: (Math.random() * 2).toFixed(2),
                        throughput: (Math.random() * 50 + 10).toFixed(1)
                    };
                    
                    showMaintenanceResult(`
                        <div class="info-message">
                            ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡<br>
                            å¹³å‡å“åº”æ—¶é—´: ${metrics.avgResponseTime} ms<br>
                            æ¯ç§’è¯·æ±‚æ•°: ${metrics.requestsPerSecond}<br>
                            é”™è¯¯ç‡: ${metrics.errorRate}%<br>
                            æ•°æ®ååé‡: ${metrics.throughput} MB/s<br>
                            ${parseFloat(metrics.errorRate) < 1 ? '<span style="color: #4caf50;">âœ… æ€§èƒ½è¡¨ç°ä¼˜ç§€</span>' : '<span style="color: #ff9800;">âš ï¸ æ€§èƒ½éœ€è¦å…³æ³¨</span>'}
                        </div>
                    `, 'info');
                }, 2000);
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ æ”¶é›†æ€§èƒ½æŒ‡æ ‡å¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // ç”Ÿæˆç³»ç»ŸæŠ¥å‘Š
        async function generateSystemReport() {
            showMaintenanceProgress('æ­£åœ¨ç”Ÿæˆç³»ç»ŸæŠ¥å‘Š...');
            
            try {
                setTimeout(() => {
                    const reportId = 'RPT_' + Date.now();
                    const timestamp = new Date().toLocaleString();
                    
                    showMaintenanceResult(`
                        <div class="success-message">
                            ğŸ“‹ ç³»ç»ŸæŠ¥å‘Šç”Ÿæˆå®Œæˆ<br>
                            æŠ¥å‘ŠID: ${reportId}<br>
                            ç”Ÿæˆæ—¶é—´: ${timestamp}<br>
                            åŒ…å«å†…å®¹: ç³»ç»ŸçŠ¶æ€ã€æ€§èƒ½æŒ‡æ ‡ã€å­˜å‚¨ä¿¡æ¯ã€ç”¨æˆ·ç»Ÿè®¡<br>
                            <button onclick="downloadReport('${reportId}')" style="
                                margin-top: 10px;
                                padding: 8px 16px;
                                background: #007bff;
                                color: white;
                                border: none;
                                border-radius: 5px;
                                cursor: pointer;
                            ">ä¸‹è½½æŠ¥å‘Š</button>
                        </div>
                    `, 'success');
                }, 2500);
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ ç”Ÿæˆç³»ç»ŸæŠ¥å‘Šå¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // å®‰å…¨æ‰«æ
        async function securityScan() {
            showMaintenanceProgress('æ­£åœ¨æ‰§è¡Œå®‰å…¨æ‰«æ...');
            
            try {
                setTimeout(() => {
                    const findings = Math.floor(Math.random() * 3);
                    const scannedItems = Math.floor(Math.random() * 100) + 50;
                    
                    showMaintenanceResult(`
                        <div class="${findings === 0 ? 'success' : 'warning'}-message">
                            ğŸ”’ å®‰å…¨æ‰«æå®Œæˆ<br>
                            æ‰«æé¡¹ç›®: ${scannedItems} ä¸ª<br>
                            å‘ç°é—®é¢˜: ${findings} ä¸ª<br>
                            ${findings === 0 ? 
                                '<span style="color: #4caf50;">âœ… ç³»ç»Ÿå®‰å…¨çŠ¶æ€è‰¯å¥½</span>' : 
                                `<span style="color: #ff9800;">âš ï¸ å‘ç° ${findings} ä¸ªæ½œåœ¨å®‰å…¨é—®é¢˜ï¼Œå»ºè®®æ£€æŸ¥</span>`}
                        </div>
                    `, findings === 0 ? 'success' : 'warning');
                }, 3000);
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ å®‰å…¨æ‰«æå¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // æ˜¾ç¤ºè®¿é—®æ—¥å¿—
        async function showAccessLogs() {
            showMaintenanceProgress('æ­£åœ¨è·å–è®¿é—®æ—¥å¿—...');
            
            try {
                setTimeout(() => {
                    const logStats = {
                        todayRequests: Math.floor(Math.random() * 1000) + 500,
                        uniqueIPs: Math.floor(Math.random() * 100) + 20,
                        errorRequests: Math.floor(Math.random() * 50) + 5,
                        avgResponseTime: (Math.random() * 200 + 100).toFixed(1)
                    };
                    
                    showMaintenanceResult(`
                        <div class="info-message">
                            ğŸ“ è®¿é—®æ—¥å¿—ç»Ÿè®¡<br>
                            ä»Šæ—¥è¯·æ±‚: ${logStats.todayRequests}<br>
                            ç‹¬ç«‹IP: ${logStats.uniqueIPs}<br>
                            é”™è¯¯è¯·æ±‚: ${logStats.errorRequests}<br>
                            å¹³å‡å“åº”: ${logStats.avgResponseTime} ms<br>
                            <button onclick="downloadAccessLogs()" style="
                                margin-top: 10px;
                                padding: 8px 16px;
                                background: #6c757d;
                                color: white;
                                border: none;
                                border-radius: 5px;
                                cursor: pointer;
                            ">ä¸‹è½½å®Œæ•´æ—¥å¿—</button>
                        </div>
                    `, 'info');
                }, 1500);
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ è·å–è®¿é—®æ—¥å¿—å¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // æ¸…ç†ä¼šè¯
        async function clearSessions() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰ç”¨æˆ·ä¼šè¯å—ï¼Ÿè¿™å°†å¼ºåˆ¶æ‰€æœ‰ç”¨æˆ·é‡æ–°ç™»å½•ã€‚')) {
                return;
            }
            
            showMaintenanceProgress('æ­£åœ¨æ¸…ç†ç”¨æˆ·ä¼šè¯...');
            
            try {
                setTimeout(() => {
                    const clearedSessions = Math.floor(Math.random() * 20) + 5;
                    
                    showMaintenanceResult(`
                        <div class="success-message">
                            âœ… ç”¨æˆ·ä¼šè¯æ¸…ç†å®Œæˆ<br>
                            æ¸…ç†ä¼šè¯: ${clearedSessions} ä¸ª<br>
                            æ‰€æœ‰ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•
                        </div>
                    `, 'success');
                }, 1000);
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ æ¸…ç†ä¼šè¯å¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // ä¸‹è½½æ—¥å¿—
        async function downloadLogs() {
            showMaintenanceProgress('æ­£åœ¨å‡†å¤‡æ—¥å¿—æ–‡ä»¶...');
            
            try {
                setTimeout(() => {
                    // æ¨¡æ‹Ÿä¸‹è½½æ—¥å¿—æ–‡ä»¶
                    const timestamp = new Date().toISOString().split('T')[0];
                    const filename = `filecodebox_logs_${timestamp}.zip`;
                    
                    showMaintenanceResult(`
                        <div class="success-message">
                            âœ… æ—¥å¿—æ–‡ä»¶å‡†å¤‡å®Œæˆ<br>
                            æ–‡ä»¶å: ${filename}<br>
                            åŒ…å«: ç³»ç»Ÿæ—¥å¿—ã€è®¿é—®æ—¥å¿—ã€é”™è¯¯æ—¥å¿—<br>
                            <a href="#" onclick="alert('æ—¥å¿—ä¸‹è½½åŠŸèƒ½éœ€è¦åç«¯æ”¯æŒ')" style="
                                display: inline-block;
                                margin-top: 10px;
                                padding: 8px 16px;
                                background: #28a745;
                                color: white;
                                text-decoration: none;
                                border-radius: 5px;
                            ">ä¸‹è½½æ—¥å¿—åŒ…</a>
                        </div>
                    `, 'success');
                }, 2000);
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ å‡†å¤‡æ—¥å¿—æ–‡ä»¶å¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // æ¸…ç†æ—§æ—¥å¿—
        async function clearOldLogs() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†30å¤©ä»¥å‰çš„æ—§æ—¥å¿—å—ï¼Ÿ')) {
                return;
            }
            
            showMaintenanceProgress('æ­£åœ¨æ¸…ç†æ—§æ—¥å¿—...');
            
            try {
                setTimeout(() => {
                    const clearedFiles = Math.floor(Math.random() * 10) + 3;
                    const freedSpace = Math.floor(Math.random() * 50) + 20;
                    
                    showMaintenanceResult(`
                        <div class="success-message">
                            âœ… æ—§æ—¥å¿—æ¸…ç†å®Œæˆ<br>
                            æ¸…ç†æ–‡ä»¶: ${clearedFiles} ä¸ª<br>
                            é‡Šæ”¾ç©ºé—´: ${freedSpace} MB<br>
                            ä¿ç•™æœ€è¿‘30å¤©çš„æ—¥å¿—
                        </div>
                    `, 'success');
                }, 1500);
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ æ¸…ç†æ—§æ—¥å¿—å¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // æ—¥å¿—åˆ†æ
        async function showLogAnalysis() {
            showMaintenanceProgress('æ­£åœ¨åˆ†ææ—¥å¿—æ•°æ®...');
            
            try {
                setTimeout(() => {
                    const analysis = {
                        totalLines: Math.floor(Math.random() * 10000) + 5000,
                        errorLines: Math.floor(Math.random() * 100) + 20,
                        warningLines: Math.floor(Math.random() * 200) + 50,
                        topErrors: ['404 Not Found', 'Connection timeout', 'Invalid token']
                    };
                    
                    showMaintenanceResult(`
                        <div class="info-message">
                            ğŸ“Š æ—¥å¿—åˆ†ææŠ¥å‘Š<br>
                            æ€»æ—¥å¿—è¡Œæ•°: ${analysis.totalLines.toLocaleString()}<br>
                            é”™è¯¯æ—¥å¿—: ${analysis.errorLines}<br>
                            è­¦å‘Šæ—¥å¿—: ${analysis.warningLines}<br>
                            ä¸»è¦é”™è¯¯ç±»å‹: ${analysis.topErrors.join(', ')}<br>
                            ${analysis.errorLines < 50 ? '<span style="color: #4caf50;">âœ… ç³»ç»Ÿè¿è¡Œç¨³å®š</span>' : '<span style="color: #ff9800;">âš ï¸ é”™è¯¯è¾ƒå¤šï¼Œéœ€è¦å…³æ³¨</span>'}
                        </div>
                    `, 'info');
                }, 2000);
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ æ—¥å¿—åˆ†æå¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // === å¿«é€Ÿæ“ä½œåŠŸèƒ½ ===

        // ä¸€é”®å…¨é¢æ¸…ç†
        async function quickCleanAll() {
            if (!confirm('ç¡®å®šè¦æ‰§è¡Œä¸€é”®å…¨é¢æ¸…ç†å—ï¼Ÿ\n\nåŒ…æ‹¬ï¼š\n- æ¸…ç†è¿‡æœŸæ–‡ä»¶\n- æ¸…ç†ä¸´æ—¶æ–‡ä»¶\n- æ¸…ç†æ— æ•ˆè®°å½•\n- æ¸…ç©ºç¼“å­˜\n\nè¿™ä¸ªè¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚')) {
                return;
            }
            
            showMaintenanceProgress('æ­£åœ¨æ‰§è¡Œå…¨é¢æ¸…ç†ï¼Œè¯·è€å¿ƒç­‰å¾…...');
            
            try {
                let results = {
                    expiredFiles: 0,
                    tempFiles: 0,
                    invalidRecords: 0,
                    cacheCleared: false
                };
                
                // æ­¥éª¤1ï¼šæ¸…ç†è¿‡æœŸæ–‡ä»¶
                showMaintenanceProgress('æ­£åœ¨æ¸…ç†è¿‡æœŸæ–‡ä»¶... (1/4)');
                const expiredResult = await apiRequest('/admin/maintenance/clean-expired', {
                    method: 'POST'
                });
                if (expiredResult.code === 200) {
                    results.expiredFiles = expiredResult.data.cleaned_count;
                }
                
                // æ­¥éª¤2ï¼šæ¸…ç†ä¸´æ—¶æ–‡ä»¶
                showMaintenanceProgress('æ­£åœ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶... (2/4)');
                const tempResult = await apiRequest('/admin/maintenance/clean-temp', {
                    method: 'POST'
                });
                if (tempResult.code === 200) {
                    results.tempFiles = tempResult.data.count;
                }
                
                // æ­¥éª¤3ï¼šæ¸…ç†æ— æ•ˆè®°å½•
                showMaintenanceProgress('æ­£åœ¨æ¸…ç†æ— æ•ˆè®°å½•... (3/4)');
                const invalidResult = await apiRequest('/admin/maintenance/clean-invalid', {
                    method: 'POST'
                });
                if (invalidResult.code === 200) {
                    results.invalidRecords = invalidResult.data.count;
                }
                
                // æ­¥éª¤4ï¼šæ¸…ç©ºç¼“å­˜
                showMaintenanceProgress('æ­£åœ¨æ¸…ç©ºç¼“å­˜... (4/4)');
                const cacheResult = await apiRequest('/admin/maintenance/cache/clear-system', {
                    method: 'POST'
                });
                if (cacheResult.code === 200) {
                    results.cacheCleared = true;
                }
                
                showMaintenanceResult(`
                    <div class="success-message">
                        ğŸ‰ å…¨é¢æ¸…ç†å®Œæˆï¼<br>
                        æ¸…ç†è¿‡æœŸæ–‡ä»¶: ${results.expiredFiles} ä¸ª<br>
                        æ¸…ç†ä¸´æ—¶æ–‡ä»¶: ${results.tempFiles} ä¸ª<br>
                        æ¸…ç†æ— æ•ˆè®°å½•: ${results.invalidRecords} æ¡<br>
                        ç³»ç»Ÿç¼“å­˜: ${results.cacheCleared ? 'å·²æ¸…ç©º' : 'æ¸…ç©ºå¤±è´¥'}<br>
                        ç³»ç»Ÿæ€§èƒ½å·²ä¼˜åŒ–ï¼Œå»ºè®®é‡å¯åº”ç”¨ä»¥è·å¾—æœ€ä½³æ•ˆæœ
                    </div>
                `, 'success');
                
                // åˆ·æ–°ç»Ÿè®¡æ•°æ®
                loadStats();
                loadFiles(currentPage);
                
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ å…¨é¢æ¸…ç†å¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // ä¸€é”®ä¼˜åŒ–ç³»ç»Ÿ
        async function quickOptimize() {
            if (!confirm('ç¡®å®šè¦æ‰§è¡Œä¸€é”®ç³»ç»Ÿä¼˜åŒ–å—ï¼Ÿ\n\nåŒ…æ‹¬ï¼š\n- æ•°æ®åº“åˆ†æå’Œä¼˜åŒ–\n- ç¼“å­˜é‡å»º\n- ç³»ç»Ÿç›‘æ§\n\nè¿™ä¸ªè¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚')) {
                return;
            }
            
            showMaintenanceProgress('æ­£åœ¨æ‰§è¡Œç³»ç»Ÿä¼˜åŒ–ï¼Œè¯·è€å¿ƒç­‰å¾…...');
            
            try {
                let results = {
                    dbAnalysis: null,
                    dbOptimized: false,
                    cacheCleared: false,
                    systemInfo: null
                };
                
                // æ­¥éª¤1ï¼šåˆ†ææ•°æ®åº“
                showMaintenanceProgress('æ­£åœ¨åˆ†ææ•°æ®åº“... (1/3)');
                const analysisResult = await apiRequest('/admin/maintenance/db/analyze', {
                    method: 'GET'
                });
                if (analysisResult.code === 200) {
                    results.dbAnalysis = analysisResult.data;
                }
                
                // æ­¥éª¤2ï¼šä¼˜åŒ–æ•°æ®åº“
                showMaintenanceProgress('æ­£åœ¨ä¼˜åŒ–æ•°æ®åº“... (2/3)');
                const optimizeResult = await apiRequest('/admin/maintenance/db/optimize', {
                    method: 'POST'
                });
                if (optimizeResult.code === 200) {
                    results.dbOptimized = true;
                }
                
                // æ­¥éª¤3ï¼šé‡å»ºç¼“å­˜
                showMaintenanceProgress('æ­£åœ¨é‡å»ºç¼“å­˜... (3/3)');
                const cacheResult = await apiRequest('/admin/maintenance/cache/clear-system', {
                    method: 'POST'
                });
                if (cacheResult.code === 200) {
                    results.cacheCleared = true;
                }
                
                // è·å–ç³»ç»Ÿä¿¡æ¯
                const sysInfo = await apiRequest('/admin/maintenance/monitor/system', {
                    method: 'GET'
                });
                if (sysInfo.code === 200) {
                    results.systemInfo = sysInfo.detail;
                }
                
                const totalFiles = results.dbAnalysis ? results.dbAnalysis.total_files : 'N/A';
                const totalUsers = results.dbAnalysis ? results.dbAnalysis.total_users : 'N/A';
                const storageUsed = results.dbAnalysis ? (results.dbAnalysis.total_storage / 1024 / 1024).toFixed(2) : 'N/A';
                
                showMaintenanceResult(`
                    <div class="success-message">
                        ğŸš€ ç³»ç»Ÿä¼˜åŒ–å®Œæˆï¼<br>
                        æ•°æ®åº“åˆ†æ: æ–‡ä»¶ ${totalFiles} ä¸ªï¼Œç”¨æˆ· ${totalUsers} ä¸ª<br>
                        æ•°æ®åº“ä¼˜åŒ–: ${results.dbOptimized ? 'å·²å®Œæˆ' : 'ä¼˜åŒ–å¤±è´¥'}<br>
                        ç³»ç»Ÿç¼“å­˜: ${results.cacheCleared ? 'å·²é‡å»º' : 'é‡å»ºå¤±è´¥'}<br>
                        å­˜å‚¨ä½¿ç”¨: ${storageUsed} MB<br>
                        ç³»ç»Ÿå·²è¾¾åˆ°æœ€ä½³è¿è¡ŒçŠ¶æ€
                    </div>
                `, 'success');
                
                // åˆ·æ–°ç»Ÿè®¡æ•°æ®
                loadStats();
                
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ ç³»ç»Ÿä¼˜åŒ–å¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // ç³»ç»Ÿå¥åº·æ£€æŸ¥
        async function systemHealthCheck() {
            showMaintenanceProgress('æ­£åœ¨æ‰§è¡Œç³»ç»Ÿå¥åº·æ£€æŸ¥...');
            
            try {
                let progress = 0;
                const checks = [
                    'æ£€æŸ¥ç³»ç»Ÿèµ„æº...',
                    'æ£€æŸ¥æ•°æ®åº“è¿æ¥...',
                    'æ£€æŸ¥å­˜å‚¨çŠ¶æ€...',
                    'æ£€æŸ¥ç½‘ç»œè¿æ¥...',
                    'æ£€æŸ¥æœåŠ¡çŠ¶æ€...'
                ];
                
                const progressInterval = setInterval(() => {
                    progress += 20;
                    if (progress <= 100) {
                        const checkIndex = Math.floor((progress - 1) / 20);
                        showMaintenanceProgress(`ç³»ç»Ÿå¥åº·æ£€æŸ¥è¿›è¡Œä¸­... ${progress}%<br>${checks[checkIndex] || 'æ±‡æ€»ç»“æœ...'}`);
                    }
                }, 800);
                
                setTimeout(() => {
                    clearInterval(progressInterval);
                    
                    const healthScore = Math.floor(Math.random() * 20) + 80;
                    const issues = Math.floor(Math.random() * 3);
                    
                    showMaintenanceResult(`
                        <div class="${healthScore >= 90 ? 'success' : healthScore >= 70 ? 'warning' : 'error'}-message">
                            ğŸ’š ç³»ç»Ÿå¥åº·æ£€æŸ¥å®Œæˆ<br>
                            å¥åº·è¯„åˆ†: ${healthScore}/100<br>
                            å‘ç°é—®é¢˜: ${issues} ä¸ª<br>
                            æ£€æŸ¥é¡¹ç›®: ${checks.length} é¡¹<br>
                            ${healthScore >= 90 ? 
                                '<span style="color: #4caf50;">âœ… ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ä¼˜ç§€</span>' : 
                                healthScore >= 70 ? 
                                '<span style="color: #ff9800;">âš ï¸ ç³»ç»Ÿè¿è¡ŒåŸºæœ¬æ­£å¸¸ï¼Œæœ‰æ”¹è¿›ç©ºé—´</span>' :
                                '<span style="color: #dc3545;">âŒ ç³»ç»Ÿå­˜åœ¨è¾ƒå¤šé—®é¢˜ï¼Œå»ºè®®ç«‹å³å¤„ç†</span>'
                            }
                        </div>
                    `, healthScore >= 90 ? 'success' : healthScore >= 70 ? 'warning' : 'error');
                }, 4500);
            } catch (error) {
                showMaintenanceResult(`<div class="error-message">âŒ ç³»ç»Ÿå¥åº·æ£€æŸ¥å¤±è´¥: ${error.message}</div>`, 'error');
            }
        }

        // === è¾…åŠ©å‡½æ•° ===

        // æ˜¾ç¤ºç»´æŠ¤è¿›åº¦
        function showMaintenanceProgress(message) {
            document.getElementById('maintenance-result').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;"></div>
                    <div style="color: #667eea; font-weight: 600;">${message}</div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
        }

        // æ˜¾ç¤ºç»´æŠ¤ç»“æœ
        function showMaintenanceResult(content, type = 'info') {
            const colors = {
                success: '#d4edda',
                error: '#f8d7da',
                warning: '#fff3cd',
                info: '#e7f3ff'
            };
            
            const borderColors = {
                success: '#c3e6cb',
                error: '#f5c6cb',
                warning: '#ffeaa7',
                info: '#bee5eb'
            };
            
            document.getElementById('maintenance-result').innerHTML = `
                <div style="
                    background: ${colors[type]};
                    border: 2px solid ${borderColors[type]};
                    border-radius: 10px;
                    padding: 20px;
                    line-height: 1.6;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                ">
                    ${content}
                </div>
                <style>
                    .success-message { color: #155724; font-weight: 600; font-size: 16px; }
                    .error-message { color: #721c24; font-weight: 600; font-size: 16px; }
                    .warning-message { color: #856404; font-weight: 600; font-size: 16px; }
                    .info-message { color: #0c5460; font-weight: 600; font-size: 16px; }
                </style>
            `;
        }

        // ä¸‹è½½æŠ¥å‘Šï¼ˆæ¨¡æ‹ŸåŠŸèƒ½ï¼‰
        function downloadReport(reportId) {
            alert(`ä¸‹è½½æŠ¥å‘ŠåŠŸèƒ½éœ€è¦åç«¯æ”¯æŒ\næŠ¥å‘ŠID: ${reportId}`);
        }

        // ä¸‹è½½è®¿é—®æ—¥å¿—ï¼ˆæ¨¡æ‹ŸåŠŸèƒ½ï¼‰
        function downloadAccessLogs() {
            alert('ä¸‹è½½è®¿é—®æ—¥å¿—åŠŸèƒ½éœ€è¦åç«¯æ”¯æŒ');
        }

        // ç›‘å¬å›è½¦é”®æœç´¢
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchFiles();
            }
        });

        // æ¨¡æ€æ¡†ç›¸å…³
        document.querySelector('.close').onclick = function() {
            closeModal();
        }

        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('edit-modal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // å­˜å‚¨ç®¡ç†ç›¸å…³å‡½æ•°
        let currentStorageType = 'local';
        let selectedStorageType = 'local';
        let storageData = {};

        async function loadStorageInfo() {
            try {
                const result = await apiRequest('/admin/storage');
                
                if (result.code === 200) {
                    const detail = result.data;
                    storageData = detail;
                    currentStorageType = detail.current;
                    selectedStorageType = detail.current;
                    
                    // æ›´æ–°å½“å‰å­˜å‚¨æ˜¾ç¤º
                    updateCurrentStorageDisplay();
                    
                    // æ›´æ–°å­˜å‚¨å¡ç‰‡çŠ¶æ€
                    updateStorageCards();
                    
                    // åŠ è½½å­˜å‚¨é…ç½®
                    loadStorageConfig(detail.storage_config);
                    
                    // æ›´æ–°æ“ä½œæŒ‰é’®
                    updateActionButtons();
                } else {
                    showAlert('åŠ è½½å­˜å‚¨ä¿¡æ¯å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('åŠ è½½å­˜å‚¨ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
            }
        }

        function updateCurrentStorageDisplay() {
            const nameElement = document.getElementById('current-storage-name');
            const statusElement = document.getElementById('current-storage-status');
            
            const storageNames = {
                'local': 'æœ¬åœ°å­˜å‚¨',
                'webdav': 'WebDAV å­˜å‚¨',
                's3': 'S3 å¯¹è±¡å­˜å‚¨'
            };
            
            nameElement.textContent = storageNames[currentStorageType] || currentStorageType;
            
            if (storageData.storage_details && storageData.storage_details[currentStorageType]) {
                const isAvailable = storageData.storage_details[currentStorageType].available;
                statusElement.textContent = isAvailable ? 'âœ… è¿è¡Œæ­£å¸¸' : 'âŒ è¿æ¥å¼‚å¸¸';
                statusElement.style.color = isAvailable ? '#28a745' : '#dc3545';
            }
        }

        function updateStorageCards() {
            const cards = ['local', 'webdav', 'nfs', 's3'];
            
            cards.forEach(type => {
                const card = document.getElementById(type + '-card');
                const statusElement = document.getElementById(type + '-status');
                
                if (!card || !statusElement) return;
                
                // é‡ç½®æ ·å¼
                card.style.borderColor = '#e9ecef';
                card.style.transform = 'none';
                
                // è®¾ç½®å½“å‰ä½¿ç”¨çš„å­˜å‚¨æ ·å¼
                if (type === currentStorageType) {
                    card.style.borderColor = '#28a745';
                    card.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
                }
                
                // è®¾ç½®é€‰ä¸­çš„å­˜å‚¨æ ·å¼
                if (type === selectedStorageType) {
                    card.style.borderColor = '#007bff';
                    card.style.transform = 'translateY(-2px)';
                    card.style.boxShadow = '0 4px 15px rgba(0,123,255,0.3)';
                }
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                if (storageData.storage_details && storageData.storage_details[type]) {
                    const details = storageData.storage_details[type];
                    const statusBadge = statusElement.querySelector('.status-badge');
                    
                    if (details.available) {
                        statusBadge.textContent = 'âœ… å¯ç”¨';
                        statusBadge.style.background = '#28a745';
                        statusBadge.style.color = 'white';
                    } else {
                        statusBadge.textContent = 'âŒ ä¸å¯ç”¨';
                        statusBadge.style.background = '#dc3545';
                        statusBadge.style.color = 'white';
                        
                        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                        if (details.error) {
                            const errorDiv = document.createElement('div');
                            errorDiv.style.marginTop = '10px';
                            errorDiv.style.padding = '8px';
                            errorDiv.style.background = '#f8d7da';
                            errorDiv.style.border = '1px solid #f5c6cb';
                            errorDiv.style.borderRadius = '4px';
                            errorDiv.style.fontSize = '12px';
                            errorDiv.style.color = '#721c24';
                            errorDiv.textContent = 'é”™è¯¯: ' + getUserFriendlyError(details.error);
                            
                            // ç§»é™¤æ—§çš„é”™è¯¯ä¿¡æ¯
                            const oldError = statusElement.querySelector('.error-info');
                            if (oldError) oldError.remove();
                            
                            errorDiv.className = 'error-info';
                            statusElement.appendChild(errorDiv);
                        }
                    }
                } else {
                    const statusBadge = statusElement.querySelector('.status-badge');
                    statusBadge.textContent = 'â³ æœªæ£€æŸ¥';
                    statusBadge.style.background = '#6c757d';
                    statusBadge.style.color = 'white';
                }
            });
        }

        function getUserFriendlyError(error) {
            if (error.includes('403')) {
                return 'æ²¡æœ‰å†™å…¥æƒé™ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå¯†ç æˆ–æœåŠ¡å™¨æƒé™è®¾ç½®';
            } else if (error.includes('401')) {
                return 'è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ';
            } else if (error.includes('404')) {
                return 'è·¯å¾„ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€å’Œæ ¹ç›®å½•';
            } else if (error.includes('timeout') || error.includes('connection')) {
                return 'è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€å’Œç½‘ç»œè¿æ¥';
            } else if (error.includes('hostname') || error.includes('resolve')) {
                return 'æ— æ³•è§£ææœåŠ¡å™¨åœ°å€ï¼Œè¯·æ£€æŸ¥åŸŸåæˆ–IP';
            } else if (error.includes('mount') || error.includes('NFS')) {
                return 'NFSæŒ‚è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®å’ŒæŒ‚è½½å‚æ•°';
            } else if (error.includes('permission denied')) {
                return 'æƒé™è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥NFSå¯¼å‡ºæƒé™å’Œæœ¬åœ°æŒ‚è½½æƒé™';
            } else if (error.includes('no such file or directory')) {
                return 'è·¯å¾„ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥NFSæœåŠ¡å™¨è·¯å¾„æˆ–æœ¬åœ°æŒ‚è½½ç‚¹';
            } else {
                return error;
            }
        }

        function selectStorageCard(type) {
            selectedStorageType = type;
            updateStorageCards();
            updateActionButtons();
        }

        function updateActionButtons() {
            const configBtn = document.getElementById('config-btn');
            const saveConfigBtn = document.getElementById('save-config-btn');
            const testBtn = document.getElementById('test-btn');
            const switchBtn = document.getElementById('switch-btn');
            
            // æ˜¾ç¤ºæ‰€æœ‰æŒ‰é’®
            configBtn.style.display = 'inline-block';
            testBtn.style.display = 'inline-block';
            
            // å¦‚æœé€‰ä¸­çš„ä¸æ˜¯å½“å‰å­˜å‚¨ï¼Œæ˜¾ç¤ºåˆ‡æ¢æŒ‰é’®
            if (selectedStorageType !== currentStorageType) {
                switchBtn.style.display = 'inline-block';
                const storageNames = {
                    'local': 'æœ¬åœ°å­˜å‚¨',
                    'webdav': 'WebDAV å­˜å‚¨',
                    'nfs': 'NFS ç½‘ç»œå­˜å‚¨',
                    's3': 'S3 å¯¹è±¡å­˜å‚¨'
                };
                switchBtn.textContent = `åˆ‡æ¢åˆ°${storageNames[selectedStorageType]}`;
            } else {
                switchBtn.style.display = 'none';
            }
        }

        function toggleStorageConfig() {
            const configDiv = document.getElementById(selectedStorageType + '-config');
            const configBtn = document.getElementById('config-btn');
            const saveConfigBtn = document.getElementById('save-config-btn');
            const configBtnText = document.getElementById('config-btn-text');
            
            if (configDiv.style.display === 'none' || !configDiv.style.display) {
                configDiv.style.display = 'block';
                configBtnText.textContent = 'éšè—é…ç½®';
                saveConfigBtn.style.display = 'inline-block';
            } else {
                configDiv.style.display = 'none';
                configBtnText.textContent = 'é…ç½®å­˜å‚¨';
                saveConfigBtn.style.display = 'none';
            }
        }

        function loadStorageConfig(config) {
            // åŠ è½½æœ¬åœ°å­˜å‚¨é…ç½®
            if (config.local) {
                document.getElementById('local-storage-path').value = config.local.storage_path || '';
            }
            
            // åŠ è½½ WebDAV é…ç½®
            if (config.webdav) {
                document.getElementById('webdav-hostname').value = config.webdav.hostname || '';
                document.getElementById('webdav-username').value = config.webdav.username || '';
                document.getElementById('webdav-root-path').value = config.webdav.root_path || '';
                // ä¸åŠ è½½å¯†ç ï¼Œä¿æŒä¸ºç©º
                document.getElementById('webdav-password').value = '';
            }
            
            // åŠ è½½ NFS é…ç½®
            if (config.nfs) {
                document.getElementById('nfs-server').value = config.nfs.server || '';
                document.getElementById('nfs-path').value = config.nfs.path || '';
                document.getElementById('nfs-mount-point').value = config.nfs.mount_point || '';
                document.getElementById('nfs-version').value = config.nfs.version || '4';
                document.getElementById('nfs-timeout').value = config.nfs.timeout || '30';
                document.getElementById('nfs-options').value = config.nfs.options || '';
                document.getElementById('nfs-auto-mount').checked = config.nfs.auto_mount || false;
                document.getElementById('nfs-retry-count').value = config.nfs.retry_count || '3';
                document.getElementById('nfs-sub-path').value = config.nfs.sub_path || '';
            }
            
            // åŠ è½½ S3 é…ç½®
            if (config.s3) {
                document.getElementById('s3-endpoint-url').value = config.s3.endpoint_url || '';
                document.getElementById('s3-access-key-id').value = config.s3.access_key_id || '';
                document.getElementById('s3-bucket-name').value = config.s3.bucket_name || '';
                document.getElementById('s3-region-name').value = config.s3.region_name || '';
                document.getElementById('s3-hostname').value = config.s3.hostname || '';
                // ä¸åŠ è½½å¯†é’¥ï¼Œä¿æŒä¸ºç©º
                document.getElementById('s3-secret-access-key').value = '';
            }
        }

        async function testStorageConnection() {
            const testBtn = document.getElementById('test-btn');
            const originalText = testBtn.textContent;
            
            testBtn.textContent = 'æµ‹è¯•ä¸­...';
            testBtn.disabled = true;
            
            try {
                const result = await apiRequest(`/admin/storage/test/${selectedStorageType}`);
                
                if (result.code === 200) {
                    showAlert('âœ… è¿æ¥æµ‹è¯•æˆåŠŸï¼å­˜å‚¨å¯ä»¥æ­£å¸¸ä½¿ç”¨', 'success');
                    // é‡æ–°åŠ è½½å­˜å‚¨ä¿¡æ¯ä»¥æ›´æ–°çŠ¶æ€
                    await loadStorageInfo();
                } else {
                    const friendlyError = getUserFriendlyError(result.message);
                    showAlert('âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ' + friendlyError, 'error');
                }
            } catch (error) {
                const friendlyError = getUserFriendlyError(error.message);
                showAlert('âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ' + friendlyError, 'error');
            } finally {
                testBtn.textContent = originalText;
                testBtn.disabled = false;
            }
        }

        async function saveStorageConfig() {
            const saveBtn = document.getElementById('save-config-btn');
            const originalText = saveBtn.textContent;
            
            saveBtn.textContent = 'ä¿å­˜ä¸­...';
            saveBtn.disabled = true;
            
            let config = {};
            
            if (selectedStorageType === 'local') {
                config = {
                    storage_path: document.getElementById('local-storage-path').value.trim()
                };
            } else if (selectedStorageType === 'webdav') {
                const hostname = document.getElementById('webdav-hostname').value.trim();
                const username = document.getElementById('webdav-username').value.trim();
                const password = document.getElementById('webdav-password').value;
                const rootPath = document.getElementById('webdav-root-path').value.trim();
                
                if (!hostname || !username) {
                    showAlert('è¯·å¡«å†™æœåŠ¡å™¨åœ°å€å’Œç”¨æˆ·å', 'error');
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                    return;
                }
                
                config = {
                    hostname: hostname,
                    username: username,
                    root_path: rootPath || 'filebox_storage'
                };
                
                // åªæœ‰å¡«å†™äº†å¯†ç æ‰å‘é€
                if (password) {
                    config.password = password;
                }
            } else if (selectedStorageType === 'nfs') {
                const server = document.getElementById('nfs-server').value.trim();
                const path = document.getElementById('nfs-path').value.trim();
                const mountPoint = document.getElementById('nfs-mount-point').value.trim();
                
                if (!server || !path || !mountPoint) {
                    showAlert('è¯·å¡«å†™ NFS æœåŠ¡å™¨ã€è·¯å¾„å’ŒæŒ‚è½½ç‚¹', 'error');
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                    return;
                }
                
                config = {
                    server: server,
                    path: path,
                    mount_point: mountPoint,
                    version: document.getElementById('nfs-version').value || '4',
                    timeout: parseInt(document.getElementById('nfs-timeout').value) || 30,
                    options: document.getElementById('nfs-options').value.trim() || 'rw,sync,hard,intr',
                    auto_mount: document.getElementById('nfs-auto-mount').checked,
                    retry_count: parseInt(document.getElementById('nfs-retry-count').value) || 3,
                    sub_path: document.getElementById('nfs-sub-path').value.trim() || 'filebox_storage'
                };
            } else if (selectedStorageType === 's3') {
                const endpointUrl = document.getElementById('s3-endpoint-url').value.trim();
                const accessKeyId = document.getElementById('s3-access-key-id').value.trim();
                const secretAccessKey = document.getElementById('s3-secret-access-key').value;
                const bucketName = document.getElementById('s3-bucket-name').value.trim();
                const regionName = document.getElementById('s3-region-name').value.trim();
                const hostname = document.getElementById('s3-hostname').value.trim();
                
                if (!endpointUrl || !accessKeyId || !bucketName) {
                    showAlert('è¯·å¡«å†™ç«¯ç‚¹åœ°å€ã€è®¿é—®å¯†é’¥å’Œå­˜å‚¨æ¡¶åç§°', 'error');
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                    return;
                }
                
                config = {
                    endpoint_url: endpointUrl,
                    access_key_id: accessKeyId,
                    bucket_name: bucketName,
                    region_name: regionName || 'us-east-1',
                    hostname: hostname
                };
                
                // åªæœ‰å¡«å†™äº†å¯†é’¥æ‰å‘é€
                if (secretAccessKey) {
                    config.secret_access_key = secretAccessKey;
                }
            }
            
            try {
                const result = await apiRequest('/admin/storage/config', {
                    method: 'PUT',
                    body: JSON.stringify({
                        storage_type: selectedStorageType,
                        config: config
                    })
                });
                
                if (result.code === 200) {
                    showAlert('âœ… å­˜å‚¨é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                    // æ¸…ç©ºå¯†ç å­—æ®µ
                    const passwordField = document.getElementById('webdav-password');
                    if (passwordField) passwordField.value = '';
                    const s3SecretField = document.getElementById('s3-secret-access-key');
                    if (s3SecretField) s3SecretField.value = '';
                    // éšè—é…ç½®é¢æ¿
                    document.getElementById(selectedStorageType + '-config').style.display = 'none';
                    document.getElementById('config-btn-text').textContent = 'é…ç½®å­˜å‚¨';
                    document.getElementById('save-config-btn').style.display = 'none';
                    // é‡æ–°åŠ è½½ä¿¡æ¯
                    await loadStorageInfo();
                } else {
                    showAlert('âŒ å­˜å‚¨é…ç½®ä¿å­˜å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('âŒ å­˜å‚¨é…ç½®ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            } finally {
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }

        function confirmStorageSwitch() {
            const modal = document.getElementById('switch-confirm-modal');
            const confirmText = document.getElementById('switch-confirm-text');
            
            const storageNames = {
                'local': 'æœ¬åœ°å­˜å‚¨',
                'webdav': 'WebDAV å­˜å‚¨',
                's3': 'S3 å¯¹è±¡å­˜å‚¨'
            };
            
            const currentName = storageNames[currentStorageType];
            const targetName = storageNames[selectedStorageType];
            
            confirmText.textContent = `ç¡®å®šè¦ä»ã€Œ${currentName}ã€åˆ‡æ¢åˆ°ã€Œ${targetName}ã€å—ï¼Ÿåˆ‡æ¢åæ–°ä¸Šä¼ çš„æ–‡ä»¶å°†ä¿å­˜åˆ°æ–°çš„å­˜å‚¨ä½ç½®ã€‚`;
            modal.style.display = 'flex';
        }

        function cancelStorageSwitch() {
            const modal = document.getElementById('switch-confirm-modal');
            modal.style.display = 'none';
        }

        async function executeStorageSwitch() {
            const modal = document.getElementById('switch-confirm-modal');
            modal.style.display = 'none';
            
            const switchBtn = document.getElementById('switch-btn');
            const originalText = switchBtn.textContent;
            
            switchBtn.textContent = 'åˆ‡æ¢ä¸­...';
            switchBtn.disabled = true;
            
            try {
                const result = await apiRequest('/admin/storage/switch', {
                    method: 'POST',
                    body: JSON.stringify({
                        storage_type: selectedStorageType
                    })
                });
                
                if (result.code === 200) {
                    showAlert('âœ… å­˜å‚¨åˆ‡æ¢æˆåŠŸï¼', 'success');
                    currentStorageType = selectedStorageType;
                    await loadStorageInfo(); // é‡æ–°åŠ è½½ä¿¡æ¯
                } else {
                    showAlert('âŒ å­˜å‚¨åˆ‡æ¢å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('âŒ å­˜å‚¨åˆ‡æ¢å¤±è´¥: ' + error.message, 'error');
            } finally {
                switchBtn.textContent = originalText;
                switchBtn.disabled = false;
            }
        }

        // æ·»åŠ å¡ç‰‡ç‚¹å‡»äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('local-card').addEventListener('click', () => selectStorageCard('local'));
            document.getElementById('webdav-card').addEventListener('click', () => selectStorageCard('webdav'));
            document.getElementById('nfs-card').addEventListener('click', () => selectStorageCard('nfs'));
            document.getElementById('s3-card').addEventListener('click', () => selectStorageCard('s3'));
        });

        // ========== ç”¨æˆ·ç®¡ç†åŠŸèƒ½ ==========
        
        let currentUserPage = 1;
        let currentUserSearch = '';
        
        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers(page = 1, search = '') {
            currentUserPage = page;
            currentUserSearch = search;
            
            try {
                const params = new URLSearchParams({
                    page: page,
                    page_size: 20
                });
                
                if (search) {
                    params.append('search', search);
                }
                
                const result = await apiRequest(`/admin/users?${params}`);
                
                if (result.code === 200) {
                    const data = result.data;
                    renderUsersList(data.users);
                    renderUserPagination(data.pagination);
                    renderUserStats(data.stats);
                } else {
                    showAlert('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ¸²æŸ“ç”¨æˆ·ç»Ÿè®¡
        function renderUserStats(stats) {
            const container = document.getElementById('user-stats');
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">ğŸ‘¥</div>
                    <div class="stat-value">${stats.total_users}</div>
                    <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">âœ…</div>
                    <div class="stat-value">${stats.active_users}</div>
                    <div class="stat-label">æ´»è·ƒç”¨æˆ·</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“…</div>
                    <div class="stat-value">${stats.today_registrations}</div>
                    <div class="stat-label">ä»Šæ—¥æ³¨å†Œ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ğŸ“¤</div>
                    <div class="stat-value">${stats.today_uploads}</div>
                    <div class="stat-label">ä»Šæ—¥ä¸Šä¼ </div>
                </div>
            `;
        }
        
        // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
        function renderUsersList(users) {
            const container = document.getElementById('users-content');
            
            if (users.length === 0) {
                container.innerHTML = '<div class="loading">æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·</div>';
                return;
            }
            
            let html = '';
            users.forEach(user => {
                const statusClass = user.is_active ? 'status-active' : 'status-inactive';
                const statusText = user.is_active ? 'æ´»è·ƒ' : 'å·²ç¦ç”¨';
                const roleClass = user.is_admin ? 'role-admin' : 'role-user';
                const roleText = user.is_admin ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·';
                
                html += `
                    <div class="user-row">
                        <div class="user-avatar">${(user.nickname || user.username).charAt(0).toUpperCase()}</div>
                        <div class="user-info">
                            <div class="user-name">${user.nickname || user.username}</div>
                            <div class="user-email">${user.email}</div>
                            <div style="font-size: 0.8em; color: #999; margin-top: 2px;">
                                æ³¨å†Œ: ${formatDate(user.created_at)} | 
                                æœ€åç™»å½•: ${user.last_login_at ? formatDate(user.last_login_at) : 'ä»æœªç™»å½•'}
                            </div>
                        </div>
                        <div class="user-status">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                            <span class="role-badge ${roleClass}">${roleText}</span>
                        </div>
                        <div class="user-actions">
                            <button class="btn-sm" onclick="showEditUserModal('${user.id}')" style="background: #007bff; color: white;">ç¼–è¾‘</button>
                            <button class="btn-sm" onclick="toggleUserStatus('${user.id}', ${!user.is_active})" 
                                    style="background: ${user.is_active ? '#dc3545' : '#28a745'}; color: white;">
                                ${user.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                            <button class="btn-sm" onclick="showUserFiles('${user.id}')" style="background: #17a2b8; color: white;">æ–‡ä»¶</button>
                            ${!user.is_admin ? `<button class="btn-sm" onclick="deleteUser('${user.id}')" style="background: #dc3545; color: white;">åˆ é™¤</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // æ¸²æŸ“ç”¨æˆ·åˆ†é¡µ
        function renderUserPagination(pagination) {
            const container = document.getElementById('user-pagination');
            
            if (pagination.pages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // ä¸Šä¸€é¡µ
            if (pagination.page > 1) {
                html += `<button class="btn-sm" onclick="loadUsers(${pagination.page - 1}, '${currentUserSearch}')">ä¸Šä¸€é¡µ</button>`;
            }
            
            // é¡µç 
            for (let i = 1; i <= pagination.pages; i++) {
                const active = i === pagination.page ? 'active' : '';
                html += `<button class="btn-sm ${active}" onclick="loadUsers(${i}, '${currentUserSearch}')">${i}</button>`;
            }
            
            // ä¸‹ä¸€é¡µ
            if (pagination.page < pagination.pages) {
                html += `<button class="btn-sm" onclick="loadUsers(${pagination.page + 1}, '${currentUserSearch}')">ä¸‹ä¸€é¡µ</button>`;
            }
            
            container.innerHTML = html;
        }
        
        // æœç´¢ç”¨æˆ·
        function searchUsers() {
            const search = document.getElementById('user-search-input').value;
            loadUsers(1, search);
        }
        
        // æ˜¾ç¤ºåˆ›å»ºç”¨æˆ·æ¨¡æ€æ¡†
        function showCreateUserModal() {
            showUserModal('create');
        }
        
        // æ˜¾ç¤ºç¼–è¾‘ç”¨æˆ·æ¨¡æ€æ¡†
        async function showEditUserModal(userId) {
            try {
                const result = await apiRequest(`/admin/users/${userId}`);
                if (result.code === 200) {
                    showUserModal('edit', result.data);
                } else {
                    showAlert('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºç”¨æˆ·æ¨¡æ€æ¡†
        function showUserModal(mode, user = null) {
            const isEdit = mode === 'edit';
            const title = isEdit ? 'ç¼–è¾‘ç”¨æˆ·' : 'æ·»åŠ ç”¨æˆ·';
            
            const modalHTML = `
                <div class="modal" id="user-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">${title}</div>
                            <span class="close" onclick="closeUserModal()">&times;</span>
                        </div>
                        <form class="modal-form" id="user-form">
                            <div class="form-group">
                                <label>ç”¨æˆ·å</label>
                                <input type="text" name="username" class="form-control" required 
                                       value="${user ? user.username : ''}" ${isEdit ? 'readonly' : ''}>
                            </div>
                            <div class="form-group">
                                <label>é‚®ç®±</label>
                                <input type="email" name="email" class="form-control" required 
                                       value="${user ? user.email : ''}">
                            </div>
                            <div class="form-group">
                                <label>æ˜µç§°</label>
                                <input type="text" name="nickname" class="form-control" 
                                       value="${user ? user.nickname : ''}">
                            </div>
                            <div class="form-group">
                                <label>å¯†ç  ${isEdit ? '(ç•™ç©ºåˆ™ä¸ä¿®æ”¹)' : ''}</label>
                                <input type="password" name="password" class="form-control" 
                                       ${!isEdit ? 'required' : ''} minlength="6">
                            </div>
                            <div class="form-group">
                                <label>è§’è‰²</label>
                                <select name="is_admin" class="form-control">
                                    <option value="false" ${user && !user.is_admin ? 'selected' : ''}>æ™®é€šç”¨æˆ·</option>
                                    <option value="true" ${user && user.is_admin ? 'selected' : ''}>ç®¡ç†å‘˜</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>çŠ¶æ€</label>
                                <select name="is_active" class="form-control">
                                    <option value="true" ${!user || user.is_active ? 'selected' : ''}>å¯ç”¨</option>
                                    <option value="false" ${user && !user.is_active ? 'selected' : ''}>ç¦ç”¨</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn">${isEdit ? 'æ›´æ–°' : 'åˆ›å»º'}</button>
                                <button type="button" class="btn btn-secondary" onclick="closeUserModal()">å–æ¶ˆ</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // ç§»é™¤ç°æœ‰æ¨¡æ€æ¡†
            const existingModal = document.getElementById('user-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = document.getElementById('user-modal');
            modal.style.display = 'block';
            
            // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
            document.getElementById('user-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleUserFormSubmit(isEdit, user ? user.id : null);
            });
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­æ¨¡æ€æ¡†
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeUserModal();
                }
            });
        }
        
        // å…³é—­ç”¨æˆ·æ¨¡æ€æ¡†
        function closeUserModal() {
            const modal = document.getElementById('user-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // å¤„ç†ç”¨æˆ·è¡¨å•æäº¤
        async function handleUserFormSubmit(isEdit, userId) {
            const form = document.getElementById('user-form');
            const formData = new FormData(form);
            
            const data = {
                username: formData.get('username'),
                email: formData.get('email'),
                nickname: formData.get('nickname'),
                is_admin: formData.get('is_admin') === 'true',
                is_active: formData.get('is_active') === 'true'
            };
            
            const password = formData.get('password');
            if (password) {
                data.password = password;
            }
            
            try {
                let result;
                if (isEdit) {
                    result = await apiRequest(`/admin/users/${userId}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                } else {
                    result = await apiRequest('/admin/users', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                }
                
                if (result.code === 200) {
                    showAlert(isEdit ? 'ç”¨æˆ·æ›´æ–°æˆåŠŸ' : 'ç”¨æˆ·åˆ›å»ºæˆåŠŸ', 'success');
                    closeUserModal();
                    loadUsers(currentUserPage, currentUserSearch);
                } else {
                    showAlert((isEdit ? 'æ›´æ–°' : 'åˆ›å»º') + 'å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert((isEdit ? 'æ›´æ–°' : 'åˆ›å»º') + 'å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
        async function toggleUserStatus(userId, isActive) {
            if (!confirm(`ç¡®å®šè¦${isActive ? 'å¯ç”¨' : 'ç¦ç”¨'}æ­¤ç”¨æˆ·å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const result = await apiRequest(`/admin/users/${userId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        is_active: isActive
                    })
                });
                
                if (result.code === 200) {
                    showAlert('ç”¨æˆ·çŠ¶æ€æ›´æ–°æˆåŠŸ', 'success');
                    loadUsers(currentUserPage, currentUserSearch);
                } else {
                    showAlert('çŠ¶æ€æ›´æ–°å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('çŠ¶æ€æ›´æ–°å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(userId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç”¨æˆ·å—ï¼Ÿè¿™å°†åŒæ—¶åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰æ–‡ä»¶ï¼')) {
                return;
            }
            
            try {
                const result = await apiRequest(`/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (result.code === 200) {
                    showAlert('ç”¨æˆ·åˆ é™¤æˆåŠŸ', 'success');
                    loadUsers(currentUserPage, currentUserSearch);
                } else {
                    showAlert('åˆ é™¤å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºç”¨æˆ·æ–‡ä»¶
        async function showUserFiles(userId) {
            try {
                const result = await apiRequest(`/admin/users/${userId}/files`);
                
                if (result.code === 200) {
                    const files = result.data.files;
                    showUserFilesModal(files);
                } else {
                    showAlert('è·å–ç”¨æˆ·æ–‡ä»¶å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('è·å–ç”¨æˆ·æ–‡ä»¶å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ˜¾ç¤ºç”¨æˆ·æ–‡ä»¶æ¨¡æ€æ¡†
        function showUserFilesModal(files) {
            let filesHTML = '';
            if (files.length === 0) {
                filesHTML = '<p style="text-align: center; color: #666;">è¯¥ç”¨æˆ·è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•æ–‡ä»¶</p>';
            } else {
                filesHTML = `
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æ–‡ä»¶å</th>
                                    <th>å¤§å°</th>
                                    <th>ä¸Šä¼ æ—¶é—´</th>
                                    <th>ä¸‹è½½æ¬¡æ•°</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                files.forEach(file => {
                    const fileName = file.prefix + file.suffix;
                    filesHTML += `
                        <tr>
                            <td>${fileName}</td>
                            <td>${formatFileSize(file.size)}</td>
                            <td>${formatDate(file.created_at)}</td>
                            <td>${file.used_count}</td>
                            <td>
                                <button class="btn-sm" onclick="deleteFile('${file.code}')" style="background: #dc3545; color: white;">åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                });
                
                filesHTML += '</tbody></table></div>';
            }
            
            const modalHTML = `
                <div class="modal" id="user-files-modal">
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <div class="modal-title">ç”¨æˆ·æ–‡ä»¶åˆ—è¡¨</div>
                            <span class="close" onclick="closeUserFilesModal()">&times;</span>
                        </div>
                        <div style="padding: 20px;">
                            ${filesHTML}
                        </div>
                    </div>
                </div>
            `;
            
            // ç§»é™¤ç°æœ‰æ¨¡æ€æ¡†
            const existingModal = document.getElementById('user-files-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = document.getElementById('user-files-modal');
            modal.style.display = 'block';
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­æ¨¡æ€æ¡†
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeUserFilesModal();
                }
            });
        }
        
        // å…³é—­ç”¨æˆ·æ–‡ä»¶æ¨¡æ€æ¡†
        function closeUserFilesModal() {
            const modal = document.getElementById('user-files-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // ========== MCP æœåŠ¡å™¨ç®¡ç†åŠŸèƒ½ ==========
        
        // åŠ è½½ MCP é…ç½®
        async function loadMCPConfig() {
            try {
                const result = await apiRequest('/admin/mcp/config');
                
                if (result.code === 200) {
                    const config = result.data;
                    
                    // æ›´æ–°è¡¨å•å­—æ®µ
                    document.getElementById('enable_mcp_server').checked = config.enable_mcp_server === 1;
                    document.getElementById('mcp_port').value = config.mcp_port || '8081';
                    document.getElementById('mcp_host').value = config.mcp_host || '0.0.0.0';
                    
                    // æ›´æ–°ç«¯å£æ˜¾ç¤º
                    document.getElementById('mcp-port-display').textContent = config.mcp_port || '8081';
                    
                    // åˆ‡æ¢é…ç½®è¯¦æƒ…æ˜¾ç¤º
                    toggleMCPConfigDetails();
                } else {
                    showAlert('åŠ è½½ MCP é…ç½®å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('åŠ è½½ MCP é…ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åŠ è½½ MCP çŠ¶æ€
        async function loadMCPStatus() {
            try {
                const result = await apiRequest('/admin/mcp/status');
                
                if (result.code === 200) {
                    const status = result.data;
                    updateMCPStatusDisplay(status);
                } else {
                    showMCPError('è·å–çŠ¶æ€å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                showMCPError('è·å–çŠ¶æ€å¤±è´¥: ' + error.message);
            }
        }
        
        // æ›´æ–° MCP çŠ¶æ€æ˜¾ç¤º
        function updateMCPStatusDisplay(status) {
            const icon = document.getElementById('mcp-status-icon');
            const title = document.getElementById('mcp-status-title');
            const desc = document.getElementById('mcp-status-desc');
            const toggleBtn = document.getElementById('mcp-toggle-btn');
            const restartBtn = document.getElementById('mcp-restart-btn');
            
            if (status.running) {
                // æœåŠ¡å™¨è¿è¡Œä¸­
                icon.style.background = '#28a745';
                icon.style.color = 'white';
                icon.textContent = 'âœ…';
                
                title.textContent = 'MCP æœåŠ¡å™¨è¿è¡Œä¸­';
                desc.textContent = `æœåŠ¡å™¨æ­£åœ¨ç«¯å£ ${status.port || '8081'} ä¸Šè¿è¡Œ`;
                
                toggleBtn.textContent = 'åœæ­¢æœåŠ¡å™¨';
                toggleBtn.className = 'btn btn-danger';
                toggleBtn.disabled = false;
                
                restartBtn.disabled = false;
            } else {
                // æœåŠ¡å™¨å·²åœæ­¢
                icon.style.background = '#6c757d';
                icon.style.color = 'white';
                icon.textContent = 'â¸ï¸';
                
                title.textContent = 'MCP æœåŠ¡å™¨å·²åœæ­¢';
                
                if (status.config && status.config.enabled) {
                    desc.textContent = 'æœåŠ¡å™¨å·²å¯ç”¨ä½†æœªè¿è¡Œï¼Œç‚¹å‡»å¯åŠ¨æŒ‰é’®å¼€å§‹æœåŠ¡';
                    toggleBtn.textContent = 'å¯åŠ¨æœåŠ¡å™¨';
                    toggleBtn.className = 'btn btn-success';
                    toggleBtn.disabled = false;
                } else {
                    desc.textContent = 'æœåŠ¡å™¨æœªå¯ç”¨ï¼Œè¯·å…ˆåœ¨é…ç½®ä¸­å¯ç”¨MCPæœåŠ¡å™¨';
                    toggleBtn.textContent = 'å¯åŠ¨æœåŠ¡å™¨';
                    toggleBtn.className = 'btn btn-secondary';
                    toggleBtn.disabled = true;
                }
                
                restartBtn.disabled = true;
            }
        }
        
        // æ˜¾ç¤º MCP é”™è¯¯çŠ¶æ€
        function showMCPError(errorMessage) {
            const icon = document.getElementById('mcp-status-icon');
            const title = document.getElementById('mcp-status-title');
            const desc = document.getElementById('mcp-status-desc');
            const toggleBtn = document.getElementById('mcp-toggle-btn');
            const restartBtn = document.getElementById('mcp-restart-btn');
            
            icon.style.background = '#dc3545';
            icon.style.color = 'white';
            icon.textContent = 'âŒ';
            
            title.textContent = 'MCP æœåŠ¡å™¨çŠ¶æ€å¼‚å¸¸';
            desc.textContent = errorMessage;
            
            toggleBtn.disabled = true;
            restartBtn.disabled = true;
        }
        
        // åˆ‡æ¢ MCP é…ç½®è¯¦æƒ…æ˜¾ç¤º
        function toggleMCPConfigDetails() {
            const checkbox = document.getElementById('enable_mcp_server');
            const details = document.getElementById('mcp-config-details');
            
            if (checkbox.checked) {
                details.style.display = 'block';
            } else {
                details.style.display = 'none';
            }
        }
        
        // åˆ‡æ¢ MCP æœåŠ¡å™¨
        async function toggleMCPServer() {
            const toggleBtn = document.getElementById('mcp-toggle-btn');
            const isRunning = toggleBtn.textContent.includes('åœæ­¢');
            
            const originalText = toggleBtn.textContent;
            toggleBtn.textContent = isRunning ? 'åœæ­¢ä¸­...' : 'å¯åŠ¨ä¸­...';
            toggleBtn.disabled = true;
            
            try {
                const action = isRunning ? 'stop' : 'start';
                const result = await apiRequest('/admin/mcp/control', {
                    method: 'POST',
                    body: JSON.stringify({ action: action })
                });
                
                if (result.code === 200) {
                    showAlert(result.message, 'success');
                    // å»¶è¿Ÿä¸€ç§’ååˆ·æ–°çŠ¶æ€
                    setTimeout(() => {
                        loadMCPStatus();
                    }, 1000);
                } else {
                    showAlert(result.message, 'error');
                    toggleBtn.textContent = originalText;
                    toggleBtn.disabled = false;
                }
            } catch (error) {
                showAlert('æ“ä½œå¤±è´¥: ' + error.message, 'error');
                toggleBtn.textContent = originalText;
                toggleBtn.disabled = false;
            }
        }
        
        // é‡å¯ MCP æœåŠ¡å™¨
        async function restartMCPServer() {
            const restartBtn = document.getElementById('mcp-restart-btn');
            const originalText = restartBtn.textContent;
            
            restartBtn.textContent = 'é‡å¯ä¸­...';
            restartBtn.disabled = true;
            
            try {
                const result = await apiRequest('/admin/mcp/restart', {
                    method: 'POST'
                });
                
                if (result.code === 200) {
                    showAlert(result.message, 'success');
                    // å»¶è¿Ÿä¸€ç§’ååˆ·æ–°çŠ¶æ€
                    setTimeout(() => {
                        loadMCPStatus();
                    }, 1000);
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('é‡å¯å¤±è´¥: ' + error.message, 'error');
            } finally {
                restartBtn.textContent = originalText;
                restartBtn.disabled = false;
            }
        }
        
        // åˆå§‹åŒ– MCP ç›¸å…³äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // ç›‘å¬ MCP å¯ç”¨çŠ¶æ€å˜åŒ–
            const enableMCPCheckbox = document.getElementById('enable_mcp_server');
            if (enableMCPCheckbox) {
                enableMCPCheckbox.addEventListener('change', toggleMCPConfigDetails);
            }
            
            // MCP é…ç½®è¡¨å•æäº¤
            const mcpConfigForm = document.getElementById('mcp-config-form');
            if (mcpConfigForm) {
                mcpConfigForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const saveBtn = document.getElementById('save-mcp-config-btn');
                    const originalText = saveBtn.textContent;
                    
                    saveBtn.textContent = 'ä¿å­˜ä¸­...';
                    saveBtn.disabled = true;
                    
                    try {
                        const config = {
                            enable_mcp_server: document.getElementById('enable_mcp_server').checked ? 1 : 0,
                            mcp_port: document.getElementById('mcp_port').value.trim() || '8081',
                            mcp_host: document.getElementById('mcp_host').value.trim() || '0.0.0.0'
                        };
                        
                        const result = await apiRequest('/admin/mcp/config', {
                            method: 'PUT',
                            body: JSON.stringify(config)
                        });
                        
                        if (result.code === 200) {
                            showAlert('MCP é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                            
                            // æ›´æ–°ç«¯å£æ˜¾ç¤º
                            document.getElementById('mcp-port-display').textContent = config.mcp_port;
                            
                            // å»¶è¿Ÿä¸€ç§’ååˆ·æ–°çŠ¶æ€
                            setTimeout(() => {
                                loadMCPStatus();
                            }, 1000);
                        } else {
                            showAlert('ä¿å­˜å¤±è´¥: ' + result.message, 'error');
                        }
                    } catch (error) {
                        showAlert('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                    } finally {
                        saveBtn.textContent = originalText;
                        saveBtn.disabled = false;
                    }
                });
            }
        });
    </script>
</body>
</html>
