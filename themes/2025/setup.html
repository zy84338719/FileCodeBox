<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统初始化 - FileCodeBox</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/logo-small.svg">
    
    <!-- 引入统一的设计系统CSS -->
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/auth.css">
    
    <style>
        /* Setup页面特有的样式扩展 */
        .auth-card {
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .setup-steps {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }
        
        .setup-step {
            display: none;
        }
        
        .setup-step.active {
            display: block;
        }
        
        .step-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .step-number {
            width: 32px;
            height: 32px;
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .step-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text-primary);
        }
        
        .step-description {
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-lg);
            line-height: 1.6;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }
        
        .password-toggle-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: var(--radius-xs);
            transition: all 0.2s ease;
        }
        
        .password-toggle-btn:hover {
            color: var(--color-primary);
            background: var(--color-background-hover);
        }
        
        .form-group.password-field {
            position: relative;
        }
        
        .form-group.password-field input {
            padding-right: 40px;
        }
        
        .setup-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: space-between;
            margin-top: var(--spacing-xl);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--color-border);
        }
        
        .btn-secondary {
            background: var(--color-background);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
            padding: 12px 24px;
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            background: var(--color-background-hover);
            border-color: var(--color-primary);
        }
        
        .progress-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-lg);
        }
        
        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-border);
            transition: all 0.3s ease;
        }
        
        .progress-dot.active {
            background: var(--color-primary);
            transform: scale(1.2);
        }
        
        .progress-dot.completed {
            background: var(--color-success);
        }
        
        .db-config {
            display: none;
        }
        
        .db-config.active {
            display: block;
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .setup-actions {
                flex-direction: column;
            }
            
            .auth-card {
                max-height: 95vh;
            }
        }
    </style>
</head>
<body class="auth-page">
    <div class="auth-wrapper">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-logo">
                    <img class="auth-logo-icon" src="/assets/images/logo.svg" alt="FileCodeBox Logo"/>
                    <div class="auth-logo-text">FileCodeBox</div>
                </div>
                <div class="auth-title">系统初始化</div>
                <div class="auth-subtitle">欢迎使用 FileCodeBox，让我们完成初始配置</div>
            </div>

            <div class="auth-form">
                <div class="progress-indicator">
                    <div class="progress-dot active" data-step="1"></div>
                    <div class="progress-dot" data-step="2"></div>
                    <div class="progress-dot" data-step="3"></div>
                </div>

                <div id="alert" class="auth-message"></div>

                <form id="setupForm" class="setup-steps">
                    <!-- 步骤1: 数据库配置 -->
                    <div class="setup-step active" id="step1">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <div class="step-title">数据库配置</div>
                        </div>
                        <div class="step-description">
                            选择数据库类型并配置连接信息。SQLite适合小型部署，MySQL/PostgreSQL适合生产环境。
                        </div>

                        <div class="form-group">
                            <label for="dbType">数据库类型</label>
                            <select id="dbType" name="db_type" class="form-control" required>
                                <option value="sqlite">SQLite (推荐)</option>
                                <option value="mysql">MySQL</option>
                                <option value="postgres">PostgreSQL</option>
                            </select>
                        </div>

                        <div id="dbConfig" class="db-config"></div>

                        <div class="setup-actions">
                            <div></div>
                            <button type="button" class="auth-btn" onclick="nextStep(2)">下一步</button>
                        </div>
                    </div>

                    <!-- 步骤2: 管理员配置 -->
                    <div class="setup-step" id="step2">
                        <div class="step-header">
                            <div class="step-number">2</div>
                            <div class="step-title">管理员账户</div>
                        </div>
                        <div class="step-description">
                            创建系统管理员账户，用于管理系统配置和用户。
                        </div>

                        <div class="form-group hidden">
                            <label for="adminToken">管理员令牌（已移除）</label>
                            <input type="text" id="adminToken" name="password" class="form-control" 
                                   placeholder="该字段已移除，管理员请使用用户名和密码登录" disabled>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="adminUsername">管理员用户名</label>
                                <input type="text" id="adminUsername" name="username" class="form-control" 
                                       placeholder="管理员用户名（至少3个字符）" required>
                            </div>
                            <div class="form-group">
                                <label for="adminEmail">管理员邮箱</label>
                                <input type="email" id="adminEmail" name="email" class="form-control" 
                                       placeholder="admin@localhost" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group password-field">
                                <label for="adminPassword">管理员密码</label>
                                <input type="password" id="adminPassword" name="password" class="form-control" 
                                       placeholder="管理员登录密码（至少6个字符）" required>
                                <button type="button" class="password-toggle-btn" onclick="togglePassword('adminPassword')">
                                    <span id="adminPasswordToggle">👁️</span>
                                </button>
                            </div>
                            <div class="form-group password-field">
                                <label for="adminPasswordConfirm">确认密码</label>
                                <input type="password" id="adminPasswordConfirm" name="password_confirm" class="form-control" 
                                       placeholder="再次输入密码" required>
                                <button type="button" class="password-toggle-btn" onclick="togglePassword('adminPasswordConfirm')">
                                    <span id="adminPasswordConfirmToggle">👁️</span>
                                </button>
                            </div>
                        </div>

                        <div class="setup-actions">
                            <button type="button" class="btn-secondary" onclick="prevStep(1)">上一步</button>
                            <button type="button" class="auth-btn" onclick="nextStep(3)">下一步</button>
                        </div>
                    </div>

                    <!-- 步骤3: 基础设置 -->
                    <div class="setup-step" id="step3">
                        <div class="step-header">
                            <div class="step-number">3</div>
                            <div class="step-title">基础设置</div>
                        </div>
                        <div class="step-description">
                            配置系统的基本参数和存储设置。
                        </div>

                        <div class="form-group">
                            <label for="siteName">站点名称</label>
                            <input type="text" id="siteName" name="site_name" class="form-control" 
                                   value="FileCodeBox" placeholder="显示在页面上的站点名称">
                        </div>

                        <div class="form-group">
                            <label for="maxFileSize">最大文件大小 (MB)</label>
                            <input type="number" id="maxFileSize" name="max_file_size" class="form-control" 
                                   value="100" min="1" max="1024">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="storageType">存储类型</label>
                                <select id="storageType" name="storage_type" class="form-control">
                                    <option value="local">本地存储</option>
                                    <option value="s3">Amazon S3</option>
                                    <option value="webdav">WebDAV</option>
                                    <option value="onedrive">OneDrive</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="enableUserSystem">用户系统</label>
                                <select id="enableUserSystem" name="enable_user_system" class="form-control">
                                    <option value="false">禁用</option>
                                    <option value="true">启用</option>
                                </select>
                            </div>
                        </div>

                        <div id="localStorageConfig" class="form-group hidden">
                            <label for="localStoragePath">本地存储路径</label>
                            <input type="text" id="localStoragePath" name="storage_path" class="form-control" placeholder="例如: ./uploads 或 /var/lib/filecodebox/uploads">
                            <div class="form-help">如果使用本地存储，请指定一个目录用于保存文件。</div>
                        </div>

                        <div class="setup-actions">
                            <button type="button" class="btn-secondary" onclick="prevStep(2)">上一步</button>
                            <button type="submit" class="auth-btn" id="setupBtn">完成设置</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        const totalSteps = 3;

        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
            setupEventListeners();
        });

        function initializeForm() {
            // 初始化数据库配置选择
            const dbTypeSelect = document.getElementById('dbType');
            updateDatabaseConfig(dbTypeSelect.value);
            
            // 设置表单提交处理
            document.getElementById('setupForm').addEventListener('submit', handleSetup);
            // 存储类型变更显示本地存储配置
            const storageType = document.getElementById('storageType');
            storageType && storageType.addEventListener('change', function() {
                const localCfg = document.getElementById('localStorageConfig');
                if (this.value === 'local') {
                    localCfg.classList.remove('hidden');
                } else {
                    localCfg.classList.add('hidden');
                }
            });
            // 页面初次加载时，根据当前选择的 storageType 设置本地存储配置的可见性（修复未切换时不显示的问题）
            if (storageType) {
                const localCfg = document.getElementById('localStorageConfig');
                if (storageType.value === 'local') {
                    localCfg.classList.remove('hidden');
                } else {
                    localCfg.classList.add('hidden');
                }
            }
        }

        function setupEventListeners() {
            const dbTypeSelect = document.getElementById('dbType');
            dbTypeSelect.addEventListener('change', function() {
                updateDatabaseConfig(this.value);
            });
        }

        function updateDatabaseConfig(dbType) {
            const dbConfig = document.getElementById('dbConfig');
            
            let configHTML = '';
            
            if (dbType === 'mysql') {
                configHTML = `
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dbHost">数据库地址</label>
                            <input type="text" id="dbHost" name="db_host" class="form-control" 
                                   value="localhost" placeholder="数据库服务器地址" required>
                        </div>
                        <div class="form-group">
                            <label for="dbPort">端口</label>
                            <input type="number" id="dbPort" name="db_port" class="form-control" 
                                   value="3306" placeholder="数据库端口" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dbName">数据库名</label>
                            <input type="text" id="dbName" name="db_name" class="form-control" 
                                   value="filecodebox" placeholder="数据库名称" required>
                        </div>
                        <div class="form-group">
                            <label for="dbUser">用户名</label>
                            <input type="text" id="dbUser" name="db_user" class="form-control" 
                                   placeholder="数据库用户名" required>
                        </div>
                    </div>
                    <div class="form-group password-field">
                        <label for="dbPassword">密码</label>
                        <input type="password" id="dbPassword" name="db_password" class="form-control" 
                               placeholder="数据库密码" required>
                        <button type="button" class="password-toggle-btn" onclick="togglePassword('dbPassword')">
                            <span id="dbPasswordToggle">👁️</span>
                        </button>
                    </div>
                `;
            } else if (dbType === 'postgres') {
                configHTML = `
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dbHost">数据库地址</label>
                            <input type="text" id="dbHost" name="db_host" class="form-control" 
                                   value="localhost" placeholder="数据库服务器地址" required>
                        </div>
                        <div class="form-group">
                            <label for="dbPort">端口</label>
                            <input type="number" id="dbPort" name="db_port" class="form-control" 
                                   value="5432" placeholder="数据库端口" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dbName">数据库名</label>
                            <input type="text" id="dbName" name="db_name" class="form-control" 
                                   value="filecodebox" placeholder="数据库名称" required>
                        </div>
                        <div class="form-group">
                            <label for="dbUser">用户名</label>
                            <input type="text" id="dbUser" name="db_user" class="form-control" 
                                   placeholder="数据库用户名" required>
                        </div>
                    </div>
                    <div class="form-group password-field">
                        <label for="dbPassword">密码</label>
                        <input type="password" id="dbPassword" name="db_password" class="form-control" 
                               placeholder="数据库密码" required>
                        <button type="button" class="password-toggle-btn" onclick="togglePassword('dbPassword')">
                            <span id="dbPasswordToggle">👁️</span>
                        </button>
                    </div>
                `;
            } else {
                // SQLite
                configHTML = `
                    <div class="form-group">
                        <label for="dbPath">数据库文件路径</label>
                        <input type="text" id="dbPath" name="db_path" class="form-control" 
                               value="./data/filecodebox.db" placeholder="SQLite数据库文件路径">
                    </div>
                `;
            }
            
            dbConfig.innerHTML = configHTML;
            dbConfig.className = 'db-config active';
        }

        function nextStep(step) {
            if (validateCurrentStep()) {
                showStep(step);
            }
        }

        function prevStep(step) {
            showStep(step);
        }

        function showStep(step) {
            // 隐藏所有步骤
            for (let i = 1; i <= totalSteps; i++) {
                const stepElement = document.getElementById(`step${i}`);
                const dotElement = document.querySelector(`[data-step="${i}"]`);
                
                stepElement.classList.remove('active');
                dotElement.classList.remove('active', 'completed');
                
                if (i < step) {
                    dotElement.classList.add('completed');
                } else if (i === step) {
                    dotElement.classList.add('active');
                }
            }
            
            // 显示当前步骤
            document.getElementById(`step${step}`).classList.add('active');
            currentStep = step;
        }

        function validateCurrentStep() {
            const currentStepElement = document.getElementById(`step${currentStep}`);
            const requiredFields = currentStepElement.querySelectorAll('input[required], select[required]');
            
            for (let field of requiredFields) {
                if (!field.value.trim()) {
                    showAlert(`请填写 ${field.previousElementSibling.textContent}`, 'error');
                    field.focus();
                    return false;
                }
            }
            
            return true;
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const toggle = document.getElementById(inputId + 'Toggle');
            
            if (input.type === 'password') {
                input.type = 'text';
                toggle.textContent = '🙈';
            } else {
                input.type = 'password';
                toggle.textContent = '👁️';
            }
        }

        async function handleSetup(e) {
            e.preventDefault();
            
            if (!validateCurrentStep()) {
                return;
            }
            
            const setupBtn = document.getElementById('setupBtn');
            setupBtn.classList.add('loading');
            setupBtn.disabled = true;
            
                try {
                const formData = new FormData(e.target);
                const flat = Object.fromEntries(formData.entries());

                // 密码确认校验（使用去除 admin_ 前缀的字段）
                if (flat.password && flat.password_confirm) {
                    if (flat.password !== flat.password_confirm) {
                        showAlert('两次输入的管理员密码不一致', 'error');
                        return;
                    }
                    if (flat.password.length < 6) {
                        showAlert('管理员密码长度至少6个字符', 'error');
                        return;
                    }
                }

                // 如果使用本地存储，确保 storage_path 字段存在
                if (flat.storage_type === 'local') {
                    if (!flat.storage_path || flat.storage_path.trim() === '') {
                        showAlert('请选择本地存储路径', 'error');
                        return;
                    }
                }

                // 构建嵌套的 payload（后端现在只接受嵌套 JSON）
                const payload = { database: {}, admin: {} };
                const dbType = flat.db_type || document.getElementById('dbType').value || 'sqlite';
                payload.database.type = dbType;

                if (dbType === 'sqlite') {
                    payload.database.file = flat.db_path || flat.dbPath || './data/filecodebox.db';
                } else {
                    // mysql / postgres
                    payload.database.host = flat.db_host || flat.dbHost || '';
                    payload.database.port = flat.db_port ? parseInt(flat.db_port, 10) : (dbType === 'mysql' ? 3306 : 5432);
                    payload.database.user = flat.db_user || flat.dbUser || '';
                    payload.database.password = flat.db_password || flat.dbPassword || '';
                    payload.database.database = flat.db_name || flat.dbName || 'filecodebox';
                }

                payload.admin.username = flat.username || '';
                payload.admin.email = flat.email || '';
                payload.admin.password = flat.password || '';
                payload.admin.confirm = flat.password_confirm || '';
                payload.admin.nickname = flat.nickname || payload.admin.username;
                // allowUserRegistration: convert 'true'/'false' strings to booleans
                if (typeof flat.enable_user_system === 'string') {
                    payload.admin.allowUserRegistration = (flat.enable_user_system === 'true');
                } else if (typeof flat.enable_user_system === 'boolean') {
                    payload.admin.allowUserRegistration = flat.enable_user_system;
                } else if (typeof flat.enable_user_registration === 'string') {
                    payload.admin.allowUserRegistration = (flat.enable_user_registration === 'true');
                }

                const response = await fetch('/setup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (data.code === 200) {
                    showAlert('系统初始化完成！正在跳转...', 'success');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    showAlert(data.message || '初始化失败，请重试', 'error');
                }
            } catch (error) {
                console.error('初始化失败:', error);
                showAlert('初始化失败，请检查网络连接', 'error');
            } finally {
                setupBtn.classList.remove('loading');
                setupBtn.disabled = false;
            }
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `auth-message ${type}`;
            alert.style.display = 'block';
            
            // 自动隐藏成功消息
            if (type === 'success') {
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 3000);
            }
        }
    </script>
</body>
</html>