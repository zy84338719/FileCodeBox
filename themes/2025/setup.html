<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿåˆå§‹åŒ– - FileCodeBox</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/logo-small.svg">
    
    <!-- å¼•å…¥ç»Ÿä¸€çš„è®¾è®¡ç³»ç»ŸCSS -->
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/auth.css">
    
    <style>
        /* Setupé¡µé¢ç‰¹æœ‰çš„æ ·å¼æ‰©å±• */
        .auth-card {
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .setup-steps {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }
        
        .setup-step {
            display: none;
        }
        
        .setup-step.active {
            display: block;
        }
        
        .step-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .step-number {
            width: 32px;
            height: 32px;
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .step-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text-primary);
        }
        
        .step-description {
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-lg);
            line-height: 1.6;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }
        
        .password-toggle-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: var(--radius-xs);
            transition: all 0.2s ease;
        }
        
        .password-toggle-btn:hover {
            color: var(--color-primary);
            background: var(--color-background-hover);
        }
        
        .form-group.password-field {
            position: relative;
        }
        
        .form-group.password-field input {
            padding-right: 40px;
        }
        
        .setup-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: space-between;
            margin-top: var(--spacing-xl);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--color-border);
        }
        
        .btn-secondary {
            background: var(--color-background);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
            padding: 12px 24px;
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            background: var(--color-background-hover);
            border-color: var(--color-primary);
        }
        
        .progress-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-lg);
        }
        
        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-border);
            transition: all 0.3s ease;
        }
        
        .progress-dot.active {
            background: var(--color-primary);
            transform: scale(1.2);
        }
        
        .progress-dot.completed {
            background: var(--color-success);
        }
        
        .db-config {
            display: none;
        }
        
        .db-config.active {
            display: block;
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .setup-actions {
                flex-direction: column;
            }
            
            .auth-card {
                max-height: 95vh;
            }
        }
    </style>
</head>
<body class="auth-page">
    <div class="auth-wrapper">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-logo">
                    <img class="auth-logo-icon" src="/assets/images/logo.svg" alt="FileCodeBox Logo"/>
                    <div class="auth-logo-text">FileCodeBox</div>
                </div>
                <div class="auth-title">ç³»ç»Ÿåˆå§‹åŒ–</div>
                <div class="auth-subtitle">æ¬¢è¿ä½¿ç”¨ FileCodeBoxï¼Œè®©æˆ‘ä»¬å®Œæˆåˆå§‹é…ç½®</div>
            </div>

            <div class="auth-form">
                <div class="progress-indicator">
                    <div class="progress-dot active" data-step="1"></div>
                    <div class="progress-dot" data-step="2"></div>
                    <div class="progress-dot" data-step="3"></div>
                </div>

                <div id="alert" class="auth-message"></div>

                <form id="setupForm" class="setup-steps">
                    <!-- æ­¥éª¤1: æ•°æ®åº“é…ç½® -->
                    <div class="setup-step active" id="step1">
                        <div class="step-header">
                            <div class="step-number">1</div>
                            <div class="step-title">æ•°æ®åº“é…ç½®</div>
                        </div>
                        <div class="step-description">
                            é€‰æ‹©æ•°æ®åº“ç±»å‹å¹¶é…ç½®è¿æ¥ä¿¡æ¯ã€‚SQLiteé€‚åˆå°å‹éƒ¨ç½²ï¼ŒMySQL/PostgreSQLé€‚åˆç”Ÿäº§ç¯å¢ƒã€‚
                        </div>

                        <div class="form-group">
                            <label for="dbType">æ•°æ®åº“ç±»å‹</label>
                            <select id="dbType" name="db_type" class="form-control" required>
                                <option value="sqlite">SQLite (æ¨è)</option>
                                <option value="mysql">MySQL</option>
                                <option value="postgres">PostgreSQL</option>
                            </select>
                        </div>

                        <div id="dbConfig" class="db-config"></div>

                        <div class="setup-actions">
                            <div></div>
                            <button type="button" class="auth-btn" onclick="nextStep(2)">ä¸‹ä¸€æ­¥</button>
                        </div>
                    </div>

                    <!-- æ­¥éª¤2: ç®¡ç†å‘˜é…ç½® -->
                    <div class="setup-step" id="step2">
                        <div class="step-header">
                            <div class="step-number">2</div>
                            <div class="step-title">ç®¡ç†å‘˜è´¦æˆ·</div>
                        </div>
                        <div class="step-description">
                            åˆ›å»ºç³»ç»Ÿç®¡ç†å‘˜è´¦æˆ·ï¼Œç”¨äºç®¡ç†ç³»ç»Ÿé…ç½®å’Œç”¨æˆ·ã€‚
                        </div>

                        <div class="form-group hidden">
                            <label for="adminToken">ç®¡ç†å‘˜ä»¤ç‰Œï¼ˆå·²ç§»é™¤ï¼‰</label>
                            <input type="text" id="adminToken" name="password" class="form-control" 
                                   placeholder="è¯¥å­—æ®µå·²ç§»é™¤ï¼Œç®¡ç†å‘˜è¯·ä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç ç™»å½•" disabled>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="adminUsername">ç®¡ç†å‘˜ç”¨æˆ·å</label>
                                <input type="text" id="adminUsername" name="username" class="form-control" 
                                       placeholder="ç®¡ç†å‘˜ç”¨æˆ·åï¼ˆè‡³å°‘3ä¸ªå­—ç¬¦ï¼‰" required>
                            </div>
                            <div class="form-group">
                                <label for="adminEmail">ç®¡ç†å‘˜é‚®ç®±</label>
                                <input type="email" id="adminEmail" name="email" class="form-control" 
                                       placeholder="admin@localhost" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group password-field">
                                <label for="adminPassword">ç®¡ç†å‘˜å¯†ç </label>
                                <input type="password" id="adminPassword" name="password" class="form-control" 
                                       placeholder="ç®¡ç†å‘˜ç™»å½•å¯†ç ï¼ˆè‡³å°‘6ä¸ªå­—ç¬¦ï¼‰" required>
                                <button type="button" class="password-toggle-btn" onclick="togglePassword('adminPassword')">
                                    <span id="adminPasswordToggle">ğŸ‘ï¸</span>
                                </button>
                            </div>
                            <div class="form-group password-field">
                                <label for="adminPasswordConfirm">ç¡®è®¤å¯†ç </label>
                                <input type="password" id="adminPasswordConfirm" name="password_confirm" class="form-control" 
                                       placeholder="å†æ¬¡è¾“å…¥å¯†ç " required>
                                <button type="button" class="password-toggle-btn" onclick="togglePassword('adminPasswordConfirm')">
                                    <span id="adminPasswordConfirmToggle">ğŸ‘ï¸</span>
                                </button>
                            </div>
                        </div>

                        <div class="setup-actions">
                            <button type="button" class="btn-secondary" onclick="prevStep(1)">ä¸Šä¸€æ­¥</button>
                            <button type="button" class="auth-btn" onclick="nextStep(3)">ä¸‹ä¸€æ­¥</button>
                        </div>
                    </div>

                    <!-- æ­¥éª¤3: åŸºç¡€è®¾ç½® -->
                    <div class="setup-step" id="step3">
                        <div class="step-header">
                            <div class="step-number">3</div>
                            <div class="step-title">åŸºç¡€è®¾ç½®</div>
                        </div>
                        <div class="step-description">
                            é…ç½®ç³»ç»Ÿçš„åŸºæœ¬å‚æ•°å’Œå­˜å‚¨è®¾ç½®ã€‚
                        </div>

                        <div class="form-group">
                            <label for="siteName">ç«™ç‚¹åç§°</label>
                            <input type="text" id="siteName" name="site_name" class="form-control" 
                                   value="FileCodeBox" placeholder="æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šçš„ç«™ç‚¹åç§°">
                        </div>

                        <div class="form-group">
                            <label for="maxFileSize">æœ€å¤§æ–‡ä»¶å¤§å° (MB)</label>
                            <input type="number" id="maxFileSize" name="max_file_size" class="form-control" 
                                   value="100" min="1" max="1024">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="storageType">å­˜å‚¨ç±»å‹</label>
                                <select id="storageType" name="storage_type" class="form-control">
                                    <option value="local">æœ¬åœ°å­˜å‚¨</option>
                                    <option value="s3">Amazon S3</option>
                                    <option value="webdav">WebDAV</option>
                                    <option value="onedrive">OneDrive</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="enableUserSystem">ç”¨æˆ·ç³»ç»Ÿ</label>
                                <select id="enableUserSystem" name="enable_user_system" class="form-control">
                                    <option value="false">ç¦ç”¨</option>
                                    <option value="true">å¯ç”¨</option>
                                </select>
                            </div>
                        </div>

                        <div id="localStorageConfig" class="form-group hidden">
                            <label for="localStoragePath">æœ¬åœ°å­˜å‚¨è·¯å¾„</label>
                            <input type="text" id="localStoragePath" name="storage_path" class="form-control" placeholder="ä¾‹å¦‚: ./uploads æˆ– /var/lib/filecodebox/uploads">
                            <div class="form-help">å¦‚æœä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼Œè¯·æŒ‡å®šä¸€ä¸ªç›®å½•ç”¨äºä¿å­˜æ–‡ä»¶ã€‚</div>
                        </div>

                        <div class="setup-actions">
                            <button type="button" class="btn-secondary" onclick="prevStep(2)">ä¸Šä¸€æ­¥</button>
                            <button type="submit" class="auth-btn" id="setupBtn">å®Œæˆè®¾ç½®</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        const totalSteps = 3;

        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
            setupEventListeners();
        });

        function initializeForm() {
            // åˆå§‹åŒ–æ•°æ®åº“é…ç½®é€‰æ‹©
            const dbTypeSelect = document.getElementById('dbType');
            updateDatabaseConfig(dbTypeSelect.value);
            
            // è®¾ç½®è¡¨å•æäº¤å¤„ç†
            document.getElementById('setupForm').addEventListener('submit', handleSetup);
            // å­˜å‚¨ç±»å‹å˜æ›´æ˜¾ç¤ºæœ¬åœ°å­˜å‚¨é…ç½®
            const storageType = document.getElementById('storageType');
            storageType && storageType.addEventListener('change', function() {
                const localCfg = document.getElementById('localStorageConfig');
                if (this.value === 'local') {
                    localCfg.classList.remove('hidden');
                } else {
                    localCfg.classList.add('hidden');
                }
            });
            // é¡µé¢åˆæ¬¡åŠ è½½æ—¶ï¼Œæ ¹æ®å½“å‰é€‰æ‹©çš„ storageType è®¾ç½®æœ¬åœ°å­˜å‚¨é…ç½®çš„å¯è§æ€§ï¼ˆä¿®å¤æœªåˆ‡æ¢æ—¶ä¸æ˜¾ç¤ºçš„é—®é¢˜ï¼‰
            if (storageType) {
                const localCfg = document.getElementById('localStorageConfig');
                if (storageType.value === 'local') {
                    localCfg.classList.remove('hidden');
                } else {
                    localCfg.classList.add('hidden');
                }
            }
        }

        function setupEventListeners() {
            const dbTypeSelect = document.getElementById('dbType');
            dbTypeSelect.addEventListener('change', function() {
                updateDatabaseConfig(this.value);
            });
        }

        function updateDatabaseConfig(dbType) {
            const dbConfig = document.getElementById('dbConfig');
            
            let configHTML = '';
            
            if (dbType === 'mysql') {
                configHTML = `
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dbHost">æ•°æ®åº“åœ°å€</label>
                            <input type="text" id="dbHost" name="db_host" class="form-control" 
                                   value="localhost" placeholder="æ•°æ®åº“æœåŠ¡å™¨åœ°å€" required>
                        </div>
                        <div class="form-group">
                            <label for="dbPort">ç«¯å£</label>
                            <input type="number" id="dbPort" name="db_port" class="form-control" 
                                   value="3306" placeholder="æ•°æ®åº“ç«¯å£" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dbName">æ•°æ®åº“å</label>
                            <input type="text" id="dbName" name="db_name" class="form-control" 
                                   value="filecodebox" placeholder="æ•°æ®åº“åç§°" required>
                        </div>
                        <div class="form-group">
                            <label for="dbUser">ç”¨æˆ·å</label>
                            <input type="text" id="dbUser" name="db_user" class="form-control" 
                                   placeholder="æ•°æ®åº“ç”¨æˆ·å" required>
                        </div>
                    </div>
                    <div class="form-group password-field">
                        <label for="dbPassword">å¯†ç </label>
                        <input type="password" id="dbPassword" name="db_password" class="form-control" 
                               placeholder="æ•°æ®åº“å¯†ç " required>
                        <button type="button" class="password-toggle-btn" onclick="togglePassword('dbPassword')">
                            <span id="dbPasswordToggle">ğŸ‘ï¸</span>
                        </button>
                    </div>
                `;
            } else if (dbType === 'postgres') {
                configHTML = `
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dbHost">æ•°æ®åº“åœ°å€</label>
                            <input type="text" id="dbHost" name="db_host" class="form-control" 
                                   value="localhost" placeholder="æ•°æ®åº“æœåŠ¡å™¨åœ°å€" required>
                        </div>
                        <div class="form-group">
                            <label for="dbPort">ç«¯å£</label>
                            <input type="number" id="dbPort" name="db_port" class="form-control" 
                                   value="5432" placeholder="æ•°æ®åº“ç«¯å£" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dbName">æ•°æ®åº“å</label>
                            <input type="text" id="dbName" name="db_name" class="form-control" 
                                   value="filecodebox" placeholder="æ•°æ®åº“åç§°" required>
                        </div>
                        <div class="form-group">
                            <label for="dbUser">ç”¨æˆ·å</label>
                            <input type="text" id="dbUser" name="db_user" class="form-control" 
                                   placeholder="æ•°æ®åº“ç”¨æˆ·å" required>
                        </div>
                    </div>
                    <div class="form-group password-field">
                        <label for="dbPassword">å¯†ç </label>
                        <input type="password" id="dbPassword" name="db_password" class="form-control" 
                               placeholder="æ•°æ®åº“å¯†ç " required>
                        <button type="button" class="password-toggle-btn" onclick="togglePassword('dbPassword')">
                            <span id="dbPasswordToggle">ğŸ‘ï¸</span>
                        </button>
                    </div>
                `;
            } else {
                // SQLite
                configHTML = `
                    <div class="form-group">
                        <label for="dbPath">æ•°æ®åº“æ–‡ä»¶è·¯å¾„</label>
                        <input type="text" id="dbPath" name="db_path" class="form-control" 
                               value="./data/filecodebox.db" placeholder="SQLiteæ•°æ®åº“æ–‡ä»¶è·¯å¾„">
                    </div>
                `;
            }
            
            dbConfig.innerHTML = configHTML;
            dbConfig.className = 'db-config active';
        }

        function nextStep(step) {
            if (validateCurrentStep()) {
                showStep(step);
            }
        }

        function prevStep(step) {
            showStep(step);
        }

        function showStep(step) {
            // éšè—æ‰€æœ‰æ­¥éª¤
            for (let i = 1; i <= totalSteps; i++) {
                const stepElement = document.getElementById(`step${i}`);
                const dotElement = document.querySelector(`[data-step="${i}"]`);
                
                stepElement.classList.remove('active');
                dotElement.classList.remove('active', 'completed');
                
                if (i < step) {
                    dotElement.classList.add('completed');
                } else if (i === step) {
                    dotElement.classList.add('active');
                }
            }
            
            // æ˜¾ç¤ºå½“å‰æ­¥éª¤
            document.getElementById(`step${step}`).classList.add('active');
            currentStep = step;
        }

        function validateCurrentStep() {
            const currentStepElement = document.getElementById(`step${currentStep}`);
            const requiredFields = currentStepElement.querySelectorAll('input[required], select[required]');
            
            for (let field of requiredFields) {
                if (!field.value.trim()) {
                    showAlert(`è¯·å¡«å†™ ${field.previousElementSibling.textContent}`, 'error');
                    field.focus();
                    return false;
                }
            }
            
            return true;
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const toggle = document.getElementById(inputId + 'Toggle');
            
            if (input.type === 'password') {
                input.type = 'text';
                toggle.textContent = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                toggle.textContent = 'ğŸ‘ï¸';
            }
        }

        async function handleSetup(e) {
            e.preventDefault();
            
            if (!validateCurrentStep()) {
                return;
            }
            
            const setupBtn = document.getElementById('setupBtn');
            setupBtn.classList.add('loading');
            setupBtn.disabled = true;
            
                try {
                const formData = new FormData(e.target);
                const flat = Object.fromEntries(formData.entries());

                // å¯†ç ç¡®è®¤æ ¡éªŒï¼ˆä½¿ç”¨å»é™¤ admin_ å‰ç¼€çš„å­—æ®µï¼‰
                if (flat.password && flat.password_confirm) {
                    if (flat.password !== flat.password_confirm) {
                        showAlert('ä¸¤æ¬¡è¾“å…¥çš„ç®¡ç†å‘˜å¯†ç ä¸ä¸€è‡´', 'error');
                        return;
                    }
                    if (flat.password.length < 6) {
                        showAlert('ç®¡ç†å‘˜å¯†ç é•¿åº¦è‡³å°‘6ä¸ªå­—ç¬¦', 'error');
                        return;
                    }
                }

                // å¦‚æœä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼Œç¡®ä¿ storage_path å­—æ®µå­˜åœ¨
                if (flat.storage_type === 'local') {
                    if (!flat.storage_path || flat.storage_path.trim() === '') {
                        showAlert('è¯·é€‰æ‹©æœ¬åœ°å­˜å‚¨è·¯å¾„', 'error');
                        return;
                    }
                }

                // æ„å»ºåµŒå¥—çš„ payloadï¼ˆåç«¯ç°åœ¨åªæ¥å—åµŒå¥— JSONï¼‰
                const payload = { database: {}, admin: {} };
                const dbType = flat.db_type || document.getElementById('dbType').value || 'sqlite';
                payload.database.type = dbType;

                if (dbType === 'sqlite') {
                    payload.database.file = flat.db_path || flat.dbPath || './data/filecodebox.db';
                } else {
                    // mysql / postgres
                    payload.database.host = flat.db_host || flat.dbHost || '';
                    payload.database.port = flat.db_port ? parseInt(flat.db_port, 10) : (dbType === 'mysql' ? 3306 : 5432);
                    payload.database.user = flat.db_user || flat.dbUser || '';
                    payload.database.password = flat.db_password || flat.dbPassword || '';
                    payload.database.database = flat.db_name || flat.dbName || 'filecodebox';
                }

                payload.admin.username = flat.username || '';
                payload.admin.email = flat.email || '';
                payload.admin.password = flat.password || '';
                payload.admin.confirm = flat.password_confirm || '';
                payload.admin.nickname = flat.nickname || payload.admin.username;
                // allowUserRegistration: convert 'true'/'false' strings to booleans
                if (typeof flat.enable_user_system === 'string') {
                    payload.admin.allowUserRegistration = (flat.enable_user_system === 'true');
                } else if (typeof flat.enable_user_system === 'boolean') {
                    payload.admin.allowUserRegistration = flat.enable_user_system;
                } else if (typeof flat.enable_user_registration === 'string') {
                    payload.admin.allowUserRegistration = (flat.enable_user_registration === 'true');
                }

                const response = await fetch('/setup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (data.code === 200) {
                    showAlert('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼æ­£åœ¨è·³è½¬...', 'success');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    showAlert(data.message || 'åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showAlert('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            } finally {
                setupBtn.classList.remove('loading');
                setupBtn.disabled = false;
            }
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `auth-message ${type}`;
            alert.style.display = 'block';
            
            // è‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 3000);
            }
        }
    </script>
</body>
</html>