<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{title}}</title>
    <meta name="description" content="{{description}}">
    <meta name="keywords" content="{{keywords}}">
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/images/logo-small.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: {{opacity}};
            background-image: {{background}};
            background-size: cover;
            background-position: center;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            max-width: 500px;
            width: 90%;
            position: relative;
        }
        
        .user-links {
            position: absolute;
            top: 15px;
            right: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .user-link {
            padding: 6px 12px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .user-link.login {
            color: #667eea;
            border: 1px solid #667eea;
            background: transparent;
        }
        
        .user-link.login:hover {
            background: #667eea;
            color: white;
        }
        
        .user-link.register {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
        }
        
        .user-link.register:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .user-name {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }
        
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            z-index: 1;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .dropdown-content.show {
            display: block;
        }
        
        .dropdown-item {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.3s;
            font-size: 0.9em;
        }
        
        .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        .dropdown-item.logout {
            color: #dc3545;
            border-top: 1px solid #eee;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .logo-icon {
            width: 48px;
            height: 48px;
        }
        
        .logo-text {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1em;
        }
        
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .upload-icon {
            font-size: 3em;
            color: #ddd;
            margin-bottom: 15px;
        }
        
        .upload-text {
            color: #999;
            font-size: 1.1em;
        }
        
        .form-group {
            margin: 20px 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e1e1;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 120px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            width: 100%;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
        }
        
        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .result {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
            border: 1px solid #e9ecef;
        }
        
        .result.show {
            display: block;
        }
        
        .result-code {
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin: 10px 0;
            user-select: all;
        }
        
        .text-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.4;
            margin: 10px 0;
        }
        
        .file-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
        }
        
        .copy-btn {
            background: #17a2b8 !important;
            color: white !important;
            border: none !important;
            padding: 8px 16px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
            transition: background-color 0.3s ease;
        }
        
        .copy-btn:hover {
            background: #138496 !important;
        }
        
        .download-btn {
            background: #28a745 !important;
            color: white !important;
            padding: 10px 20px !important;
            text-decoration: none !important;
            border-radius: 5px !important;
            display: inline-block !important;
            transition: background-color 0.3s ease;
        }
        
        .download-btn:hover {
            background: #218838 !important;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #999;
            font-size: 0.9em;
        }
        
        .footer a {
            color: #667eea;
            text-decoration: none;
        }
        
        .progress-container {
            margin: 20px 0;
            display: none;
        }
        
        .progress-container.show {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #333;
            font-weight: 600;
            font-size: 12px;
            z-index: 1;
        }
        
        .upload-status {
            text-align: center;
            margin: 10px 0;
            font-weight: 600;
        }
        
        .status-uploading {
            color: #667eea;
        }
        
        .status-success {
            color: #28a745;
        }
        
        .status-error {
            color: #dc3545;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn:disabled:hover {
            transform: none;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 20px;
            }
            
            .logo {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç”¨æˆ·é“¾æ¥åŒºåŸŸ -->
        <div class="user-links" id="user-links">
            <!-- æœªç™»å½•çŠ¶æ€ -->
            <div id="guest-links" style="display: flex; gap: 10px;">
                <a href="/user/login" class="user-link login">ç™»å½•</a>
                <a href="/user/register" class="user-link register">æ³¨å†Œ</a>
            </div>
            
            <!-- å·²ç™»å½•çŠ¶æ€ -->
            <div id="user-logged-in" style="display: none;">
                <div class="dropdown">
                    <div class="user-info" style="cursor: pointer;">
                        <div class="user-avatar" id="user-avatar"></div>
                        <div class="user-name" id="user-name"></div>
                    </div>
                    <div class="dropdown-content">
                        <a href="/user/dashboard" class="dropdown-item">ç”¨æˆ·ä¸­å¿ƒ</a>
                        <a href="#" class="dropdown-item logout" onclick="logout()">é€€å‡ºç™»å½•</a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="header">
            <div class="logo">
                <img class="logo-icon" src="assets/images/logo.svg" alt="FileCodeBox Logo"/>
                <div class="logo-text">FileCodeBox</div>
            </div>
            <div class="subtitle">{{description}}</div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('file')">æ–‡ä»¶åˆ†äº«</div>
            <div class="tab" onclick="switchTab('text')">æ–‡æœ¬åˆ†äº«</div>
            <div class="tab" onclick="switchTab('get')">è·å–åˆ†äº«</div>
        </div>
        
        <!-- æ–‡ä»¶åˆ†äº« -->
        <div id="file-tab" class="tab-content active">
            <form id="file-form">
                <div class="upload-area" onclick="document.getElementById('file-input').click()">
                    <div class="upload-icon">ğŸ“</div>
                    <div class="upload-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
                    <input type="file" id="file-input" style="display: none;">
                </div>
                
                <div class="form-group">
                    <label>è¿‡æœŸæ—¶é—´</label>
                    <select class="form-control" name="expire_style">
                        <option value="day">å¤©</option>
                        <option value="hour">å°æ—¶</option>
                        <option value="minute">åˆ†é’Ÿ</option>
                        <option value="count">æ¬¡æ•°</option>
                        <option value="forever">æ°¸ä¸è¿‡æœŸ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <input type="number" class="form-control" name="expire_value" value="1" min="1" placeholder="è¿‡æœŸå€¼">
                </div>
                
                <!-- è¿›åº¦æ¡ -->
                <div id="upload-progress" class="progress-container">
                    <div class="upload-status" id="upload-status">å‡†å¤‡ä¸Šä¼ ...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                        <div class="progress-text" id="progress-text">0%</div>
                    </div>
                </div>
                
                <button type="submit" class="btn" id="upload-btn">ä¸Šä¼ æ–‡ä»¶</button>
            </form>
        </div>
        
        <!-- æ–‡æœ¬åˆ†äº« -->
        <div id="text-tab" class="tab-content">
            <form id="text-form">
                <div class="form-group">
                    <label>æ–‡æœ¬å†…å®¹</label>
                    <textarea class="form-control" name="text" placeholder="è¾“å…¥è¦åˆ†äº«çš„æ–‡æœ¬å†…å®¹..." required></textarea>
                </div>
                
                <div class="form-group">
                    <label>è¿‡æœŸæ—¶é—´</label>
                    <select class="form-control" name="expire_style">
                        <option value="day">å¤©</option>
                        <option value="hour">å°æ—¶</option>
                        <option value="minute">åˆ†é’Ÿ</option>
                        <option value="count">æ¬¡æ•°</option>
                        <option value="forever">æ°¸ä¸è¿‡æœŸ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <input type="number" class="form-control" name="expire_value" value="1" min="1" placeholder="è¿‡æœŸå€¼">
                </div>
                
                <button type="submit" class="btn" id="text-btn">åˆ†äº«æ–‡æœ¬</button>
            </form>
        </div>
        
        <!-- è·å–åˆ†äº« -->
        <div id="get-tab" class="tab-content">
            <form id="get-form">
                <div class="form-group">
                    <label>æå–ç </label>
                    <input type="text" class="form-control" name="code" placeholder="è¾“å…¥æå–ç " required>
                </div>
                
                <button type="submit" class="btn" id="get-btn">è·å–å†…å®¹</button>
            </form>
        </div>
        
        <!-- ç»“æœæ˜¾ç¤º -->
        <div id="result" class="result">
            <div id="result-content"></div>
        </div>
        
        <div class="footer">
            <p>{{page_explain}}</p>
            <p><a href="https://github.com/zy84338719/FileCodeBox" target="_blank">GitHub</a></p>
        </div>
    </div>
    
    <script>
        // ========== ç”¨æˆ·ç³»ç»ŸåŠŸèƒ½ ==========
        
        // è·å–ç”¨æˆ·token
        function getUserToken() {
            return localStorage.getItem('user_token');
        }
        
        // è·å–ç”¨æˆ·ä¿¡æ¯
        function getUserInfo() {
            const userInfo = localStorage.getItem('user_info');
            return userInfo ? JSON.parse(userInfo) : null;
        }
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkUserLogin() {
            const token = getUserToken();
            const userInfo = getUserInfo();
            
            if (token && userInfo) {
                // æ˜¾ç¤ºå·²ç™»å½•çŠ¶æ€
                document.getElementById('guest-links').style.display = 'none';
                document.getElementById('user-logged-in').style.display = 'block';
                
                // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
                document.getElementById('user-name').textContent = userInfo.nickname || userInfo.username;
                document.getElementById('user-avatar').textContent = (userInfo.nickname || userInfo.username).charAt(0).toUpperCase();
                
                return true;
            } else {
                // æ˜¾ç¤ºæœªç™»å½•çŠ¶æ€
                document.getElementById('guest-links').style.display = 'flex';
                document.getElementById('user-logged-in').style.display = 'none';
                
                return false;
            }
        }
        
        // é€€å‡ºç™»å½•
        async function logout() {
            try {
                const token = getUserToken();
                if (token) {
                    await fetch('/user/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + token
                        }
                    });
                }
            } catch (error) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
            }
            
            localStorage.removeItem('user_token');
            localStorage.removeItem('user_info');
            checkUserLogin();
        }
        
        // åœ¨APIè¯·æ±‚ä¸­æ·»åŠ è®¤è¯å¤´
        function getAuthHeaders() {
            const token = getUserToken();
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (token) {
                headers['Authorization'] = 'Bearer ' + token;
            }
            
            return headers;
        }
        
        // ========== åŸæœ‰åŠŸèƒ½ ==========
        
        function switchTab(tab) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µ
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // æ˜¾ç¤ºå½“å‰æ ‡ç­¾é¡µ
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
            
            // éšè—ç»“æœ
            document.getElementById('result').classList.remove('show');
        }
        
        function showResult(content) {
            document.getElementById('result-content').innerHTML = content;
            document.getElementById('result').classList.add('show');
        }
        
        // æ–‡ä»¶ä¸Šä¼ 
        document.getElementById('file-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·é€‰æ‹©æ–‡ä»¶');
                return;
            }

            // è·å–æœåŠ¡å™¨é…ç½®å¹¶æ£€æŸ¥æ–‡ä»¶å¤§å°
            try {
                const configResponse = await fetch('/', {
                    method: 'POST'
                });
                const configResult = await configResponse.json();
                
                if (configResult.code === 200) {
                    const maxSize = configResult.detail.uploadSize;
                    if (file.size > maxSize) {
                        const maxSizeMB = (maxSize / 1024 / 1024).toFixed(2);
                        const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                        alert(`æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼\næ–‡ä»¶å¤§å°: ${fileSizeMB}MB\næœ€å¤§å…è®¸: ${maxSizeMB}MB\n\nè¯·é€‰æ‹©æ›´å°çš„æ–‡ä»¶æˆ–ä½¿ç”¨ç®¡ç†åå°è°ƒæ•´ä¸Šä¼ å¤§å°é™åˆ¶ã€‚`);
                        return;
                    }
                }
            } catch (error) {
                console.error('è·å–é…ç½®å¤±è´¥:', error);
                // ç»§ç»­ä¸Šä¼ ï¼Œç”±æœåŠ¡å™¨è¿›è¡Œæœ€ç»ˆæ£€æŸ¥
            }
            
            // æ˜¾ç¤ºè¿›åº¦æ¡å’Œç¦ç”¨æŒ‰é’®
            const progressContainer = document.getElementById('upload-progress');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const uploadStatus = document.getElementById('upload-status');
            const uploadBtn = document.getElementById('upload-btn');
            
            progressContainer.classList.add('show');
            uploadBtn.disabled = true;
            uploadStatus.textContent = 'æ­£åœ¨ä¸Šä¼ ...';
            uploadStatus.className = 'upload-status status-uploading';
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('expire_style', e.target.expire_style.value);
            formData.append('expire_value', e.target.expire_value.value);
            
            try {
                const xhr = new XMLHttpRequest();
                
                // ä¸Šä¼ è¿›åº¦ç›‘å¬
                const uploadStartTime = Date.now();
                let lastUpdateTime = uploadStartTime;
                let smoothProgress = 0;
                
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const currentTime = Date.now();
                        const timeDiff = currentTime - lastUpdateTime;
                        
                        // è®¡ç®—çœŸå®è¿›åº¦
                        const realProgress = (e.loaded / e.total) * 100;
                        
                        // å¹³æ»‘è¿›åº¦æ›´æ–°ï¼Œé¿å…è¿›åº¦æ¡è·³è·ƒ
                        if (timeDiff > 50) { // æ¯50msæœ€å¤šæ›´æ–°ä¸€æ¬¡
                            // å¦‚æœçœŸå®è¿›åº¦æ¯”å½“å‰æ˜¾ç¤ºçš„è¿›åº¦å¿«å¾ˆå¤šï¼ŒåŠ å¿«è¿½èµ¶é€Ÿåº¦
                            const progressDiff = realProgress - smoothProgress;
                            if (progressDiff > 10) {
                                smoothProgress += progressDiff * 0.5; // å¿«é€Ÿè¿½èµ¶
                            } else {
                                smoothProgress += progressDiff * 0.3; // å¹³æ»‘æ›´æ–°
                            }
                            
                            // ç¡®ä¿è¿›åº¦ä¸è¶…è¿‡çœŸå®è¿›åº¦
                            smoothProgress = Math.min(smoothProgress, realProgress);
                            
                            // æ›´æ–°UI
                            const displayProgress = Math.floor(smoothProgress);
                            progressFill.style.width = smoothProgress + '%';
                            progressText.textContent = displayProgress + '%';
                            
                            // è®¡ç®—ä¸Šä¼ é€Ÿåº¦
                            const speed = e.loaded / ((currentTime - uploadStartTime) / 1000);
                            const speedText = formatSpeed(speed);
                            
                            // ä¼°ç®—å‰©ä½™æ—¶é—´
                            const remainingBytes = e.total - e.loaded;
                            const estimatedTime = remainingBytes / speed;
                            const timeText = formatTime(estimatedTime);
                            
                            if (displayProgress < 100) {
                                uploadStatus.textContent = `æ­£åœ¨ä¸Šä¼ ... ${displayProgress}% (${speedText}, å‰©ä½™${timeText})`;
                            } else {
                                uploadStatus.textContent = 'å¤„ç†ä¸­...';
                            }
                            
                            lastUpdateTime = currentTime;
                        }
                    }
                });
                
                // å“åº”å¤„ç†
                xhr.addEventListener('load', function() {
                    try {
                        const result = JSON.parse(xhr.responseText);
                        
                        if (result.code === 200) {
                            uploadStatus.textContent = 'ä¸Šä¼ æˆåŠŸï¼';
                            uploadStatus.className = 'upload-status status-success';
                            
                            // è‡ªåŠ¨å¤åˆ¶æå–ç åˆ°å‰ªè´´æ¿
                            const shareCode = result.detail.code;
                            copyToClipboardAuto(shareCode);
                            
                            setTimeout(() => {
                                showResult(`
                                    <h3>æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼</h3>
                                    <div class="result-code">${result.detail.code}</div>
                                    <p>æ–‡ä»¶å: ${result.detail.name}</p>
                                    <p>æ–‡ä»¶å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                                    <p>âœ… æå–ç å·²è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿</p>
                                `);
                                
                                // é‡ç½®è¡¨å•
                                progressContainer.classList.remove('show');
                                uploadBtn.disabled = false;
                                progressFill.style.width = '0%';
                                progressText.textContent = '0%';
                                fileInput.value = '';
                                document.querySelector('.upload-text').textContent = 'ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„';
                            }, 1000);
                        } else {
                            throw new Error(result.message || 'ä¸Šä¼ å¤±è´¥');
                        }
                    } catch (error) {
                        uploadStatus.textContent = 'ä¸Šä¼ å¤±è´¥: ' + error.message;
                        uploadStatus.className = 'upload-status status-error';
                        uploadBtn.disabled = false;
                        
                        setTimeout(() => {
                            alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
                        }, 500);
                    }
                });
                
                // é”™è¯¯å¤„ç†
                xhr.addEventListener('error', function() {
                    uploadStatus.textContent = 'ç½‘ç»œé”™è¯¯';
                    uploadStatus.className = 'upload-status status-error';
                    uploadBtn.disabled = false;
                    alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
                });
                
                // è¶…æ—¶å¤„ç†
                xhr.addEventListener('timeout', function() {
                    uploadStatus.textContent = 'ä¸Šä¼ è¶…æ—¶';
                    uploadStatus.className = 'upload-status status-error';
                    uploadBtn.disabled = false;
                    alert('ä¸Šä¼ è¶…æ—¶ï¼Œè¯·é‡è¯•');
                });
                
                // å‘é€è¯·æ±‚
                xhr.timeout = 300000; // 5åˆ†é’Ÿè¶…æ—¶
                xhr.open('POST', '/share/file/');
                
                // æ·»åŠ è®¤è¯å¤´
                const token = getUserToken();
                if (token) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                }
                
                xhr.send(formData);
                
            } catch (error) {
                uploadStatus.textContent = 'ä¸Šä¼ å¤±è´¥: ' + error.message;
                uploadStatus.className = 'upload-status status-error';
                uploadBtn.disabled = false;
                alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
            }
        });
        
        // æ–‡æœ¬åˆ†äº«
        document.getElementById('text-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const textBtn = document.getElementById('text-btn');
            const originalText = textBtn.textContent;
            
            textBtn.disabled = true;
            textBtn.textContent = 'åˆ†äº«ä¸­...';
            
            const formData = new FormData();
            formData.append('text', e.target.text.value);
            formData.append('expire_style', e.target.expire_style.value);
            formData.append('expire_value', e.target.expire_value.value);
            
            try {
                const token = getUserToken();
                const headers = {};
                if (token) {
                    headers['Authorization'] = 'Bearer ' + token;
                }
                
                const response = await fetch('/share/text/', {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    // è‡ªåŠ¨å¤åˆ¶æå–ç åˆ°å‰ªè´´æ¿
                    const shareCode = result.detail.share_code;
                    copyToClipboardAuto(shareCode);
                    
                    showResult(`
                        <h3>æ–‡æœ¬åˆ†äº«æˆåŠŸï¼</h3>
                        <div class="result-code">${result.detail.share_code}</div>
                        <p>æ–‡æœ¬é•¿åº¦: ${e.target.text.value.length} å­—ç¬¦</p>
                        <p>âœ… æå–ç å·²è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿</p>
                    `);
                    
                    // é‡ç½®è¡¨å•
                    e.target.text.value = '';
                } else {
                    alert(result.message || 'åˆ†äº«å¤±è´¥');
                }
            } catch (error) {
                alert('åˆ†äº«å¤±è´¥: ' + error.message);
            } finally {
                textBtn.disabled = false;
                textBtn.textContent = originalText;
            }
        });
        
        // è·å–åˆ†äº«
        document.getElementById('get-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const getBtn = document.getElementById('get-btn');
            const originalText = getBtn.textContent;
            const code = e.target.code.value;
            
            getBtn.disabled = true;
            getBtn.textContent = 'è·å–ä¸­...';
            
            try {
                const token = getUserToken();
                const headers = {
                    'Content-Type': 'application/json',
                };
                if (token) {
                    headers['Authorization'] = 'Bearer ' + token;
                }
                
                const response = await fetch('/share/select/', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ code: code })
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    const detail = result.detail;
                    
                    if (detail.text.startsWith('http') || detail.text.startsWith('/share/download')) {
                        // æ–‡ä»¶ä¸‹è½½
                        const fileSize = detail.size ? (detail.size / 1024 / 1024).toFixed(2) : 'æœªçŸ¥';
                        const fileName = detail.name ? detail.name.replace(/[<>"'&]/g, function(match) {
                            const escapeMap = {'<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#x27;', '&': '&amp;'};
                            return escapeMap[match];
                        }) : 'æœªçŸ¥æ–‡ä»¶';
                        
                        showResult(`
                            <h3>ğŸ“ æ–‡ä»¶ä¿¡æ¯</h3>
                            <div style="background: white; padding: 15px; border-radius: 8px; margin: 10px 0;">
                                <p><strong>æ–‡ä»¶å:</strong> ${fileName}</p>
                                <p><strong>å¤§å°:</strong> ${fileSize} MB</p>
                                <div style="margin-top: 15px;">
                                    <a href="${detail.text}" class="btn" download style="background: #28a745; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;">ğŸ“¥ ä¸‹è½½æ–‡ä»¶</a>
                                </div>
                            </div>
                        `);
                    } else {
                        // æ–‡æœ¬å†…å®¹ - éœ€è¦è½¬ä¹‰HTMLä»¥é˜²æ­¢XSSæ”»å‡»å’Œå¸ƒå±€ç ´å
                        const escapedText = detail.text
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;')
                            .replace(/'/g, '&#x27;');
                        
                        // é™åˆ¶æ–‡æœ¬é•¿åº¦æ˜¾ç¤º
                        const maxLength = 5000;
                        const displayText = escapedText.length > maxLength 
                            ? escapedText.substring(0, maxLength) + '\n\n... (æ–‡æœ¬è¿‡é•¿ï¼Œå·²æˆªæ–­)'
                            : escapedText;
                            
                        showResult(`
                            <h3>ğŸ“ æ–‡æœ¬å†…å®¹</h3>
                            <div style="background: white; padding: 15px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; font-family: monospace; font-size: 14px; line-height: 1.4;">
                                ${displayText}
                            </div>
                            <div style="margin-top: 10px; text-align: center;">
                                <button onclick="copyToClipboard('${escapedText.replace(/'/g, "\\'")}', this)" class="btn" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">ğŸ“‹ å¤åˆ¶æ–‡æœ¬</button>
                            </div>
                        `);
                    }
                    
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    e.target.code.value = '';
                } else {
                    alert(result.message || 'è·å–å¤±è´¥');
                }
            } catch (error) {
                alert('è·å–å¤±è´¥: ' + error.message);
            } finally {
                getBtn.disabled = false;
                getBtn.textContent = originalText;
            }
        });
        
        // æ–‡ä»¶æ‹–æ‹½ä¸Šä¼ 
        const uploadArea = document.querySelector('.upload-area');
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = '#667eea';
            this.style.background = 'rgba(102, 126, 234, 0.1)';
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.borderColor = '#ddd';
            this.style.background = '';
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '#ddd';
            this.style.background = '';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('file-input').files = files;
                const fileSizeMB = (files[0].size / 1024 / 1024).toFixed(2);
                this.querySelector('.upload-text').textContent = `å·²é€‰æ‹©: ${files[0].name} (${fileSizeMB}MB)`;
            }
        });
        
        // æ–‡ä»¶é€‰æ‹©å™¨å˜åŒ–
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                document.querySelector('.upload-text').textContent = `å·²é€‰æ‹©: ${file.name} (${fileSizeMB}MB)`;
            }
        });
        
        // æ ¼å¼åŒ–ä¸Šä¼ é€Ÿåº¦
        function formatSpeed(bytesPerSecond) {
            if (bytesPerSecond === 0) return '0 B/s';
            
            const units = ['B/s', 'KB/s', 'MB/s', 'GB/s'];
            let size = bytesPerSecond;
            let unitIndex = 0;
            
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            
            return size.toFixed(1) + ' ' + units[unitIndex];
        }
        
        // æ ¼å¼åŒ–å‰©ä½™æ—¶é—´
        function formatTime(seconds) {
            if (!isFinite(seconds) || seconds <= 0) return 'è®¡ç®—ä¸­...';
            
            if (seconds < 60) {
                return Math.round(seconds) + 'ç§’';
            } else if (seconds < 3600) {
                const minutes = Math.round(seconds / 60);
                return minutes + 'åˆ†é’Ÿ';
            } else {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.round((seconds % 3600) / 60);
                return hours + 'å°æ—¶' + (minutes > 0 ? minutes + 'åˆ†é’Ÿ' : '');
            }
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿åŠŸèƒ½
        function copyToClipboard(text, button) {
            const originalText = button.textContent;
            
            if (navigator.clipboard && window.isSecureContext) {
                // ç°ä»£æµè§ˆå™¨çš„ Clipboard API
                navigator.clipboard.writeText(text).then(() => {
                    button.textContent = 'âœ… å·²å¤åˆ¶';
                    button.style.background = '#28a745';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '#17a2b8';
                    }, 2000);
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopyTextToClipboard(text, button, originalText);
                });
            } else {
                // å¤‡ç”¨æ–¹æ¡ˆ
                fallbackCopyTextToClipboard(text, button, originalText);
            }
        }
        
        function fallbackCopyTextToClipboard(text, button, originalText) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    button.textContent = 'âœ… å·²å¤åˆ¶';
                    button.style.background = '#28a745';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '#17a2b8';
                    }, 2000);
                } else {
                    button.textContent = 'âŒ å¤åˆ¶å¤±è´¥';
                    button.style.background = '#dc3545';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '#17a2b8';
                    }, 2000);
                }
            } catch (err) {
                console.error('å¤‡ç”¨å¤åˆ¶æ–¹æ¡ˆå¤±è´¥:', err);
                button.textContent = 'âŒ å¤åˆ¶å¤±è´¥';
                button.style.background = '#dc3545';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#17a2b8';
                }, 2000);
            }
            
            document.body.removeChild(textArea);
        }
        
        // è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿åŠŸèƒ½ï¼ˆæ— æŒ‰é’®åé¦ˆï¼‰
        function copyToClipboardAuto(text) {
            if (navigator.clipboard && window.isSecureContext) {
                // ç°ä»£æµè§ˆå™¨çš„ Clipboard API
                navigator.clipboard.writeText(text).then(() => {
                    console.log('æå–ç å·²è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿:', text);
                    // å¯ä»¥é€‰æ‹©æ˜¾ç¤ºä¸€ä¸ªç®€å•çš„æç¤º
                    showCopyNotification('æå–ç å·²å¤åˆ¶: ' + text);
                }).catch(err => {
                    console.error('è‡ªåŠ¨å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopyTextToClipboardAuto(text);
                });
            } else {
                // å¤‡ç”¨æ–¹æ¡ˆ
                fallbackCopyTextToClipboardAuto(text);
            }
        }
        
        function fallbackCopyTextToClipboardAuto(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    console.log('æå–ç å·²è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªè´´æ¿:', text);
                    showCopyNotification('æå–ç å·²å¤åˆ¶: ' + text);
                } else {
                    console.error('è‡ªåŠ¨å¤åˆ¶å¤±è´¥');
                }
            } catch (err) {
                console.error('å¤‡ç”¨è‡ªåŠ¨å¤åˆ¶æ–¹æ¡ˆå¤±è´¥:', err);
            }
            
            document.body.removeChild(textArea);
        }
        
        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„é€šçŸ¥
        function showCopyNotification(message) {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // ä¸‹æ‹‰èœå•æ§åˆ¶é€»è¾‘
        let dropdownTimer = null;
        
        function setupDropdownEvents() {
            const dropdown = document.querySelector('.dropdown');
            const dropdownContent = document.querySelector('.dropdown-content');
            
            if (!dropdown || !dropdownContent) return;
            
            // é¼ æ ‡è¿›å…¥ä¸‹æ‹‰èœå•åŒºåŸŸ
            dropdown.addEventListener('mouseenter', function() {
                if (dropdownTimer) {
                    clearTimeout(dropdownTimer);
                    dropdownTimer = null;
                }
                dropdownContent.classList.add('show');
            });
            
            // é¼ æ ‡ç¦»å¼€ä¸‹æ‹‰èœå•åŒºåŸŸ
            dropdown.addEventListener('mouseleave', function() {
                // è®¾ç½®å»¶è¿Ÿéšè—ï¼Œç»™ç”¨æˆ·æ—¶é—´ç§»åŠ¨åˆ°èœå•é¡¹
                dropdownTimer = setTimeout(function() {
                    dropdownContent.classList.remove('show');
                }, 200); // 200mså»¶è¿Ÿ
            });
            
            // é¼ æ ‡è¿›å…¥ä¸‹æ‹‰èœå•å†…å®¹åŒºåŸŸ
            dropdownContent.addEventListener('mouseenter', function() {
                if (dropdownTimer) {
                    clearTimeout(dropdownTimer);
                    dropdownTimer = null;
                }
            });
            
            // é¼ æ ‡ç¦»å¼€ä¸‹æ‹‰èœå•å†…å®¹åŒºåŸŸ
            dropdownContent.addEventListener('mouseleave', function() {
                dropdownTimer = setTimeout(function() {
                    dropdownContent.classList.remove('show');
                }, 200); // 200mså»¶è¿Ÿ
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            checkUserLogin();
            // è®¾ç½®ä¸‹æ‹‰èœå•äº‹ä»¶
            setupDropdownEvents();
        });
    </script>
</body>
</html>
