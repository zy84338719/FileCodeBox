<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå° - FileCodeBox</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
            font-size: 1.5em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .tabs {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .tab-header {
            display: flex;
            border-bottom: 1px solid #eee;
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            padding: 20px;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-text {
            display: block;
            margin-top: 5px;
            font-size: 0.875em;
            color: #666;
            line-height: 1.4;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background 0.3s ease;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .table tr:hover {
            background: #f8f9fa;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
        }
        
        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        
        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-header {
                flex-direction: column;
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
            }
            
            .table {
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div id="login-page" class="login-container">
        <h2 class="login-title">ç®¡ç†å‘˜ç™»å½•</h2>
        <form id="login-form">
            <div class="form-group">
                <label>ç®¡ç†å‘˜å¯†ç </label>
                <input type="password" class="form-control" id="admin-password" required>
            </div>
            <button type="submit" class="btn" style="width: 100%;">ç™»å½•</button>
        </form>
    </div>

    <!-- ç®¡ç†é¡µé¢ -->
    <div id="admin-page" style="display: none;">
        <div class="container">
            <div class="header">
                <div class="logo">ğŸ“¦ FileCodeBox ç®¡ç†åå°</div>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>

            <div class="stats-grid" id="stats-grid">
                <!-- ç»Ÿè®¡æ•°æ®å°†é€šè¿‡JavaScriptå¡«å…… -->
            </div>

            <div class="tabs">
                <div class="tab-header">
                    <button class="tab-btn active" onclick="switchTab('files')">æ–‡ä»¶ç®¡ç†</button>
                    <button class="tab-btn" onclick="switchTab('storage')">å­˜å‚¨ç®¡ç†</button>
                    <button class="tab-btn" onclick="switchTab('config')">ç³»ç»Ÿé…ç½®</button>
                    <button class="tab-btn" onclick="switchTab('maintenance')">ç³»ç»Ÿç»´æŠ¤</button>
                </div>

                <!-- æ–‡ä»¶ç®¡ç† -->
                <div id="files-tab" class="tab-content active">
                    <div class="search-box">
                        <input type="text" class="form-control" id="search-input" placeholder="æœç´¢æ–‡ä»¶..." style="display: inline-block; width: 300px; margin-right: 10px;">
                        <button class="btn" onclick="searchFiles()">æœç´¢</button>
                        <button class="btn" onclick="loadFiles()">åˆ·æ–°</button>
                    </div>
                    
                    <div id="files-content">
                        <div class="loading">åŠ è½½ä¸­...</div>
                    </div>
                    
                    <div class="pagination" id="pagination">
                        <!-- åˆ†é¡µå°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                </div>

                <!-- å­˜å‚¨ç®¡ç† -->
                <div id="storage-tab" class="tab-content">
                    <h3>å­˜å‚¨ç®¡ç†</h3>
                    <p style="color: #666; margin-bottom: 30px;">ç®¡ç†æ–‡ä»¶å­˜å‚¨ä½ç½®ï¼Œæ”¯æŒæœ¬åœ°å­˜å‚¨å’Œ WebDAV è¿œç¨‹å­˜å‚¨</p>
                    
                    <!-- å­˜å‚¨ç±»å‹å¡ç‰‡ -->
                    <div class="storage-cards" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <!-- æœ¬åœ°å­˜å‚¨å¡ç‰‡ -->
                        <div class="storage-card" id="local-card" style="border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <div class="storage-icon" style="width: 40px; height: 40px; background: #28a745; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <span style="color: white; font-size: 18px;">ğŸ’¾</span>
                                </div>
                                <div>
                                    <h4 style="margin: 0;">æœ¬åœ°å­˜å‚¨</h4>
                                    <p style="margin: 0; color: #666; font-size: 14px;">æ–‡ä»¶å­˜å‚¨åœ¨æœåŠ¡å™¨æœ¬åœ°ç£ç›˜</p>
                                </div>
                            </div>
                            <div class="storage-status" id="local-status">
                                <span class="status-badge" style="display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="storage-config" id="local-config" style="margin-top: 15px; display: none;">
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">å­˜å‚¨è·¯å¾„</label>
                                    <input type="text" id="local-storage-path" class="form-control" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤è·¯å¾„ (./data/share/data)" style="width: 100%;">
                                    <small style="color: #666;">å¯ä»¥æŒ‡å®šè‡ªå®šä¹‰çš„å­˜å‚¨è·¯å¾„ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤è·¯å¾„</small>
                                </div>
                            </div>
                        </div>

                        <!-- WebDAV å­˜å‚¨å¡ç‰‡ -->
                        <div class="storage-card" id="webdav-card" style="border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <div class="storage-icon" style="width: 40px; height: 40px; background: #007bff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <span style="color: white; font-size: 18px;">â˜ï¸</span>
                                </div>
                                <div>
                                    <h4 style="margin: 0;">WebDAV å­˜å‚¨</h4>
                                    <p style="margin: 0; color: #666; font-size: 14px;">æ–‡ä»¶å­˜å‚¨åœ¨ WebDAV è¿œç¨‹æœåŠ¡å™¨</p>
                                </div>
                            </div>
                            <div class="storage-status" id="webdav-status">
                                <span class="status-badge" style="display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="storage-config" id="webdav-config" style="margin-top: 15px; display: none;">
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">æœåŠ¡å™¨åœ°å€</label>
                                    <input type="text" id="webdav-hostname" class="form-control" placeholder="http://example.com:5005" style="width: 100%;">
                                    <small style="color: #666;">WebDAV æœåŠ¡å™¨çš„å®Œæ•´åœ°å€ï¼ŒåŒ…å«åè®®å’Œç«¯å£</small>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ç”¨æˆ·å</label>
                                        <input type="text" id="webdav-username" class="form-control" style="width: 100%;">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å¯†ç </label>
                                        <input type="password" id="webdav-password" class="form-control" style="width: 100%;">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ ¹ç›®å½•</label>
                                    <input type="text" id="webdav-root-path" class="form-control" placeholder="filebox_storage" style="width: 100%;">
                                    <small style="color: #666;">åœ¨ WebDAV æœåŠ¡å™¨ä¸Šåˆ›å»ºçš„å­˜å‚¨ç›®å½•åç§°</small>
                                </div>
                            </div>
                        </div>

                        <!-- S3 å­˜å‚¨å¡ç‰‡ -->
                        <div class="storage-card" id="s3-card" style="border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <div class="storage-icon" style="width: 40px; height: 40px; background: #ff9500; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <span style="color: white; font-size: 18px;">ğŸ“¦</span>
                                </div>
                                <div>
                                    <h4 style="margin: 0;">S3 å¯¹è±¡å­˜å‚¨</h4>
                                    <p style="margin: 0; color: #666; font-size: 14px;">æ–‡ä»¶å­˜å‚¨åœ¨ S3 å…¼å®¹çš„å¯¹è±¡å­˜å‚¨æœåŠ¡</p>
                                </div>
                            </div>
                            <div class="storage-status" id="s3-status">
                                <span class="status-badge" style="display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <div class="storage-config" id="s3-config" style="margin-top: 15px; display: none;">
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ç«¯ç‚¹åœ°å€</label>
                                    <input type="text" id="s3-endpoint-url" class="form-control" placeholder="https://s3.amazonaws.com" style="width: 100%;">
                                    <small style="color: #666;">S3 æœåŠ¡çš„ç«¯ç‚¹åœ°å€ï¼ŒAWS S3 æˆ–å…¼å®¹æœåŠ¡</small>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">è®¿é—®å¯†é’¥</label>
                                        <input type="text" id="s3-access-key-id" class="form-control" placeholder="Access Key ID" style="width: 100%;">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å¯†é’¥</label>
                                        <input type="password" id="s3-secret-access-key" class="form-control" placeholder="Secret Access Key" style="width: 100%;">
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å­˜å‚¨æ¡¶åç§°</label>
                                        <input type="text" id="s3-bucket-name" class="form-control" placeholder="my-bucket" style="width: 100%;">
                                    </div>
                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">åŒºåŸŸ</label>
                                        <input type="text" id="s3-region-name" class="form-control" placeholder="us-east-1" style="width: 100%;">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">è‡ªå®šä¹‰åŸŸå (å¯é€‰)</label>
                                    <input type="text" id="s3-hostname" class="form-control" placeholder="cdn.example.com" style="width: 100%;">
                                    <small style="color: #666;">ç”¨äºæ–‡ä»¶è®¿é—®çš„è‡ªå®šä¹‰åŸŸåï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤åŸŸå</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="storage-actions" style="text-align: center; margin-bottom: 30px;">
                        <button class="btn" id="config-btn" onclick="toggleStorageConfig()" style="margin-right: 10px; display: none;">
                            <span id="config-btn-text">é…ç½®å­˜å‚¨</span>
                        </button>
                        <button class="btn btn-primary" id="save-config-btn" onclick="saveStorageConfig()" style="margin-right: 10px; display: none;">ä¿å­˜é…ç½®</button>
                        <button class="btn btn-success" id="test-btn" onclick="testStorageConnection()" style="margin-right: 10px; display: none;">æµ‹è¯•è¿æ¥</button>
                        <button class="btn btn-warning" id="switch-btn" onclick="confirmStorageSwitch()" style="display: none;">åˆ‡æ¢åˆ°æ­¤å­˜å‚¨</button>
                    </div>

                    <!-- å½“å‰çŠ¶æ€ä¿¡æ¯ -->
                    <div class="current-storage-info" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <h4 style="margin: 0 0 10px 0;">å½“å‰ä½¿ç”¨çš„å­˜å‚¨</h4>
                        <div id="current-storage-display" style="font-size: 18px; font-weight: bold;">
                            <span id="current-storage-name">åŠ è½½ä¸­...</span>
                            <span id="current-storage-status" style="margin-left: 10px; font-size: 14px; opacity: 0.9;"></span>
                        </div>
                    </div>

                    <!-- å­˜å‚¨åˆ‡æ¢ç¡®è®¤å¯¹è¯æ¡† -->
                    <div id="switch-confirm-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
                        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 400px; text-align: center;">
                            <h4 style="margin-bottom: 20px;">ç¡®è®¤åˆ‡æ¢å­˜å‚¨</h4>
                            <p id="switch-confirm-text" style="margin-bottom: 20px; color: #666;"></p>
                            <div>
                                <button class="btn btn-secondary" onclick="cancelStorageSwitch()" style="margin-right: 10px;">å–æ¶ˆ</button>
                                <button class="btn btn-primary" onclick="executeStorageSwitch()">ç¡®è®¤åˆ‡æ¢</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç³»ç»Ÿé…ç½® -->
                <div id="config-tab" class="tab-content">
                    <form id="config-form">
                        <div class="form-group">
                            <label>ç«™ç‚¹åç§°</label>
                            <input type="text" class="form-control" name="name">
                        </div>
                        <div class="form-group">
                            <label>ç«™ç‚¹æè¿°</label>
                            <input type="text" class="form-control" name="description">
                        </div>
                        <div class="form-group">
                            <label>ä¸Šä¼ å¤§å°é™åˆ¶ (MB)</label>
                            <input type="number" class="form-control" name="upload_size">
                        </div>
                        <div class="form-group">
                            <label>ç®¡ç†å‘˜å¯†ç </label>
                            <input type="password" class="form-control" name="admin_token">
                        </div>
                        <div class="form-group">
                            <label>æœåŠ¡å™¨ç»‘å®šåœ°å€</label>
                            <input type="text" class="form-control" name="host" placeholder="ä¾‹å¦‚: 0.0.0.0 (å…è®¸å¤–éƒ¨è®¿é—®) æˆ– localhost (ä»…æœ¬åœ°è®¿é—®)">
                            <small class="form-text">é»˜è®¤ 0.0.0.0 å…è®¸å¤–éƒ¨è®¿é—®ï¼Œlocalhost ä»…å…è®¸æœ¬åœ°è®¿é—®</small>
                        </div>
                        <div class="form-group">
                            <label>åˆ†å—ä¸Šä¼ å¤§å° (MB)</label>
                            <input type="number" class="form-control" name="chunk_size" min="1" max="100">
                            <small class="form-text">å•ä¸ªåˆ†å—çš„å¤§å°ï¼Œå½±å“å¤§æ–‡ä»¶ä¸Šä¼ æ€§èƒ½</small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="enable_concurrent_download"> 
                                å¯ç”¨å¹¶å‘ä¸‹è½½
                            </label>
                            <small class="form-text">å…è®¸åŒæ—¶è¿›è¡Œå¤šä¸ªä¸‹è½½ä»»åŠ¡</small>
                        </div>
                        <div class="form-group">
                            <label>æœ€å¤§å¹¶å‘ä¸‹è½½æ•°</label>
                            <input type="number" class="form-control" name="max_concurrent_downloads" min="1" max="50">
                            <small class="form-text">åŒæ—¶å…è®¸çš„æœ€å¤§ä¸‹è½½è¿æ¥æ•°</small>
                        </div>
                        <div class="form-group">
                            <label>ä¸‹è½½è¶…æ—¶æ—¶é—´ (ç§’)</label>
                            <input type="number" class="form-control" name="download_timeout" min="60" max="3600">
                            <small class="form-text">å•ä¸ªä¸‹è½½ä»»åŠ¡çš„è¶…æ—¶æ—¶é—´</small>
                        </div>
                        <button type="submit" class="btn">ä¿å­˜é…ç½®</button>
                    </form>
                </div>

                <!-- ç³»ç»Ÿç»´æŠ¤ -->
                <div id="maintenance-tab" class="tab-content">
                    <h3>ç³»ç»Ÿç»´æŠ¤</h3>
                    <p>æ¸…ç†è¿‡æœŸæ–‡ä»¶å’Œæ— æ•ˆæ•°æ®</p>
                    <button class="btn btn-danger" onclick="cleanExpiredFiles()">æ¸…ç†è¿‡æœŸæ–‡ä»¶</button>
                    
                    <div id="maintenance-result" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘æ–‡ä»¶æ¨¡æ€æ¡† -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>ç¼–è¾‘æ–‡ä»¶ä¿¡æ¯</h3>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label>æå–ç </label>
                    <input type="text" class="form-control" id="edit-code">
                </div>
                <div class="form-group">
                    <label>æ–‡ä»¶å</label>
                    <input type="text" class="form-control" id="edit-prefix">
                </div>
                <div class="form-group">
                    <label>æ–‡ä»¶æ‰©å±•å</label>
                    <input type="text" class="form-control" id="edit-suffix">
                </div>
                <div class="form-group">
                    <label>è¿‡æœŸæ—¶é—´</label>
                    <input type="datetime-local" class="form-control" id="edit-expired-at">
                </div>
                <div class="form-group">
                    <label>ä½¿ç”¨æ¬¡æ•°é™åˆ¶</label>
                    <input type="number" class="form-control" id="edit-expired-count">
                </div>
                <button type="submit" class="btn">ä¿å­˜æ›´æ”¹</button>
                <button type="button" class="btn btn-danger" onclick="closeModal()">å–æ¶ˆ</button>
            </form>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentPage = 1;
        let currentSearch = '';
        let authToken = localStorage.getItem('admin_token');

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type = 'info') {
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„æç¤ºæ¡†
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 9999;
                max-width: 400px;
                word-wrap: break-word;
            `;
            
            // æ ¹æ®ç±»å‹è®¾ç½®èƒŒæ™¯è‰²
            switch(type) {
                case 'success':
                    alertDiv.style.backgroundColor = '#28a745';
                    break;
                case 'error':
                    alertDiv.style.backgroundColor = '#dc3545';
                    break;
                case 'warning':
                    alertDiv.style.backgroundColor = '#ffc107';
                    alertDiv.style.color = '#212529';
                    break;
                default:
                    alertDiv.style.backgroundColor = '#17a2b8';
            }
            
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            if (authToken) {
                showAdminPage();
            } else {
                showLoginPage();
            }
            
            // æ·»åŠ å­˜å‚¨ç±»å‹é€‰æ‹©å™¨çš„å˜åŒ–ç›‘å¬å™¨
            const storageSelect = document.getElementById('storage-type-select');
            if (storageSelect) {
                storageSelect.addEventListener('change', function() {
                    const selectedType = this.value;
                    showStorageConfig(selectedType);
                });
            }
        });

        // æ˜¾ç¤ºç™»å½•é¡µé¢
        function showLoginPage() {
            document.getElementById('login-page').style.display = 'block';
            document.getElementById('admin-page').style.display = 'none';
        }

        // æ˜¾ç¤ºç®¡ç†é¡µé¢
        function showAdminPage() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('admin-page').style.display = 'block';
            loadStats();
            loadFiles();
            loadConfig();
        }

        // ç™»å½•
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const password = document.getElementById('admin-password').value;
            
            try {
                const response = await fetch('/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password: password })
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    authToken = result.detail.token;
                    localStorage.setItem('admin_token', authToken);
                    showAdminPage();
                } else {
                    alert(result.message || 'ç™»å½•å¤±è´¥');
                }
            } catch (error) {
                alert('ç™»å½•å¤±è´¥: ' + error.message);
            }
        });

        // é€€å‡ºç™»å½•
        function logout() {
            authToken = null;
            localStorage.removeItem('admin_token');
            showLoginPage();
        }

        // APIè¯·æ±‚å°è£…
        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken
                }
            };
            
            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };
            
            const response = await fetch(url, finalOptions);
            
            if (response.status === 401) {
                logout();
                throw new Error('è®¤è¯å¤±è´¥');
            }
            
            return response.json();
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const result = await apiRequest('/admin/dashboard');
                
                if (result.code === 200) {
                    const stats = result.detail;
                    const statsHtml = `
                        <div class="stat-card">
                            <div class="stat-number">${stats.total_files || 0}</div>
                            <div class="stat-label">æ€»æ–‡ä»¶æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.today_files || 0}</div>
                            <div class="stat-label">ä»Šæ—¥ä¸Šä¼ </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.active_files || 0}</div>
                            <div class="stat-label">æ´»è·ƒæ–‡ä»¶</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${formatFileSize(stats.total_size || 0)}</div>
                            <div class="stat-label">æ€»å­˜å‚¨å¤§å°</div>
                        </div>
                    `;
                    document.getElementById('stats-grid').innerHTML = statsHtml;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }

        // åŠ è½½æ–‡ä»¶åˆ—è¡¨
        async function loadFiles(page = 1) {
            currentPage = page;
            
            try {
                const result = await apiRequest(`/admin/files?page=${page}&page_size=20&search=${currentSearch}`);
                
                if (result.code === 200) {
                    const data = result.detail;
                    const files = data.files || [];
                    
                    let tableHtml = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>æå–ç </th>
                                    <th>æ–‡ä»¶å</th>
                                    <th>å¤§å°</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>è¿‡æœŸæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    files.forEach(file => {
                        tableHtml += `
                            <tr>
                                <td>${file.id}</td>
                                <td>${file.code}</td>
                                <td>${file.prefix}${file.suffix}</td>
                                <td>${formatFileSize(file.size)}</td>
                                <td>${formatDateTime(file.created_at)}</td>
                                <td>${formatDateTime(file.expired_at)}</td>
                                <td>
                                    <button class="btn" onclick="editFile(${file.id})">ç¼–è¾‘</button>
                                    <button class="btn btn-danger" onclick="deleteFile(${file.id})">åˆ é™¤</button>
                                    ${file.text ? '' : `<button class="btn btn-success" onclick="downloadFile(${file.id})">ä¸‹è½½</button>`}
                                </td>
                            </tr>
                        `;
                    });
                    
                    tableHtml += '</tbody></table>';
                    
                    document.getElementById('files-content').innerHTML = tableHtml;
                    
                    // ç”Ÿæˆåˆ†é¡µ
                    generatePagination(data.total, data.page, data.page_size);
                }
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('files-content').innerHTML = '<div class="alert alert-danger">åŠ è½½å¤±è´¥</div>';
            }
        }

        // ç”Ÿæˆåˆ†é¡µ
        function generatePagination(total, currentPage, pageSize) {
            const totalPages = Math.ceil(total / pageSize);
            let paginationHtml = '';
            
            if (totalPages > 1) {
                paginationHtml += `<button class="btn" onclick="loadFiles(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
                paginationHtml += `<span>ç¬¬ ${currentPage} é¡µï¼Œå…± ${totalPages} é¡µ</span>`;
                paginationHtml += `<button class="btn" onclick="loadFiles(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
            }
            
            document.getElementById('pagination').innerHTML = paginationHtml;
        }

        // æœç´¢æ–‡ä»¶
        function searchFiles() {
            currentSearch = document.getElementById('search-input').value;
            loadFiles(1);
        }

        // åˆ é™¤æ–‡ä»¶
        async function deleteFile(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const result = await apiRequest(`/admin/files/${id}`, {
                    method: 'DELETE'
                });
                
                if (result.code === 200) {
                    alert('åˆ é™¤æˆåŠŸ');
                    loadFiles(currentPage);
                    loadStats();
                } else {
                    alert(result.message || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // ç¼–è¾‘æ–‡ä»¶
        async function editFile(id) {
            try {
                const response = await fetch(`/admin/files/${id}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const file = await response.json();
                    
                    // æ˜¾ç¤ºç¼–è¾‘è¡¨å•
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                    `;
                    
                    modal.innerHTML = `
                        <div class="modal-content" style="
                            background: white;
                            padding: 20px;
                            border-radius: 8px;
                            width: 90%;
                            max-width: 500px;
                            max-height: 80vh;
                            overflow-y: auto;
                        ">
                            <h3>ç¼–è¾‘æ–‡ä»¶</h3>
                            <form id="editForm">
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px;">æ–‡ä»¶ä»£ç :</label>
                                    <input type="text" id="fileCode" value="${file.code}" required style="
                                        width: 100%;
                                        padding: 8px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        box-sizing: border-box;
                                    ">
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px;">è¿‡æœŸæ—¶é—´:</label>
                                    <input type="datetime-local" id="expiredAt" value="${new Date(file.expired_at).toISOString().slice(0, 16)}" style="
                                        width: 100%;
                                        padding: 8px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        box-sizing: border-box;
                                    ">
                                </div>
                                
                                ${file.text ? `
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px;">æ–‡æœ¬å†…å®¹:</label>
                                        <textarea id="textContent" rows="10" style="
                                            width: 100%;
                                            padding: 8px;
                                            border: 1px solid #ddd;
                                            border-radius: 4px;
                                            box-sizing: border-box;
                                            resize: vertical;
                                        ">${file.text}</textarea>
                                    </div>
                                ` : ''}
                                
                                <div style="text-align: right;">
                                    <button type="button" class="btn btn-danger" onclick="this.closest('.modal').remove()" style="margin-right: 10px;">å–æ¶ˆ</button>
                                    <button type="submit" class="btn">ä¿å­˜</button>
                                </div>
                            </form>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // å¤„ç†è¡¨å•æäº¤
                    document.getElementById('editForm').onsubmit = async (e) => {
                        e.preventDefault();
                        
                        const updateData = {
                            code: document.getElementById('fileCode').value,
                            expired_at: document.getElementById('expiredAt').value
                        };
                        
                        if (file.text) {
                            updateData.text = document.getElementById('textContent').value;
                        }
                        
                        const updateResponse = await fetch(`/admin/files/${id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: JSON.stringify(updateData)
                        });
                        
                        if (updateResponse.ok) {
                            modal.remove();
                            loadFiles(); // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
                            alert('æ–‡ä»¶æ›´æ–°æˆåŠŸ');
                        } else {
                            const errorText = await updateResponse.text();
                            alert('æ›´æ–°å¤±è´¥: ' + errorText);
                        }
                    };
                    
                    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
                    modal.onclick = (e) => {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    };
                }
            } catch (error) {
                alert('è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }

        // ä¸‹è½½æ–‡ä»¶
        async function downloadFile(id) {
            try {
                const response = await fetch(`/admin/files/download?id=${id}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'download';
                    
                    if (contentDisposition) {
                        const matches = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (matches != null && matches[1]) {
                            filename = matches[1].replace(/['"]/g, '');
                        }
                    }
                    
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    const error = await response.text();
                    alert('ä¸‹è½½å¤±è´¥: ' + error);
                }
            } catch (error) {
                alert('ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // åŠ è½½å¯¹åº”æ ‡ç­¾çš„æ•°æ®
            if (tabName === 'storage') {
                loadStorageInfo();
            }
        }

        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const result = await apiRequest('/admin/config');
                
                if (result.code === 200) {
                    const config = result.detail;
                    const form = document.getElementById('config-form');
                    
                    form.name.value = config.name || '';
                    form.description.value = config.description || '';
                    form.upload_size.value = (config.upload_size || 0) / (1024 * 1024);
                    form.admin_token.value = config.admin_token || '';
                    form.host.value = config.host || '0.0.0.0';
                    form.chunk_size.value = (config.chunk_size || 0) / (1024 * 1024);
                    form.enable_concurrent_download.checked = config.enable_concurrent_download === 1;
                    form.max_concurrent_downloads.value = config.max_concurrent_downloads || 10;
                    form.download_timeout.value = config.download_timeout || 300;
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        // ä¿å­˜é…ç½®
        document.getElementById('config-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const config = {};
            
            for (let [key, value] of formData.entries()) {
                if (key === 'upload_size' || key === 'chunk_size') {
                    config[key] = parseInt(value) * 1024 * 1024;
                } else if (key === 'enable_concurrent_download') {
                    config[key] = 1; // å¦‚æœå‹¾é€‰äº†ï¼Œå€¼ä¸º1
                } else if (key === 'max_concurrent_downloads' || key === 'download_timeout') {
                    config[key] = parseInt(value);
                } else {
                    config[key] = value;
                }
            }
            
            // å¦‚æœæ²¡æœ‰å‹¾é€‰å¹¶å‘ä¸‹è½½ï¼Œè®¾ç½®ä¸º0
            if (!document.querySelector('input[name="enable_concurrent_download"]').checked) {
                config.enable_concurrent_download = 0;
            }
            
            try {
                const result = await apiRequest('/admin/config', {
                    method: 'PUT',
                    body: JSON.stringify(config)
                });
                
                if (result.code === 200) {
                    alert('é…ç½®ä¿å­˜æˆåŠŸ');
                } else {
                    alert(result.message || 'ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        });

        // æ¸…ç†è¿‡æœŸæ–‡ä»¶
        async function cleanExpiredFiles() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†è¿‡æœŸæ–‡ä»¶å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const result = await apiRequest('/admin/clean', {
                    method: 'POST'
                });
                
                if (result.code === 200) {
                    const count = result.detail.cleaned_count;
                    document.getElementById('maintenance-result').innerHTML = 
                        `<div class="alert alert-success">æ¸…ç†å®Œæˆï¼Œå…±æ¸…ç†äº† ${count} ä¸ªè¿‡æœŸæ–‡ä»¶</div>`;
                    loadStats();
                    loadFiles(currentPage);
                } else {
                    document.getElementById('maintenance-result').innerHTML = 
                        `<div class="alert alert-danger">æ¸…ç†å¤±è´¥: ${result.message}</div>`;
                }
            } catch (error) {
                document.getElementById('maintenance-result').innerHTML = 
                    `<div class="alert alert-danger">æ¸…ç†å¤±è´¥: ${error.message}</div>`;
            }
        }

        // ç›‘å¬å›è½¦é”®æœç´¢
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchFiles();
            }
        });

        // æ¨¡æ€æ¡†ç›¸å…³
        document.querySelector('.close').onclick = function() {
            closeModal();
        }

        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('edit-modal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // å­˜å‚¨ç®¡ç†ç›¸å…³å‡½æ•°
        let currentStorageType = 'local';
        let selectedStorageType = 'local';
        let storageData = {};

        async function loadStorageInfo() {
            try {
                const result = await apiRequest('/admin/storage');
                
                if (result.code === 200) {
                    const detail = result.detail;
                    storageData = detail;
                    currentStorageType = detail.current;
                    selectedStorageType = detail.current;
                    
                    // æ›´æ–°å½“å‰å­˜å‚¨æ˜¾ç¤º
                    updateCurrentStorageDisplay();
                    
                    // æ›´æ–°å­˜å‚¨å¡ç‰‡çŠ¶æ€
                    updateStorageCards();
                    
                    // åŠ è½½å­˜å‚¨é…ç½®
                    loadStorageConfig(detail.storage_config);
                    
                    // æ›´æ–°æ“ä½œæŒ‰é’®
                    updateActionButtons();
                } else {
                    showAlert('åŠ è½½å­˜å‚¨ä¿¡æ¯å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('åŠ è½½å­˜å‚¨ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
            }
        }

        function updateCurrentStorageDisplay() {
            const nameElement = document.getElementById('current-storage-name');
            const statusElement = document.getElementById('current-storage-status');
            
            const storageNames = {
                'local': 'æœ¬åœ°å­˜å‚¨',
                'webdav': 'WebDAV å­˜å‚¨',
                's3': 'S3 å¯¹è±¡å­˜å‚¨'
            };
            
            nameElement.textContent = storageNames[currentStorageType] || currentStorageType;
            
            if (storageData.storage_details && storageData.storage_details[currentStorageType]) {
                const isAvailable = storageData.storage_details[currentStorageType].available;
                statusElement.textContent = isAvailable ? 'âœ… è¿è¡Œæ­£å¸¸' : 'âŒ è¿æ¥å¼‚å¸¸';
                statusElement.style.color = isAvailable ? '#28a745' : '#dc3545';
            }
        }

        function updateStorageCards() {
            const cards = ['local', 'webdav', 's3'];
            
            cards.forEach(type => {
                const card = document.getElementById(type + '-card');
                const statusElement = document.getElementById(type + '-status');
                
                if (!card || !statusElement) return;
                
                // é‡ç½®æ ·å¼
                card.style.borderColor = '#e9ecef';
                card.style.transform = 'none';
                
                // è®¾ç½®å½“å‰ä½¿ç”¨çš„å­˜å‚¨æ ·å¼
                if (type === currentStorageType) {
                    card.style.borderColor = '#28a745';
                    card.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
                }
                
                // è®¾ç½®é€‰ä¸­çš„å­˜å‚¨æ ·å¼
                if (type === selectedStorageType) {
                    card.style.borderColor = '#007bff';
                    card.style.transform = 'translateY(-2px)';
                    card.style.boxShadow = '0 4px 15px rgba(0,123,255,0.3)';
                }
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                if (storageData.storage_details && storageData.storage_details[type]) {
                    const details = storageData.storage_details[type];
                    const statusBadge = statusElement.querySelector('.status-badge');
                    
                    if (details.available) {
                        statusBadge.textContent = 'âœ… å¯ç”¨';
                        statusBadge.style.background = '#28a745';
                        statusBadge.style.color = 'white';
                    } else {
                        statusBadge.textContent = 'âŒ ä¸å¯ç”¨';
                        statusBadge.style.background = '#dc3545';
                        statusBadge.style.color = 'white';
                        
                        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                        if (details.error) {
                            const errorDiv = document.createElement('div');
                            errorDiv.style.marginTop = '10px';
                            errorDiv.style.padding = '8px';
                            errorDiv.style.background = '#f8d7da';
                            errorDiv.style.border = '1px solid #f5c6cb';
                            errorDiv.style.borderRadius = '4px';
                            errorDiv.style.fontSize = '12px';
                            errorDiv.style.color = '#721c24';
                            errorDiv.textContent = 'é”™è¯¯: ' + getUserFriendlyError(details.error);
                            
                            // ç§»é™¤æ—§çš„é”™è¯¯ä¿¡æ¯
                            const oldError = statusElement.querySelector('.error-info');
                            if (oldError) oldError.remove();
                            
                            errorDiv.className = 'error-info';
                            statusElement.appendChild(errorDiv);
                        }
                    }
                } else {
                    const statusBadge = statusElement.querySelector('.status-badge');
                    statusBadge.textContent = 'â³ æœªæ£€æŸ¥';
                    statusBadge.style.background = '#6c757d';
                    statusBadge.style.color = 'white';
                }
            });
        }

        function getUserFriendlyError(error) {
            if (error.includes('403')) {
                return 'æ²¡æœ‰å†™å…¥æƒé™ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå¯†ç æˆ–æœåŠ¡å™¨æƒé™è®¾ç½®';
            } else if (error.includes('401')) {
                return 'è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ';
            } else if (error.includes('404')) {
                return 'è·¯å¾„ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€å’Œæ ¹ç›®å½•';
            } else if (error.includes('timeout') || error.includes('connection')) {
                return 'è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€å’Œç½‘ç»œè¿æ¥';
            } else if (error.includes('hostname') || error.includes('resolve')) {
                return 'æ— æ³•è§£ææœåŠ¡å™¨åœ°å€ï¼Œè¯·æ£€æŸ¥åŸŸåæˆ–IP';
            } else {
                return error;
            }
        }

        function selectStorageCard(type) {
            selectedStorageType = type;
            updateStorageCards();
            updateActionButtons();
        }

        function updateActionButtons() {
            const configBtn = document.getElementById('config-btn');
            const saveConfigBtn = document.getElementById('save-config-btn');
            const testBtn = document.getElementById('test-btn');
            const switchBtn = document.getElementById('switch-btn');
            
            // æ˜¾ç¤ºæ‰€æœ‰æŒ‰é’®
            configBtn.style.display = 'inline-block';
            testBtn.style.display = 'inline-block';
            
            // å¦‚æœé€‰ä¸­çš„ä¸æ˜¯å½“å‰å­˜å‚¨ï¼Œæ˜¾ç¤ºåˆ‡æ¢æŒ‰é’®
            if (selectedStorageType !== currentStorageType) {
                switchBtn.style.display = 'inline-block';
                const storageNames = {
                    'local': 'æœ¬åœ°å­˜å‚¨',
                    'webdav': 'WebDAV å­˜å‚¨',
                    's3': 'S3 å¯¹è±¡å­˜å‚¨'
                };
                switchBtn.textContent = `åˆ‡æ¢åˆ°${storageNames[selectedStorageType]}`;
            } else {
                switchBtn.style.display = 'none';
            }
        }

        function toggleStorageConfig() {
            const configDiv = document.getElementById(selectedStorageType + '-config');
            const configBtn = document.getElementById('config-btn');
            const saveConfigBtn = document.getElementById('save-config-btn');
            const configBtnText = document.getElementById('config-btn-text');
            
            if (configDiv.style.display === 'none' || !configDiv.style.display) {
                configDiv.style.display = 'block';
                configBtnText.textContent = 'éšè—é…ç½®';
                saveConfigBtn.style.display = 'inline-block';
            } else {
                configDiv.style.display = 'none';
                configBtnText.textContent = 'é…ç½®å­˜å‚¨';
                saveConfigBtn.style.display = 'none';
            }
        }

        function loadStorageConfig(config) {
            // åŠ è½½æœ¬åœ°å­˜å‚¨é…ç½®
            if (config.local) {
                document.getElementById('local-storage-path').value = config.local.storage_path || '';
            }
            
            // åŠ è½½ WebDAV é…ç½®
            if (config.webdav) {
                document.getElementById('webdav-hostname').value = config.webdav.hostname || '';
                document.getElementById('webdav-username').value = config.webdav.username || '';
                document.getElementById('webdav-root-path').value = config.webdav.root_path || '';
                // ä¸åŠ è½½å¯†ç ï¼Œä¿æŒä¸ºç©º
                document.getElementById('webdav-password').value = '';
            }
            
            // åŠ è½½ S3 é…ç½®
            if (config.s3) {
                document.getElementById('s3-endpoint-url').value = config.s3.endpoint_url || '';
                document.getElementById('s3-access-key-id').value = config.s3.access_key_id || '';
                document.getElementById('s3-bucket-name').value = config.s3.bucket_name || '';
                document.getElementById('s3-region-name').value = config.s3.region_name || '';
                document.getElementById('s3-hostname').value = config.s3.hostname || '';
                // ä¸åŠ è½½å¯†é’¥ï¼Œä¿æŒä¸ºç©º
                document.getElementById('s3-secret-access-key').value = '';
            }
        }

        async function testStorageConnection() {
            const testBtn = document.getElementById('test-btn');
            const originalText = testBtn.textContent;
            
            testBtn.textContent = 'æµ‹è¯•ä¸­...';
            testBtn.disabled = true;
            
            try {
                const result = await apiRequest(`/admin/storage/test/${selectedStorageType}`);
                
                if (result.code === 200) {
                    showAlert('âœ… è¿æ¥æµ‹è¯•æˆåŠŸï¼å­˜å‚¨å¯ä»¥æ­£å¸¸ä½¿ç”¨', 'success');
                    // é‡æ–°åŠ è½½å­˜å‚¨ä¿¡æ¯ä»¥æ›´æ–°çŠ¶æ€
                    await loadStorageInfo();
                } else {
                    const friendlyError = getUserFriendlyError(result.message);
                    showAlert('âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ' + friendlyError, 'error');
                }
            } catch (error) {
                const friendlyError = getUserFriendlyError(error.message);
                showAlert('âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ' + friendlyError, 'error');
            } finally {
                testBtn.textContent = originalText;
                testBtn.disabled = false;
            }
        }

        async function saveStorageConfig() {
            const saveBtn = document.getElementById('save-config-btn');
            const originalText = saveBtn.textContent;
            
            saveBtn.textContent = 'ä¿å­˜ä¸­...';
            saveBtn.disabled = true;
            
            let config = {};
            
            if (selectedStorageType === 'local') {
                config = {
                    storage_path: document.getElementById('local-storage-path').value.trim()
                };
            } else if (selectedStorageType === 'webdav') {
                const hostname = document.getElementById('webdav-hostname').value.trim();
                const username = document.getElementById('webdav-username').value.trim();
                const password = document.getElementById('webdav-password').value;
                const rootPath = document.getElementById('webdav-root-path').value.trim();
                
                if (!hostname || !username) {
                    showAlert('è¯·å¡«å†™æœåŠ¡å™¨åœ°å€å’Œç”¨æˆ·å', 'error');
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                    return;
                }
                
                config = {
                    hostname: hostname,
                    username: username,
                    root_path: rootPath || 'filebox_storage'
                };
                
                // åªæœ‰å¡«å†™äº†å¯†ç æ‰å‘é€
                if (password) {
                    config.password = password;
                }
            } else if (selectedStorageType === 's3') {
                const endpointUrl = document.getElementById('s3-endpoint-url').value.trim();
                const accessKeyId = document.getElementById('s3-access-key-id').value.trim();
                const secretAccessKey = document.getElementById('s3-secret-access-key').value;
                const bucketName = document.getElementById('s3-bucket-name').value.trim();
                const regionName = document.getElementById('s3-region-name').value.trim();
                const hostname = document.getElementById('s3-hostname').value.trim();
                
                if (!endpointUrl || !accessKeyId || !bucketName) {
                    showAlert('è¯·å¡«å†™ç«¯ç‚¹åœ°å€ã€è®¿é—®å¯†é’¥å’Œå­˜å‚¨æ¡¶åç§°', 'error');
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                    return;
                }
                
                config = {
                    endpoint_url: endpointUrl,
                    access_key_id: accessKeyId,
                    bucket_name: bucketName,
                    region_name: regionName || 'us-east-1',
                    hostname: hostname
                };
                
                // åªæœ‰å¡«å†™äº†å¯†é’¥æ‰å‘é€
                if (secretAccessKey) {
                    config.secret_access_key = secretAccessKey;
                }
            }
            
            try {
                const result = await apiRequest('/admin/storage/config', {
                    method: 'PUT',
                    body: JSON.stringify({
                        storage_type: selectedStorageType,
                        config: config
                    })
                });
                
                if (result.code === 200) {
                    showAlert('âœ… å­˜å‚¨é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                    // æ¸…ç©ºå¯†ç å­—æ®µ
                    const passwordField = document.getElementById('webdav-password');
                    if (passwordField) passwordField.value = '';
                    // éšè—é…ç½®é¢æ¿
                    document.getElementById(selectedStorageType + '-config').style.display = 'none';
                    document.getElementById('config-btn-text').textContent = 'é…ç½®å­˜å‚¨';
                    document.getElementById('save-config-btn').style.display = 'none';
                    // é‡æ–°åŠ è½½ä¿¡æ¯
                    await loadStorageInfo();
                } else {
                    showAlert('âŒ å­˜å‚¨é…ç½®ä¿å­˜å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('âŒ å­˜å‚¨é…ç½®ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            } finally {
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }

        function confirmStorageSwitch() {
            const modal = document.getElementById('switch-confirm-modal');
            const confirmText = document.getElementById('switch-confirm-text');
            
            const storageNames = {
                'local': 'æœ¬åœ°å­˜å‚¨',
                'webdav': 'WebDAV å­˜å‚¨',
                's3': 'S3 å¯¹è±¡å­˜å‚¨'
            };
            
            const currentName = storageNames[currentStorageType];
            const targetName = storageNames[selectedStorageType];
            
            confirmText.textContent = `ç¡®å®šè¦ä»ã€Œ${currentName}ã€åˆ‡æ¢åˆ°ã€Œ${targetName}ã€å—ï¼Ÿåˆ‡æ¢åæ–°ä¸Šä¼ çš„æ–‡ä»¶å°†ä¿å­˜åˆ°æ–°çš„å­˜å‚¨ä½ç½®ã€‚`;
            modal.style.display = 'flex';
        }

        function cancelStorageSwitch() {
            const modal = document.getElementById('switch-confirm-modal');
            modal.style.display = 'none';
        }

        async function executeStorageSwitch() {
            const modal = document.getElementById('switch-confirm-modal');
            modal.style.display = 'none';
            
            const switchBtn = document.getElementById('switch-btn');
            const originalText = switchBtn.textContent;
            
            switchBtn.textContent = 'åˆ‡æ¢ä¸­...';
            switchBtn.disabled = true;
            
            try {
                const result = await apiRequest('/admin/storage/switch', {
                    method: 'POST',
                    body: JSON.stringify({
                        storage_type: selectedStorageType
                    })
                });
                
                if (result.code === 200) {
                    showAlert('âœ… å­˜å‚¨åˆ‡æ¢æˆåŠŸï¼', 'success');
                    currentStorageType = selectedStorageType;
                    await loadStorageInfo(); // é‡æ–°åŠ è½½ä¿¡æ¯
                } else {
                    showAlert('âŒ å­˜å‚¨åˆ‡æ¢å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('âŒ å­˜å‚¨åˆ‡æ¢å¤±è´¥: ' + error.message, 'error');
            } finally {
                switchBtn.textContent = originalText;
                switchBtn.disabled = false;
            }
        }

        // æ·»åŠ å¡ç‰‡ç‚¹å‡»äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('local-card').addEventListener('click', () => selectStorageCard('local'));
            document.getElementById('webdav-card').addEventListener('click', () => selectStorageCard('webdav'));
            document.getElementById('s3-card').addEventListener('click', () => selectStorageCard('s3'));
        });
    </script>
</body>
</html>
