<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台 - FileCodeBox</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/images/logo-small.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        
        .logout-btn:hover {
            background: #c82333;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
            font-size: 1.5em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .tabs {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .tab-header {
            display: flex;
            border-bottom: 1px solid #eee;
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            padding: 20px;
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-text {
            display: block;
            margin-top: 5px;
            font-size: 0.875em;
            color: #666;
            line-height: 1.4;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background 0.3s ease;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .table tr:hover {
            background: #f8f9fa;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
        }
        
        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        
        .alert-danger {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .btn-sm {
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
            margin-right: 5px;
            margin-bottom: 5px;
            transition: background 0.3s ease;
        }
        
        .btn-sm:hover {
            background: #5a6fd8;
        }
        
        .btn-sm.active {
            background: #495057;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-header {
                flex-direction: column;
            }
            
            .header {
                flex-direction: column;
                gap: 10px;
            }
            
            .table {
                font-size: 0.8em;
            }
        }
        
        /* 用户管理样式 */
        .user-stats {
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .user-email {
            color: #666;
            font-size: 0.9em;
        }
        
        .user-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .role-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .role-admin {
            background: #667eea;
            color: white;
        }
        
        .role-user {
            background: #e9ecef;
            color: #495057;
        }
        
        .user-actions {
            display: flex;
            gap: 5px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .close {
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .modal-form .form-group {
            margin-bottom: 20px;
        }
        
        .modal-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .modal-form .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .modal-form .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }
        
        .modal-form select.form-control {
            cursor: pointer;
        }
        
        .modal-form .btn {
            margin-right: 10px;
        }
        
        .user-row {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .user-row:hover {
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <!-- 登录页面 -->
    <div id="login-page" class="login-container">
        <h2 class="login-title">管理员登录</h2>
        <form id="login-form">
            <div class="form-group">
                <label>管理员密码</label>
                <input type="password" class="form-control" id="admin-password" required>
            </div>
            <button type="submit" class="btn" style="width: 100%;">登录</button>
        </form>
    </div>

    <!-- 管理页面 -->
    <div id="admin-page" style="display: none;">
        <div class="container">
            <div class="header">
                <div class="logo">
                    <img class="logo-icon" src="assets/images/logo-small.svg" alt="FileCodeBox Logo"/>
                    <span>FileCodeBox 管理后台</span>
                </div>
                <button class="logout-btn" onclick="logout()">退出登录</button>
            </div>

            <div class="stats-grid" id="stats-grid">
                <!-- 统计数据将通过JavaScript填充 -->
            </div>

            <div class="tabs">
                <div class="tab-header">
                    <button class="tab-btn active" onclick="switchTab('files')">文件管理</button>
                    <button class="tab-btn" onclick="switchTab('users')">用户管理</button>
                    <button class="tab-btn" onclick="switchTab('storage')">存储管理</button>
                    <button class="tab-btn" onclick="switchTab('mcp')">MCP 服务器</button>
                    <button class="tab-btn" onclick="switchTab('config')">系统配置</button>
                    <button class="tab-btn" onclick="switchTab('maintenance')">系统维护</button>
                </div>

                <!-- 文件管理 -->
                <div id="files-tab" class="tab-content active">
                    <div class="search-box">
                        <input type="text" class="form-control" id="search-input" placeholder="搜索文件..." style="display: inline-block; width: 300px; margin-right: 10px;">
                        <button class="btn" onclick="searchFiles()">搜索</button>
                        <button class="btn" onclick="loadFiles()">刷新</button>
                    </div>
                    
                    <div id="files-content">
                        <div class="loading">加载中...</div>
                    </div>
                    
                    <div class="pagination" id="pagination">
                        <!-- 分页将通过JavaScript生成 -->
                    </div>
                </div>

                <!-- 用户管理 -->
                <div id="users-tab" class="tab-content">
                    <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>用户管理</h3>
                        <button class="btn" onclick="loadUsers()">刷新</button>
                    </div>
                    
                    <!-- 用户统计 -->
                    <div class="user-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;" id="user-stats">
                        <!-- 统计卡片将动态加载 -->
                    </div>
                    
                    <!-- 用户搜索 -->
                    <div class="search-box">
                        <input type="text" class="form-control" id="user-search-input" placeholder="搜索用户名或邮箱..." style="display: inline-block; width: 300px; margin-right: 10px;">
                        <button class="btn" onclick="searchUsers()">搜索</button>
                        <button class="btn" onclick="showCreateUserModal()">添加用户</button>
                    </div>
                    
                    <!-- 用户列表 -->
                    <div id="users-content">
                        <div class="loading">加载中...</div>
                    </div>
                    
                    <!-- 分页 -->
                    <div class="pagination" id="user-pagination">
                        <!-- 分页将通过JavaScript生成 -->
                    </div>
                </div>

                <!-- 存储管理 -->
                <div id="storage-tab" class="tab-content">
                    <h3>存储管理</h3>
                    <p style="color: #666; margin-bottom: 30px;">管理文件存储位置，支持本地存储和 WebDAV 远程存储</p>
                    
                    <!-- 存储类型卡片 -->
                    <div class="storage-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- 本地存储卡片 -->
                        <div class="storage-card" id="local-card" style="border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <div class="storage-icon" style="width: 40px; height: 40px; background: #28a745; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <span style="color: white; font-size: 18px;">💾</span>
                                </div>
                                <div>
                                    <h4 style="margin: 0;">本地存储</h4>
                                    <p style="margin: 0; color: #666; font-size: 14px;">文件存储在服务器本地磁盘</p>
                                </div>
                            </div>
                            <div class="storage-status" id="local-status">
                                <span class="status-badge" style="display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">检查中...</span>
                            </div>
                            <div class="storage-config" id="local-config" style="margin-top: 15px; display: none;">
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">存储路径</label>
                                    <input type="text" id="local-storage-path" class="form-control" placeholder="留空使用默认路径 (./data/share/data)" style="width: 100%;">
                                    <small style="color: #666;">可以指定自定义的存储路径，留空使用默认路径</small>
                                </div>
                            </div>
                        </div>

                        <!-- WebDAV 存储卡片 -->
                        <div class="storage-card" id="webdav-card" style="border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <div class="storage-icon" style="width: 40px; height: 40px; background: #007bff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <span style="color: white; font-size: 18px;">☁️</span>
                                </div>
                                <div>
                                    <h4 style="margin: 0;">WebDAV 存储</h4>
                                    <p style="margin: 0; color: #666; font-size: 14px;">文件存储在 WebDAV 远程服务器</p>
                                </div>
                            </div>
                            <div class="storage-status" id="webdav-status">
                                <span class="status-badge" style="display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">检查中...</span>
                            </div>
                            <div class="storage-config" id="webdav-config" style="margin-top: 15px; display: none;">
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">服务器地址</label>
                                    <input type="text" id="webdav-hostname" class="form-control" placeholder="http://example.com:5005" style="width: 100%;">
                                    <small style="color: #666;">WebDAV 服务器的完整地址，包含协议和端口</small>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">用户名</label>
                                        <input type="text" id="webdav-username" class="form-control" style="width: 100%;">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">密码</label>
                                        <input type="password" id="webdav-password" class="form-control" style="width: 100%;">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">根目录</label>
                                    <input type="text" id="webdav-root-path" class="form-control" placeholder="filebox_storage" style="width: 100%;">
                                    <small style="color: #666;">在 WebDAV 服务器上创建的存储目录名称</small>
                                </div>
                            </div>
                        </div>

                        <!-- NFS 存储卡片 -->
                        <div class="storage-card" id="nfs-card" style="border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <div class="storage-icon" style="width: 40px; height: 40px; background: #6f42c1; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <span style="color: white; font-size: 18px;">🗂️</span>
                                </div>
                                <div>
                                    <h4 style="margin: 0;">NFS 网络存储</h4>
                                    <p style="margin: 0; color: #666; font-size: 14px;">文件存储在 NFS 网络文件系统</p>
                                </div>
                            </div>
                            <div class="storage-status" id="nfs-status">
                                <span class="status-badge" style="display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">检查中...</span>
                            </div>
                            <div class="storage-config" id="nfs-config" style="margin-top: 15px; display: none;">
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">NFS 服务器地址</label>
                                    <input type="text" id="nfs-server" class="form-control" placeholder="192.168.1.100" style="width: 100%;">
                                    <small style="color: #666;">NFS 服务器的 IP 地址或域名</small>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">NFS 路径</label>
                                        <input type="text" id="nfs-path" class="form-control" placeholder="/nfs/storage" style="width: 100%;">
                                        <small style="color: #666;">服务器导出的路径</small>
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">挂载点</label>
                                        <input type="text" id="nfs-mount-point" class="form-control" placeholder="/mnt/nfs" style="width: 100%;">
                                        <small style="color: #666;">本地挂载目录</small>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">NFS 版本</label>
                                        <select id="nfs-version" class="form-control" style="width: 100%;">
                                            <option value="3">NFSv3</option>
                                            <option value="4" selected>NFSv4</option>
                                            <option value="4.1">NFSv4.1</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">超时时间(秒)</label>
                                        <input type="number" id="nfs-timeout" class="form-control" placeholder="30" min="10" max="300" style="width: 100%;">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">挂载选项</label>
                                    <input type="text" id="nfs-options" class="form-control" placeholder="rw,sync,hard,intr" style="width: 100%;">
                                    <small style="color: #666;">NFS 挂载选项，多个选项用逗号分隔</small>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label style="display: flex; align-items: center;">
                                            <input type="checkbox" id="nfs-auto-mount" style="margin-right: 8px;">
                                            自动挂载
                                        </label>
                                        <small style="color: #666;">启动时自动挂载 NFS</small>
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">重试次数</label>
                                        <input type="number" id="nfs-retry-count" class="form-control" placeholder="3" min="1" max="10" style="width: 100%;">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">存储子路径</label>
                                    <input type="text" id="nfs-sub-path" class="form-control" placeholder="filebox_storage" style="width: 100%;">
                                    <small style="color: #666;">在挂载点下创建的存储目录</small>
                                </div>
                            </div>
                        </div>

                        <!-- S3 存储卡片 -->
                        <div class="storage-card" id="s3-card" style="border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; background: white; cursor: pointer; transition: all 0.3s;">
                            <div style="display: flex; align-items: center; margin-bottom: 15px;">
                                <div class="storage-icon" style="width: 40px; height: 40px; background: #ff9500; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                    <span style="color: white; font-size: 18px;">📦</span>
                                </div>
                                <div>
                                    <h4 style="margin: 0;">S3 对象存储</h4>
                                    <p style="margin: 0; color: #666; font-size: 14px;">文件存储在 S3 兼容的对象存储服务</p>
                                </div>
                            </div>
                            <div class="storage-status" id="s3-status">
                                <span class="status-badge" style="display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">检查中...</span>
                            </div>
                            <div class="storage-config" id="s3-config" style="margin-top: 15px; display: none;">
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">端点地址</label>
                                    <input type="text" id="s3-endpoint-url" class="form-control" placeholder="https://s3.amazonaws.com" style="width: 100%;">
                                    <small style="color: #666;">S3 服务的端点地址，AWS S3 或兼容服务</small>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">访问密钥</label>
                                        <input type="text" id="s3-access-key-id" class="form-control" placeholder="Access Key ID" style="width: 100%;">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">密钥</label>
                                        <input type="password" id="s3-secret-access-key" class="form-control" placeholder="Secret Access Key" style="width: 100%;">
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">存储桶名称</label>
                                        <input type="text" id="s3-bucket-name" class="form-control" placeholder="my-bucket" style="width: 100%;">
                                    </div>
                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">区域</label>
                                        <input type="text" id="s3-region-name" class="form-control" placeholder="us-east-1" style="width: 100%;">
                                    </div>
                                </div>
                                <div class="form-group" style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">自定义域名 (可选)</label>
                                    <input type="text" id="s3-hostname" class="form-control" placeholder="cdn.example.com" style="width: 100%;">
                                    <small style="color: #666;">用于文件访问的自定义域名，留空使用默认域名</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="storage-actions" style="text-align: center; margin-bottom: 30px;">
                        <button class="btn" id="config-btn" onclick="toggleStorageConfig()" style="margin-right: 10px; display: none;">
                            <span id="config-btn-text">配置存储</span>
                        </button>
                        <button class="btn btn-primary" id="save-config-btn" onclick="saveStorageConfig()" style="margin-right: 10px; display: none;">保存配置</button>
                        <button class="btn btn-success" id="test-btn" onclick="testStorageConnection()" style="margin-right: 10px; display: none;">测试连接</button>
                        <button class="btn btn-warning" id="switch-btn" onclick="confirmStorageSwitch()" style="display: none;">切换到此存储</button>
                    </div>

                    <!-- 当前状态信息 -->
                    <div class="current-storage-info" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <h4 style="margin: 0 0 10px 0;">当前使用的存储</h4>
                        <div id="current-storage-display" style="font-size: 18px; font-weight: bold;">
                            <span id="current-storage-name">加载中...</span>
                            <span id="current-storage-status" style="margin-left: 10px; font-size: 14px; opacity: 0.9;"></span>
                        </div>
                    </div>

                    <!-- 存储切换确认对话框 -->
                    <div id="switch-confirm-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
                        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 400px; text-align: center;">
                            <h4 style="margin-bottom: 20px;">确认切换存储</h4>
                            <p id="switch-confirm-text" style="margin-bottom: 20px; color: #666;"></p>
                            <div>
                                <button class="btn btn-secondary" onclick="cancelStorageSwitch()" style="margin-right: 10px;">取消</button>
                                <button class="btn btn-primary" onclick="executeStorageSwitch()">确认切换</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MCP 服务器管理 -->
                <div id="mcp-tab" class="tab-content">
                    <h3>MCP 服务器管理</h3>
                    <p style="color: #666; margin-bottom: 30px;">Model Context Protocol (MCP) 服务器允许 AI 工具与 FileCodeBox 进行集成</p>
                    
                    <!-- 服务器状态卡片 -->
                    <div class="mcp-status-card" style="background: white; border-radius: 10px; padding: 25px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center;">
                                <div class="mcp-status-icon" id="mcp-status-icon" style="width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 20px; font-size: 24px;">
                                    ⏳
                                </div>
                                <div>
                                    <h4 style="margin: 0; color: #333;" id="mcp-status-title">MCP 服务器状态</h4>
                                    <p style="margin: 5px 0 0 0; color: #666;" id="mcp-status-desc">正在检查服务器状态...</p>
                                </div>
                            </div>
                            <div class="mcp-control-buttons" id="mcp-control-buttons">
                                <button class="btn" id="mcp-toggle-btn" onclick="toggleMCPServer()" disabled>启动服务器</button>
                                <button class="btn btn-secondary" id="mcp-restart-btn" onclick="restartMCPServer()" disabled>重启服务器</button>
                            </div>
                        </div>
                    </div>

                    <!-- MCP 配置面板 -->
                    <div class="mcp-config-panel" style="background: white; border-radius: 10px; padding: 25px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">
                        <h4 style="margin-bottom: 20px; color: #667eea;">MCP 服务器配置</h4>
                        
                        <form id="mcp-config-form">
                            <div class="form-group">
                                <label style="display: flex; align-items: center; font-weight: bold;">
                                    <input type="checkbox" id="enable_mcp_server" style="margin-right: 10px;">
                                    启用 MCP 服务器
                                </label>
                                <small class="form-text">启用后，AI 工具可以通过 MCP 协议与 FileCodeBox 进行交互</small>
                            </div>
                            
                            <div class="mcp-config-details" id="mcp-config-details" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div class="form-group">
                                        <label>服务器端口</label>
                                        <input type="text" id="mcp_port" class="form-control" placeholder="8081">
                                        <small class="form-text">MCP 服务器监听的端口号</small>
                                    </div>
                                    <div class="form-group">
                                        <label>绑定地址</label>
                                        <input type="text" id="mcp_host" class="form-control" placeholder="0.0.0.0">
                                        <small class="form-text">服务器绑定的IP地址，0.0.0.0表示绑定所有网络接口</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top: 25px;">
                                <button type="submit" class="btn" id="save-mcp-config-btn">保存配置</button>
                                <button type="button" class="btn btn-secondary" onclick="loadMCPConfig()">重置</button>
                            </div>
                        </form>
                    </div>

                    <!-- MCP 工具和资源信息 -->
                    <div class="mcp-features" style="background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">
                        <h4 style="margin-bottom: 20px; color: #667eea;">MCP 功能特性</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                            <!-- 工具列表 -->
                            <div>
                                <h5 style="color: #333; margin-bottom: 15px;">🔧 可用工具 (Tools)</h5>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>upload_file</strong> - 上传文件
                                    </li>
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>download_file</strong> - 下载文件
                                    </li>
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>list_files</strong> - 列出文件
                                    </li>
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>delete_file</strong> - 删除文件
                                    </li>
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>search_files</strong> - 搜索文件
                                    </li>
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>get_file_info</strong> - 获取文件信息
                                    </li>
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>set_file_permissions</strong> - 设置文件权限
                                    </li>
                                    <li style="padding: 8px 0;">
                                        <strong>get_system_stats</strong> - 获取系统统计
                                    </li>
                                </ul>
                            </div>
                            
                            <!-- 资源列表 -->
                            <div>
                                <h5 style="color: #333; margin-bottom: 15px;">📁 可用资源 (Resources)</h5>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>file://content</strong> - 文件内容
                                    </li>
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>file://list</strong> - 文件列表
                                    </li>
                                    <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong>file://info</strong> - 文件信息
                                    </li>
                                    <li style="padding: 8px 0;">
                                        <strong>file://search</strong> - 搜索结果
                                    </li>
                                </ul>
                                
                                <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #007bff;">
                                    <h6 style="margin: 0 0 10px 0; color: #0056b3;">连接信息</h6>
                                    <p style="margin: 0; font-size: 14px; color: #004085;">
                                        启用 MCP 服务器后，AI 工具可以通过 stdio 连接到：<br>
                                        <code style="background: #fff; padding: 2px 6px; border-radius: 3px;">localhost:<span id="mcp-port-display">8081</span></code>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 系统配置 -->
                <div id="config-tab" class="tab-content">
                    <form id="config-form">
                        <div class="form-group">
                            <label>站点名称</label>
                            <input type="text" class="form-control" name="name">
                        </div>
                        <div class="form-group">
                            <label>站点描述</label>
                            <input type="text" class="form-control" name="description">
                        </div>
                        <div class="form-group">
                            <label>上传大小限制 (MB)</label>
                            <input type="number" class="form-control" name="upload_size">
                        </div>
                        <div class="form-group">
                            <label>管理员密码</label>
                            <input type="password" class="form-control" name="admin_token">
                        </div>
                        <div class="form-group">
                            <label>服务器绑定地址</label>
                            <input type="text" class="form-control" name="host" placeholder="例如: 0.0.0.0 (允许外部访问) 或 localhost (仅本地访问)">
                            <small class="form-text">默认 0.0.0.0 允许外部访问，localhost 仅允许本地访问</small>
                        </div>
                        <div class="form-group">
                            <label>分块上传大小 (MB)</label>
                            <input type="number" class="form-control" name="chunk_size" min="1" max="100">
                            <small class="form-text">单个分块的大小，影响大文件上传性能</small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="enable_concurrent_download"> 
                                启用并发下载
                            </label>
                            <small class="form-text">允许同时进行多个下载任务</small>
                        </div>
                        <div class="form-group">
                            <label>最大并发下载数</label>
                            <input type="number" class="form-control" name="max_concurrent_downloads" min="1" max="50">
                            <small class="form-text">同时允许的最大下载连接数</small>
                        </div>
                        <div class="form-group">
                            <label>下载超时时间 (秒)</label>
                            <input type="number" class="form-control" name="download_timeout" min="60" max="3600">
                            <small class="form-text">单个下载任务的超时时间</small>
                        </div>
                        <div class="form-group">
                            <h4 style="color: #667eea; margin-top: 30px; margin-bottom: 15px; border-bottom: 2px solid #e0e7ff; padding-bottom: 5px;">用户系统设置</h4>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="enable_user_system" id="enable_user_system"> 
                                启用用户系统
                            </label>
                            <small class="form-text">启用后用户可以注册账号并管理自己的文件</small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="allow_user_registration" id="allow_user_registration"> 
                                允许用户注册
                            </label>
                            <small class="form-text">允许新用户自主注册账号</small>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="require_email_verify"> 
                                需要邮箱验证
                            </label>
                            <small class="form-text">新用户注册后需要验证邮箱才能使用</small>
                        </div>
                        <div class="form-group">
                            <label>用户单次上传大小限制 (MB)</label>
                            <input type="number" class="form-control" name="user_upload_size" min="1" max="1000">
                            <small class="form-text">普通用户单个文件的上传大小限制</small>
                        </div>
                        <div class="form-group">
                            <label>用户存储配额 (MB)</label>
                            <input type="number" class="form-control" name="user_storage_quota" min="0">
                            <small class="form-text">每个用户的总存储空间限制，0 表示无限制</small>
                        </div>
                        <div class="form-group">
                            <label>会话过期时间 (小时)</label>
                            <input type="number" class="form-control" name="session_expiry_hours" min="1" max="720">
                            <small class="form-text">用户登录会话的有效期</small>
                        </div>
                        <div class="form-group">
                            <label>单用户最大会话数</label>
                            <input type="number" class="form-control" name="max_sessions_per_user" min="1" max="10">
                            <small class="form-text">每个用户同时允许的最大登录会话数</small>
                        </div>
                        <button type="submit" class="btn">保存配置</button>
                    </form>
                </div>

                <!-- 系统维护 -->
                <div id="maintenance-tab" class="tab-content">
                    <h3>系统维护</h3>
                    <p>清理过期文件和无效数据</p>
                    <button class="btn btn-danger" onclick="cleanExpiredFiles()">清理过期文件</button>
                    
                    <div id="maintenance-result" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑文件模态框 -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>编辑文件信息</h3>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label>提取码</label>
                    <input type="text" class="form-control" id="edit-code">
                </div>
                <div class="form-group">
                    <label>文件名</label>
                    <input type="text" class="form-control" id="edit-prefix">
                </div>
                <div class="form-group">
                    <label>文件扩展名</label>
                    <input type="text" class="form-control" id="edit-suffix">
                </div>
                <div class="form-group">
                    <label>过期时间</label>
                    <input type="datetime-local" class="form-control" id="edit-expired-at">
                </div>
                <div class="form-group">
                    <label>使用次数限制</label>
                    <input type="number" class="form-control" id="edit-expired-count">
                </div>
                <button type="submit" class="btn">保存更改</button>
                <button type="button" class="btn btn-danger" onclick="closeModal()">取消</button>
            </form>
        </div>
    </div>

    <script>
        // 全局变量
        let currentPage = 1;
        let currentSearch = '';
        let authToken = localStorage.getItem('admin_token');

        // 显示提示信息
        function showAlert(message, type = 'info') {
            // 创建一个临时的提示框
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 9999;
                max-width: 400px;
                word-wrap: break-word;
            `;
            
            // 根据类型设置背景色
            switch(type) {
                case 'success':
                    alertDiv.style.backgroundColor = '#28a745';
                    break;
                case 'error':
                    alertDiv.style.backgroundColor = '#dc3545';
                    break;
                case 'warning':
                    alertDiv.style.backgroundColor = '#ffc107';
                    alertDiv.style.color = '#212529';
                    break;
                default:
                    alertDiv.style.backgroundColor = '#17a2b8';
            }
            
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            // 3秒后自动移除
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            if (authToken) {
                showAdminPage();
            } else {
                showLoginPage();
            }
            
            // 添加存储类型选择器的变化监听器
            const storageSelect = document.getElementById('storage-type-select');
            if (storageSelect) {
                storageSelect.addEventListener('change', function() {
                    const selectedType = this.value;
                    showStorageConfig(selectedType);
                });
            }
            
            // 添加用户系统开关的监听器
            const enableUserSystem = document.getElementById('enable_user_system');
            if (enableUserSystem) {
                enableUserSystem.addEventListener('change', toggleUserSystemOptions);
            }
        });

        // 显示登录页面
        function showLoginPage() {
            document.getElementById('login-page').style.display = 'block';
            document.getElementById('admin-page').style.display = 'none';
        }

        // 显示管理页面
        function showAdminPage() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('admin-page').style.display = 'block';
            loadStats();
            loadFiles();
            loadConfig();
        }

        // 登录
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const password = document.getElementById('admin-password').value;
            
            try {
                const response = await fetch('/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password: password })
                });
                
                const result = await response.json();
                
                if (result.code === 200) {
                    authToken = result.detail.token;
                    localStorage.setItem('admin_token', authToken);
                    showAdminPage();
                } else {
                    alert(result.message || '登录失败');
                }
            } catch (error) {
                alert('登录失败: ' + error.message);
            }
        });

        // 退出登录
        function logout() {
            authToken = null;
            localStorage.removeItem('admin_token');
            showLoginPage();
        }

        // API请求封装
        async function apiRequest(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken
                }
            };
            
            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            };
            
            const response = await fetch(url, finalOptions);
            
            if (response.status === 401) {
                logout();
                throw new Error('认证失败');
            }
            
            return response.json();
        }

        // 加载统计数据
        async function loadStats() {
            try {
                const result = await apiRequest('/admin/dashboard');
                
                if (result.code === 200) {
                    const stats = result.detail;
                    const statsHtml = `
                        <div class="stat-card">
                            <div class="stat-number">${stats.total_files || 0}</div>
                            <div class="stat-label">总文件数</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.today_uploads || 0}</div>
                            <div class="stat-label">今日上传</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.active_files || 0}</div>
                            <div class="stat-label">活跃文件</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${formatFileSize(stats.total_size || 0)}</div>
                            <div class="stat-label">总存储大小</div>
                        </div>
                    `;
                    document.getElementById('stats-grid').innerHTML = statsHtml;
                }
            } catch (error) {
                console.error('加载统计数据失败:', error);
            }
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 格式化时间
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }

        // 加载文件列表
        async function loadFiles(page = 1) {
            currentPage = page;
            
            try {
                const result = await apiRequest(`/admin/files?page=${page}&page_size=20&search=${currentSearch}`);
                
                if (result.code === 200) {
                    const data = result.detail;
                    const files = data.list || []; // 修复：使用 list 而不是 files
                    
                    let tableHtml = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>提取码</th>
                                    <th>文件名</th>
                                    <th>大小</th>
                                    <th>创建时间</th>
                                    <th>过期时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    files.forEach(file => {
                        tableHtml += `
                            <tr>
                                <td>${file.ID}</td>
                                <td>${file.code}</td>
                                <td>${file.prefix}${file.suffix}</td>
                                <td>${formatFileSize(file.size)}</td>
                                <td>${formatDateTime(file.CreatedAt)}</td>
                                <td>${formatDateTime(file.expired_at)}</td>
                                <td>
                                    <button class="btn" onclick="editFile('${file.code}')">编辑</button>
                                    <button class="btn btn-danger" onclick="deleteFile('${file.code}')">删除</button>
                                    ${file.text ? '' : `<button class="btn btn-success" onclick="downloadFile('${file.code}')">下载</button>`}
                                </td>
                            </tr>
                        `;
                    });
                    
                    tableHtml += '</tbody></table>';
                    
                    document.getElementById('files-content').innerHTML = tableHtml;
                    
                    // 生成分页
                    generatePagination(data.total, data.page, data.page_size);
                }
            } catch (error) {
                console.error('加载文件列表失败:', error);
                document.getElementById('files-content').innerHTML = '<div class="alert alert-danger">加载失败</div>';
            }
        }

        // 生成分页
        function generatePagination(total, currentPage, pageSize) {
            const totalPages = Math.ceil(total / pageSize);
            let paginationHtml = '';
            
            if (totalPages > 1) {
                paginationHtml += `<button class="btn" onclick="loadFiles(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>上一页</button>`;
                paginationHtml += `<span>第 ${currentPage} 页，共 ${totalPages} 页</span>`;
                paginationHtml += `<button class="btn" onclick="loadFiles(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>下一页</button>`;
            }
            
            document.getElementById('pagination').innerHTML = paginationHtml;
        }

        // 搜索文件
        function searchFiles() {
            currentSearch = document.getElementById('search-input').value;
            loadFiles(1);
        }

        // 删除文件
        async function deleteFile(code) {
            if (!confirm('确定要删除这个文件吗？')) {
                return;
            }
            
            try {
                const result = await apiRequest(`/admin/files/${code}`, {
                    method: 'DELETE'
                });
                
                if (result.code === 200) {
                    alert('删除成功');
                    loadFiles(currentPage);
                    loadStats();
                } else {
                    alert(result.message || '删除失败');
                }
            } catch (error) {
                alert('删除失败: ' + error.message);
            }
        }

        // 安全的时间格式化函数
        function formatDateTimeLocal(dateString) {
            try {
                if (!dateString) return '';
                
                // 处理不同的时间格式
                let date;
                if (dateString.includes('+') || dateString.includes('Z')) {
                    // 带时区的ISO字符串
                    date = new Date(dateString);
                } else {
                    // 简单的日期字符串
                    date = new Date(dateString + 'Z'); // 添加Z表示UTC时间
                }
                
                if (isNaN(date.getTime())) {
                    console.warn('Invalid date format:', dateString);
                    return '';
                }
                
                // 转换为本地时间的datetime-local格式 (YYYY-MM-DDTHH:mm)
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            } catch (error) {
                console.warn('Error formatting date:', dateString, error);
                return '';
            }
        }

        // 编辑文件
        async function editFile(code) {
            try {
                const response = await fetch(`/admin/files/${code}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const file = result.detail; // 解析detail字段
                    
                    // 显示编辑表单
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                    `;
                    
                    modal.innerHTML = `
                        <div class="modal-content" style="
                            background: white;
                            padding: 20px;
                            border-radius: 8px;
                            width: 90%;
                            max-width: 500px;
                            max-height: 80vh;
                            overflow-y: auto;
                        ">
                            <h3>编辑文件</h3>
                            <form id="editForm">
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px;">文件代码:</label>
                                    <input type="text" id="fileCode" value="${file.code}" required style="
                                        width: 100%;
                                        padding: 8px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        box-sizing: border-box;
                                    ">
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; margin-bottom: 5px;">过期时间:</label>
                                    <input type="datetime-local" id="expiredAt" value="${formatDateTimeLocal(file.expired_at)}" style="
                                        width: 100%;
                                        padding: 8px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        box-sizing: border-box;
                                    ">
                                </div>
                                
                                ${file.text ? `
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; margin-bottom: 5px;">文本内容:</label>
                                        <textarea id="textContent" rows="10" style="
                                            width: 100%;
                                            padding: 8px;
                                            border: 1px solid #ddd;
                                            border-radius: 4px;
                                            box-sizing: border-box;
                                            resize: vertical;
                                        ">${file.text}</textarea>
                                    </div>
                                ` : ''}
                                
                                <div style="text-align: right;">
                                    <button type="button" class="btn btn-danger" onclick="this.closest('.modal').remove()" style="margin-right: 10px;">取消</button>
                                    <button type="submit" class="btn">保存</button>
                                </div>
                            </form>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // 处理表单提交
                    document.getElementById('editForm').onsubmit = async (e) => {
                        e.preventDefault();
                        
                        const updateData = {
                            code: document.getElementById('fileCode').value,
                            expired_at: document.getElementById('expiredAt').value
                        };
                        
                        if (file.text) {
                            updateData.text = document.getElementById('textContent').value;
                        }
                        
                        const updateResponse = await fetch(`/admin/files/${id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: JSON.stringify(updateData)
                        });
                        
                        if (updateResponse.ok) {
                            modal.remove();
                            loadFiles(); // 重新加载文件列表
                            alert('文件更新成功');
                        } else {
                            const errorText = await updateResponse.text();
                            alert('更新失败: ' + errorText);
                        }
                    };
                    
                    // 点击模态框外部关闭
                    modal.onclick = (e) => {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    };
                }
            } catch (error) {
                alert('获取文件信息失败: ' + error.message);
            }
        }

        // 下载文件
        async function downloadFile(code) {
            try {
                const response = await fetch(`/admin/files/download?code=${code}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'download';
                    
                    if (contentDisposition) {
                        const matches = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                        if (matches != null && matches[1]) {
                            filename = matches[1].replace(/['"]/g, '');
                        }
                    }
                    
                    // 创建下载链接
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    const error = await response.text();
                    alert('下载失败: ' + error);
                }
            } catch (error) {
                alert('下载失败: ' + error.message);
            }
        }

        // 切换标签页
        function switchTab(tabName) {
            // 更新按钮状态
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // 更新内容显示
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // 加载对应标签的数据
            if (tabName === 'storage') {
                loadStorageInfo();
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'mcp') {
                loadMCPConfig();
                loadMCPStatus();
            }
        }

        // 加载配置
        async function loadConfig() {
            try {
                const result = await apiRequest('/admin/config');
                
                if (result.code === 200) {
                    const config = result.detail;
                    const form = document.getElementById('config-form');
                    
                    form.name.value = config.name || '';
                    form.description.value = config.description || '';
                    form.upload_size.value = (config.upload_size || 0) / (1024 * 1024);
                    form.admin_token.value = config.admin_token || '';
                    form.host.value = config.host || '0.0.0.0';
                    form.chunk_size.value = (config.chunk_size || 0) / (1024 * 1024);
                    form.enable_concurrent_download.checked = config.enable_concurrent_download === 1;
                    form.max_concurrent_downloads.value = config.max_concurrent_downloads || 10;
                    form.download_timeout.value = config.download_timeout || 300;
                    
                    // 用户系统配置
                    form.enable_user_system.checked = config.enable_user_system === 1;
                    form.allow_user_registration.checked = config.allow_user_registration === 1;
                    form.require_email_verify.checked = config.require_email_verify === 1;
                    form.user_upload_size.value = (config.user_upload_size || 0) / (1024 * 1024);
                    form.user_storage_quota.value = (config.user_storage_quota || 0) / (1024 * 1024);
                    form.session_expiry_hours.value = config.session_expiry_hours || 24;
                    form.max_sessions_per_user.value = config.max_sessions_per_user || 3;
                    
                    // 根据用户系统启用状态控制相关选项
                    toggleUserSystemOptions();
                }
            } catch (error) {
                console.error('加载配置失败:', error);
            }
        }

        // 保存配置
        document.getElementById('config-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const config = {};
            
            for (let [key, value] of formData.entries()) {
                if (key === 'upload_size' || key === 'chunk_size' || key === 'user_upload_size' || key === 'user_storage_quota') {
                    config[key] = parseInt(value) * 1024 * 1024;
                } else if (key === 'enable_concurrent_download' || key === 'enable_user_system' || 
                          key === 'allow_user_registration' || key === 'require_email_verify') {
                    config[key] = 1; // 如果勾选了，值为1
                } else if (key === 'max_concurrent_downloads' || key === 'download_timeout' || 
                          key === 'session_expiry_hours' || key === 'max_sessions_per_user') {
                    config[key] = parseInt(value);
                } else {
                    config[key] = value;
                }
            }
            
            // 如果没有勾选相关选项，设置为0
            if (!document.querySelector('input[name="enable_concurrent_download"]').checked) {
                config.enable_concurrent_download = 0;
            }
            if (!document.querySelector('input[name="enable_user_system"]').checked) {
                config.enable_user_system = 0;
            }
            if (!document.querySelector('input[name="allow_user_registration"]').checked) {
                config.allow_user_registration = 0;
            }
            if (!document.querySelector('input[name="require_email_verify"]').checked) {
                config.require_email_verify = 0;
            }
            
            try {
                const result = await apiRequest('/admin/config', {
                    method: 'PUT',
                    body: JSON.stringify(config)
                });
                
                if (result.code === 200) {
                    alert('配置保存成功');
                } else {
                    alert(result.message || '保存失败');
                }
            } catch (error) {
                alert('保存失败: ' + error.message);
            }
        });

        // 控制用户系统相关选项的启用状态
        function toggleUserSystemOptions() {
            const enableUserSystem = document.getElementById('enable_user_system');
            const userSystemFields = [
                'allow_user_registration',
                'require_email_verify',
                'user_upload_size',
                'user_storage_quota',
                'session_expiry_hours',
                'max_sessions_per_user'
            ];
            
            userSystemFields.forEach(fieldName => {
                const field = document.querySelector(`[name="${fieldName}"]`);
                if (field) {
                    field.disabled = !enableUserSystem.checked;
                    if (field.type === 'checkbox' && !enableUserSystem.checked) {
                        field.checked = false;
                    }
                }
            });
        }

        // 清理过期文件
        async function cleanExpiredFiles() {
            if (!confirm('确定要清理过期文件吗？')) {
                return;
            }
            
            try {
                const result = await apiRequest('/admin/clean', {
                    method: 'POST'
                });
                
                if (result.code === 200) {
                    const count = result.detail.cleaned_count;
                    document.getElementById('maintenance-result').innerHTML = 
                        `<div class="alert alert-success">清理完成，共清理了 ${count} 个过期文件</div>`;
                    loadStats();
                    loadFiles(currentPage);
                } else {
                    document.getElementById('maintenance-result').innerHTML = 
                        `<div class="alert alert-danger">清理失败: ${result.message}</div>`;
                }
            } catch (error) {
                document.getElementById('maintenance-result').innerHTML = 
                    `<div class="alert alert-danger">清理失败: ${error.message}</div>`;
            }
        }

        // 监听回车键搜索
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchFiles();
            }
        });

        // 模态框相关
        document.querySelector('.close').onclick = function() {
            closeModal();
        }

        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('edit-modal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // 存储管理相关函数
        let currentStorageType = 'local';
        let selectedStorageType = 'local';
        let storageData = {};

        async function loadStorageInfo() {
            try {
                const result = await apiRequest('/admin/storage');
                
                if (result.code === 200) {
                    const detail = result.detail;
                    storageData = detail;
                    currentStorageType = detail.current;
                    selectedStorageType = detail.current;
                    
                    // 更新当前存储显示
                    updateCurrentStorageDisplay();
                    
                    // 更新存储卡片状态
                    updateStorageCards();
                    
                    // 加载存储配置
                    loadStorageConfig(detail.storage_config);
                    
                    // 更新操作按钮
                    updateActionButtons();
                } else {
                    showAlert('加载存储信息失败: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('加载存储信息失败: ' + error.message, 'error');
            }
        }

        function updateCurrentStorageDisplay() {
            const nameElement = document.getElementById('current-storage-name');
            const statusElement = document.getElementById('current-storage-status');
            
            const storageNames = {
                'local': '本地存储',
                'webdav': 'WebDAV 存储',
                's3': 'S3 对象存储'
            };
            
            nameElement.textContent = storageNames[currentStorageType] || currentStorageType;
            
            if (storageData.storage_details && storageData.storage_details[currentStorageType]) {
                const isAvailable = storageData.storage_details[currentStorageType].available;
                statusElement.textContent = isAvailable ? '✅ 运行正常' : '❌ 连接异常';
                statusElement.style.color = isAvailable ? '#28a745' : '#dc3545';
            }
        }

        function updateStorageCards() {
            const cards = ['local', 'webdav', 'nfs', 's3'];
            
            cards.forEach(type => {
                const card = document.getElementById(type + '-card');
                const statusElement = document.getElementById(type + '-status');
                
                if (!card || !statusElement) return;
                
                // 重置样式
                card.style.borderColor = '#e9ecef';
                card.style.transform = 'none';
                
                // 设置当前使用的存储样式
                if (type === currentStorageType) {
                    card.style.borderColor = '#28a745';
                    card.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
                }
                
                // 设置选中的存储样式
                if (type === selectedStorageType) {
                    card.style.borderColor = '#007bff';
                    card.style.transform = 'translateY(-2px)';
                    card.style.boxShadow = '0 4px 15px rgba(0,123,255,0.3)';
                }
                
                // 更新状态显示
                if (storageData.storage_details && storageData.storage_details[type]) {
                    const details = storageData.storage_details[type];
                    const statusBadge = statusElement.querySelector('.status-badge');
                    
                    if (details.available) {
                        statusBadge.textContent = '✅ 可用';
                        statusBadge.style.background = '#28a745';
                        statusBadge.style.color = 'white';
                    } else {
                        statusBadge.textContent = '❌ 不可用';
                        statusBadge.style.background = '#dc3545';
                        statusBadge.style.color = 'white';
                        
                        // 显示错误信息
                        if (details.error) {
                            const errorDiv = document.createElement('div');
                            errorDiv.style.marginTop = '10px';
                            errorDiv.style.padding = '8px';
                            errorDiv.style.background = '#f8d7da';
                            errorDiv.style.border = '1px solid #f5c6cb';
                            errorDiv.style.borderRadius = '4px';
                            errorDiv.style.fontSize = '12px';
                            errorDiv.style.color = '#721c24';
                            errorDiv.textContent = '错误: ' + getUserFriendlyError(details.error);
                            
                            // 移除旧的错误信息
                            const oldError = statusElement.querySelector('.error-info');
                            if (oldError) oldError.remove();
                            
                            errorDiv.className = 'error-info';
                            statusElement.appendChild(errorDiv);
                        }
                    }
                } else {
                    const statusBadge = statusElement.querySelector('.status-badge');
                    statusBadge.textContent = '⏳ 未检查';
                    statusBadge.style.background = '#6c757d';
                    statusBadge.style.color = 'white';
                }
            });
        }

        function getUserFriendlyError(error) {
            if (error.includes('403')) {
                return '没有写入权限，请检查用户名密码或服务器权限设置';
            } else if (error.includes('401')) {
                return '认证失败，请检查用户名和密码';
            } else if (error.includes('404')) {
                return '路径不存在，请检查服务器地址和根目录';
            } else if (error.includes('timeout') || error.includes('connection')) {
                return '连接超时，请检查服务器地址和网络连接';
            } else if (error.includes('hostname') || error.includes('resolve')) {
                return '无法解析服务器地址，请检查域名或IP';
            } else if (error.includes('mount') || error.includes('NFS')) {
                return 'NFS挂载失败，请检查服务器配置和挂载参数';
            } else if (error.includes('permission denied')) {
                return '权限被拒绝，请检查NFS导出权限和本地挂载权限';
            } else if (error.includes('no such file or directory')) {
                return '路径不存在，请检查NFS服务器路径或本地挂载点';
            } else {
                return error;
            }
        }

        function selectStorageCard(type) {
            selectedStorageType = type;
            updateStorageCards();
            updateActionButtons();
        }

        function updateActionButtons() {
            const configBtn = document.getElementById('config-btn');
            const saveConfigBtn = document.getElementById('save-config-btn');
            const testBtn = document.getElementById('test-btn');
            const switchBtn = document.getElementById('switch-btn');
            
            // 显示所有按钮
            configBtn.style.display = 'inline-block';
            testBtn.style.display = 'inline-block';
            
            // 如果选中的不是当前存储，显示切换按钮
            if (selectedStorageType !== currentStorageType) {
                switchBtn.style.display = 'inline-block';
                const storageNames = {
                    'local': '本地存储',
                    'webdav': 'WebDAV 存储',
                    'nfs': 'NFS 网络存储',
                    's3': 'S3 对象存储'
                };
                switchBtn.textContent = `切换到${storageNames[selectedStorageType]}`;
            } else {
                switchBtn.style.display = 'none';
            }
        }

        function toggleStorageConfig() {
            const configDiv = document.getElementById(selectedStorageType + '-config');
            const configBtn = document.getElementById('config-btn');
            const saveConfigBtn = document.getElementById('save-config-btn');
            const configBtnText = document.getElementById('config-btn-text');
            
            if (configDiv.style.display === 'none' || !configDiv.style.display) {
                configDiv.style.display = 'block';
                configBtnText.textContent = '隐藏配置';
                saveConfigBtn.style.display = 'inline-block';
            } else {
                configDiv.style.display = 'none';
                configBtnText.textContent = '配置存储';
                saveConfigBtn.style.display = 'none';
            }
        }

        function loadStorageConfig(config) {
            // 加载本地存储配置
            if (config.local) {
                document.getElementById('local-storage-path').value = config.local.storage_path || '';
            }
            
            // 加载 WebDAV 配置
            if (config.webdav) {
                document.getElementById('webdav-hostname').value = config.webdav.hostname || '';
                document.getElementById('webdav-username').value = config.webdav.username || '';
                document.getElementById('webdav-root-path').value = config.webdav.root_path || '';
                // 不加载密码，保持为空
                document.getElementById('webdav-password').value = '';
            }
            
            // 加载 NFS 配置
            if (config.nfs) {
                document.getElementById('nfs-server').value = config.nfs.server || '';
                document.getElementById('nfs-path').value = config.nfs.path || '';
                document.getElementById('nfs-mount-point').value = config.nfs.mount_point || '';
                document.getElementById('nfs-version').value = config.nfs.version || '4';
                document.getElementById('nfs-timeout').value = config.nfs.timeout || '30';
                document.getElementById('nfs-options').value = config.nfs.options || '';
                document.getElementById('nfs-auto-mount').checked = config.nfs.auto_mount || false;
                document.getElementById('nfs-retry-count').value = config.nfs.retry_count || '3';
                document.getElementById('nfs-sub-path').value = config.nfs.sub_path || '';
            }
            
            // 加载 S3 配置
            if (config.s3) {
                document.getElementById('s3-endpoint-url').value = config.s3.endpoint_url || '';
                document.getElementById('s3-access-key-id').value = config.s3.access_key_id || '';
                document.getElementById('s3-bucket-name').value = config.s3.bucket_name || '';
                document.getElementById('s3-region-name').value = config.s3.region_name || '';
                document.getElementById('s3-hostname').value = config.s3.hostname || '';
                // 不加载密钥，保持为空
                document.getElementById('s3-secret-access-key').value = '';
            }
        }

        async function testStorageConnection() {
            const testBtn = document.getElementById('test-btn');
            const originalText = testBtn.textContent;
            
            testBtn.textContent = '测试中...';
            testBtn.disabled = true;
            
            try {
                const result = await apiRequest(`/admin/storage/test/${selectedStorageType}`);
                
                if (result.code === 200) {
                    showAlert('✅ 连接测试成功！存储可以正常使用', 'success');
                    // 重新加载存储信息以更新状态
                    await loadStorageInfo();
                } else {
                    const friendlyError = getUserFriendlyError(result.message);
                    showAlert('❌ 连接测试失败: ' + friendlyError, 'error');
                }
            } catch (error) {
                const friendlyError = getUserFriendlyError(error.message);
                showAlert('❌ 连接测试失败: ' + friendlyError, 'error');
            } finally {
                testBtn.textContent = originalText;
                testBtn.disabled = false;
            }
        }

        async function saveStorageConfig() {
            const saveBtn = document.getElementById('save-config-btn');
            const originalText = saveBtn.textContent;
            
            saveBtn.textContent = '保存中...';
            saveBtn.disabled = true;
            
            let config = {};
            
            if (selectedStorageType === 'local') {
                config = {
                    storage_path: document.getElementById('local-storage-path').value.trim()
                };
            } else if (selectedStorageType === 'webdav') {
                const hostname = document.getElementById('webdav-hostname').value.trim();
                const username = document.getElementById('webdav-username').value.trim();
                const password = document.getElementById('webdav-password').value;
                const rootPath = document.getElementById('webdav-root-path').value.trim();
                
                if (!hostname || !username) {
                    showAlert('请填写服务器地址和用户名', 'error');
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                    return;
                }
                
                config = {
                    hostname: hostname,
                    username: username,
                    root_path: rootPath || 'filebox_storage'
                };
                
                // 只有填写了密码才发送
                if (password) {
                    config.password = password;
                }
            } else if (selectedStorageType === 'nfs') {
                const server = document.getElementById('nfs-server').value.trim();
                const path = document.getElementById('nfs-path').value.trim();
                const mountPoint = document.getElementById('nfs-mount-point').value.trim();
                
                if (!server || !path || !mountPoint) {
                    showAlert('请填写 NFS 服务器、路径和挂载点', 'error');
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                    return;
                }
                
                config = {
                    server: server,
                    path: path,
                    mount_point: mountPoint,
                    version: document.getElementById('nfs-version').value || '4',
                    timeout: parseInt(document.getElementById('nfs-timeout').value) || 30,
                    options: document.getElementById('nfs-options').value.trim() || 'rw,sync,hard,intr',
                    auto_mount: document.getElementById('nfs-auto-mount').checked,
                    retry_count: parseInt(document.getElementById('nfs-retry-count').value) || 3,
                    sub_path: document.getElementById('nfs-sub-path').value.trim() || 'filebox_storage'
                };
            } else if (selectedStorageType === 's3') {
                const endpointUrl = document.getElementById('s3-endpoint-url').value.trim();
                const accessKeyId = document.getElementById('s3-access-key-id').value.trim();
                const secretAccessKey = document.getElementById('s3-secret-access-key').value;
                const bucketName = document.getElementById('s3-bucket-name').value.trim();
                const regionName = document.getElementById('s3-region-name').value.trim();
                const hostname = document.getElementById('s3-hostname').value.trim();
                
                if (!endpointUrl || !accessKeyId || !bucketName) {
                    showAlert('请填写端点地址、访问密钥和存储桶名称', 'error');
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                    return;
                }
                
                config = {
                    endpoint_url: endpointUrl,
                    access_key_id: accessKeyId,
                    bucket_name: bucketName,
                    region_name: regionName || 'us-east-1',
                    hostname: hostname
                };
                
                // 只有填写了密钥才发送
                if (secretAccessKey) {
                    config.secret_access_key = secretAccessKey;
                }
            }
            
            try {
                const result = await apiRequest('/admin/storage/config', {
                    method: 'PUT',
                    body: JSON.stringify({
                        storage_type: selectedStorageType,
                        config: config
                    })
                });
                
                if (result.code === 200) {
                    showAlert('✅ 存储配置保存成功', 'success');
                    // 清空密码字段
                    const passwordField = document.getElementById('webdav-password');
                    if (passwordField) passwordField.value = '';
                    const s3SecretField = document.getElementById('s3-secret-access-key');
                    if (s3SecretField) s3SecretField.value = '';
                    // 隐藏配置面板
                    document.getElementById(selectedStorageType + '-config').style.display = 'none';
                    document.getElementById('config-btn-text').textContent = '配置存储';
                    document.getElementById('save-config-btn').style.display = 'none';
                    // 重新加载信息
                    await loadStorageInfo();
                } else {
                    showAlert('❌ 存储配置保存失败: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('❌ 存储配置保存失败: ' + error.message, 'error');
            } finally {
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }

        function confirmStorageSwitch() {
            const modal = document.getElementById('switch-confirm-modal');
            const confirmText = document.getElementById('switch-confirm-text');
            
            const storageNames = {
                'local': '本地存储',
                'webdav': 'WebDAV 存储',
                's3': 'S3 对象存储'
            };
            
            const currentName = storageNames[currentStorageType];
            const targetName = storageNames[selectedStorageType];
            
            confirmText.textContent = `确定要从「${currentName}」切换到「${targetName}」吗？切换后新上传的文件将保存到新的存储位置。`;
            modal.style.display = 'flex';
        }

        function cancelStorageSwitch() {
            const modal = document.getElementById('switch-confirm-modal');
            modal.style.display = 'none';
        }

        async function executeStorageSwitch() {
            const modal = document.getElementById('switch-confirm-modal');
            modal.style.display = 'none';
            
            const switchBtn = document.getElementById('switch-btn');
            const originalText = switchBtn.textContent;
            
            switchBtn.textContent = '切换中...';
            switchBtn.disabled = true;
            
            try {
                const result = await apiRequest('/admin/storage/switch', {
                    method: 'POST',
                    body: JSON.stringify({
                        storage_type: selectedStorageType
                    })
                });
                
                if (result.code === 200) {
                    showAlert('✅ 存储切换成功！', 'success');
                    currentStorageType = selectedStorageType;
                    await loadStorageInfo(); // 重新加载信息
                } else {
                    showAlert('❌ 存储切换失败: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('❌ 存储切换失败: ' + error.message, 'error');
            } finally {
                switchBtn.textContent = originalText;
                switchBtn.disabled = false;
            }
        }

        // 添加卡片点击事件
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('local-card').addEventListener('click', () => selectStorageCard('local'));
            document.getElementById('webdav-card').addEventListener('click', () => selectStorageCard('webdav'));
            document.getElementById('nfs-card').addEventListener('click', () => selectStorageCard('nfs'));
            document.getElementById('s3-card').addEventListener('click', () => selectStorageCard('s3'));
        });

        // ========== 用户管理功能 ==========
        
        let currentUserPage = 1;
        let currentUserSearch = '';
        
        // 加载用户列表
        async function loadUsers(page = 1, search = '') {
            currentUserPage = page;
            currentUserSearch = search;
            
            try {
                const params = new URLSearchParams({
                    page: page,
                    page_size: 20
                });
                
                if (search) {
                    params.append('search', search);
                }
                
                const result = await apiRequest(`/admin/users?${params}`);
                
                if (result.code === 200) {
                    const data = result.detail;
                    renderUsersList(data.users);
                    renderUserPagination(data.pagination);
                    renderUserStats(data.stats);
                } else {
                    showAlert('加载用户列表失败: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('加载用户列表失败: ' + error.message, 'error');
            }
        }
        
        // 渲染用户统计
        function renderUserStats(stats) {
            const container = document.getElementById('user-stats');
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">👥</div>
                    <div class="stat-value">${stats.total_users}</div>
                    <div class="stat-label">总用户数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">✅</div>
                    <div class="stat-value">${stats.active_users}</div>
                    <div class="stat-label">活跃用户</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📅</div>
                    <div class="stat-value">${stats.today_registrations}</div>
                    <div class="stat-label">今日注册</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📤</div>
                    <div class="stat-value">${stats.today_uploads}</div>
                    <div class="stat-label">今日上传</div>
                </div>
            `;
        }
        
        // 渲染用户列表
        function renderUsersList(users) {
            const container = document.getElementById('users-content');
            
            if (users.length === 0) {
                container.innerHTML = '<div class="loading">没有找到用户</div>';
                return;
            }
            
            let html = '';
            users.forEach(user => {
                const statusClass = user.is_active ? 'status-active' : 'status-inactive';
                const statusText = user.is_active ? '活跃' : '已禁用';
                const roleClass = user.is_admin ? 'role-admin' : 'role-user';
                const roleText = user.is_admin ? '管理员' : '用户';
                
                html += `
                    <div class="user-row">
                        <div class="user-avatar">${(user.nickname || user.username).charAt(0).toUpperCase()}</div>
                        <div class="user-info">
                            <div class="user-name">${user.nickname || user.username}</div>
                            <div class="user-email">${user.email}</div>
                            <div style="font-size: 0.8em; color: #999; margin-top: 2px;">
                                注册: ${formatDate(user.created_at)} | 
                                最后登录: ${user.last_login_at ? formatDate(user.last_login_at) : '从未登录'}
                            </div>
                        </div>
                        <div class="user-status">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                            <span class="role-badge ${roleClass}">${roleText}</span>
                        </div>
                        <div class="user-actions">
                            <button class="btn-sm" onclick="showEditUserModal('${user.id}')" style="background: #007bff; color: white;">编辑</button>
                            <button class="btn-sm" onclick="toggleUserStatus('${user.id}', ${!user.is_active})" 
                                    style="background: ${user.is_active ? '#dc3545' : '#28a745'}; color: white;">
                                ${user.is_active ? '禁用' : '启用'}
                            </button>
                            <button class="btn-sm" onclick="showUserFiles('${user.id}')" style="background: #17a2b8; color: white;">文件</button>
                            ${!user.is_admin ? `<button class="btn-sm" onclick="deleteUser('${user.id}')" style="background: #dc3545; color: white;">删除</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // 渲染用户分页
        function renderUserPagination(pagination) {
            const container = document.getElementById('user-pagination');
            
            if (pagination.pages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // 上一页
            if (pagination.page > 1) {
                html += `<button class="btn-sm" onclick="loadUsers(${pagination.page - 1}, '${currentUserSearch}')">上一页</button>`;
            }
            
            // 页码
            for (let i = 1; i <= pagination.pages; i++) {
                const active = i === pagination.page ? 'active' : '';
                html += `<button class="btn-sm ${active}" onclick="loadUsers(${i}, '${currentUserSearch}')">${i}</button>`;
            }
            
            // 下一页
            if (pagination.page < pagination.pages) {
                html += `<button class="btn-sm" onclick="loadUsers(${pagination.page + 1}, '${currentUserSearch}')">下一页</button>`;
            }
            
            container.innerHTML = html;
        }
        
        // 搜索用户
        function searchUsers() {
            const search = document.getElementById('user-search-input').value;
            loadUsers(1, search);
        }
        
        // 显示创建用户模态框
        function showCreateUserModal() {
            showUserModal('create');
        }
        
        // 显示编辑用户模态框
        async function showEditUserModal(userId) {
            try {
                const result = await apiRequest(`/admin/users/${userId}`);
                if (result.code === 200) {
                    showUserModal('edit', result.detail);
                } else {
                    showAlert('获取用户信息失败: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('获取用户信息失败: ' + error.message, 'error');
            }
        }
        
        // 显示用户模态框
        function showUserModal(mode, user = null) {
            const isEdit = mode === 'edit';
            const title = isEdit ? '编辑用户' : '添加用户';
            
            const modalHTML = `
                <div class="modal" id="user-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">${title}</div>
                            <span class="close" onclick="closeUserModal()">&times;</span>
                        </div>
                        <form class="modal-form" id="user-form">
                            <div class="form-group">
                                <label>用户名</label>
                                <input type="text" name="username" class="form-control" required 
                                       value="${user ? user.username : ''}" ${isEdit ? 'readonly' : ''}>
                            </div>
                            <div class="form-group">
                                <label>邮箱</label>
                                <input type="email" name="email" class="form-control" required 
                                       value="${user ? user.email : ''}">
                            </div>
                            <div class="form-group">
                                <label>昵称</label>
                                <input type="text" name="nickname" class="form-control" 
                                       value="${user ? user.nickname : ''}">
                            </div>
                            <div class="form-group">
                                <label>密码 ${isEdit ? '(留空则不修改)' : ''}</label>
                                <input type="password" name="password" class="form-control" 
                                       ${!isEdit ? 'required' : ''} minlength="6">
                            </div>
                            <div class="form-group">
                                <label>角色</label>
                                <select name="is_admin" class="form-control">
                                    <option value="false" ${user && !user.is_admin ? 'selected' : ''}>普通用户</option>
                                    <option value="true" ${user && user.is_admin ? 'selected' : ''}>管理员</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>状态</label>
                                <select name="is_active" class="form-control">
                                    <option value="true" ${!user || user.is_active ? 'selected' : ''}>启用</option>
                                    <option value="false" ${user && !user.is_active ? 'selected' : ''}>禁用</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn">${isEdit ? '更新' : '创建'}</button>
                                <button type="button" class="btn btn-secondary" onclick="closeUserModal()">取消</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // 移除现有模态框
            const existingModal = document.getElementById('user-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // 显示模态框
            const modal = document.getElementById('user-modal');
            modal.style.display = 'block';
            
            // 绑定表单提交事件
            document.getElementById('user-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleUserFormSubmit(isEdit, user ? user.id : null);
            });
            
            // 点击外部关闭模态框
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeUserModal();
                }
            });
        }
        
        // 关闭用户模态框
        function closeUserModal() {
            const modal = document.getElementById('user-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // 处理用户表单提交
        async function handleUserFormSubmit(isEdit, userId) {
            const form = document.getElementById('user-form');
            const formData = new FormData(form);
            
            const data = {
                username: formData.get('username'),
                email: formData.get('email'),
                nickname: formData.get('nickname'),
                is_admin: formData.get('is_admin') === 'true',
                is_active: formData.get('is_active') === 'true'
            };
            
            const password = formData.get('password');
            if (password) {
                data.password = password;
            }
            
            try {
                let result;
                if (isEdit) {
                    result = await apiRequest(`/admin/users/${userId}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                } else {
                    result = await apiRequest('/admin/users', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                }
                
                if (result.code === 200) {
                    showAlert(isEdit ? '用户更新成功' : '用户创建成功', 'success');
                    closeUserModal();
                    loadUsers(currentUserPage, currentUserSearch);
                } else {
                    showAlert((isEdit ? '更新' : '创建') + '失败: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert((isEdit ? '更新' : '创建') + '失败: ' + error.message, 'error');
            }
        }
        
        // 切换用户状态
        async function toggleUserStatus(userId, isActive) {
            if (!confirm(`确定要${isActive ? '启用' : '禁用'}此用户吗？`)) {
                return;
            }
            
            try {
                const result = await apiRequest(`/admin/users/${userId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        is_active: isActive
                    })
                });
                
                if (result.code === 200) {
                    showAlert('用户状态更新成功', 'success');
                    loadUsers(currentUserPage, currentUserSearch);
                } else {
                    showAlert('状态更新失败: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('状态更新失败: ' + error.message, 'error');
            }
        }
        
        // 删除用户
        async function deleteUser(userId) {
            if (!confirm('确定要删除此用户吗？这将同时删除用户的所有文件！')) {
                return;
            }
            
            try {
                const result = await apiRequest(`/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (result.code === 200) {
                    showAlert('用户删除成功', 'success');
                    loadUsers(currentUserPage, currentUserSearch);
                } else {
                    showAlert('删除失败: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('删除失败: ' + error.message, 'error');
            }
        }
        
        // 显示用户文件
        async function showUserFiles(userId) {
            try {
                const result = await apiRequest(`/admin/users/${userId}/files`);
                
                if (result.code === 200) {
                    const files = result.detail.files;
                    showUserFilesModal(files);
                } else {
                    showAlert('获取用户文件失败: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('获取用户文件失败: ' + error.message, 'error');
            }
        }
        
        // 显示用户文件模态框
        function showUserFilesModal(files) {
            let filesHTML = '';
            if (files.length === 0) {
                filesHTML = '<p style="text-align: center; color: #666;">该用户还没有上传任何文件</p>';
            } else {
                filesHTML = `
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>文件名</th>
                                    <th>大小</th>
                                    <th>上传时间</th>
                                    <th>下载次数</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                files.forEach(file => {
                    const fileName = file.prefix + file.suffix;
                    filesHTML += `
                        <tr>
                            <td>${fileName}</td>
                            <td>${formatFileSize(file.size)}</td>
                            <td>${formatDate(file.created_at)}</td>
                            <td>${file.used_count}</td>
                            <td>
                                <button class="btn-sm" onclick="deleteFile('${file.code}')" style="background: #dc3545; color: white;">删除</button>
                            </td>
                        </tr>
                    `;
                });
                
                filesHTML += '</tbody></table></div>';
            }
            
            const modalHTML = `
                <div class="modal" id="user-files-modal">
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <div class="modal-title">用户文件列表</div>
                            <span class="close" onclick="closeUserFilesModal()">&times;</span>
                        </div>
                        <div style="padding: 20px;">
                            ${filesHTML}
                        </div>
                    </div>
                </div>
            `;
            
            // 移除现有模态框
            const existingModal = document.getElementById('user-files-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // 显示模态框
            const modal = document.getElementById('user-files-modal');
            modal.style.display = 'block';
            
            // 点击外部关闭模态框
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeUserFilesModal();
                }
            });
        }
        
        // 关闭用户文件模态框
        function closeUserFilesModal() {
            const modal = document.getElementById('user-files-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // ========== MCP 服务器管理功能 ==========
        
        // 加载 MCP 配置
        async function loadMCPConfig() {
            try {
                const result = await apiRequest('/admin/mcp/config');
                
                if (result.code === 200) {
                    const config = result.detail;
                    
                    // 更新表单字段
                    document.getElementById('enable_mcp_server').checked = config.enable_mcp_server === 1;
                    document.getElementById('mcp_port').value = config.mcp_port || '8081';
                    document.getElementById('mcp_host').value = config.mcp_host || '0.0.0.0';
                    
                    // 更新端口显示
                    document.getElementById('mcp-port-display').textContent = config.mcp_port || '8081';
                    
                    // 切换配置详情显示
                    toggleMCPConfigDetails();
                } else {
                    showAlert('加载 MCP 配置失败: ' + result.message, 'error');
                }
            } catch (error) {
                showAlert('加载 MCP 配置失败: ' + error.message, 'error');
            }
        }
        
        // 加载 MCP 状态
        async function loadMCPStatus() {
            try {
                const result = await apiRequest('/admin/mcp/status');
                
                if (result.code === 200) {
                    const status = result.detail;
                    updateMCPStatusDisplay(status);
                } else {
                    showMCPError('获取状态失败: ' + result.message);
                }
            } catch (error) {
                showMCPError('获取状态失败: ' + error.message);
            }
        }
        
        // 更新 MCP 状态显示
        function updateMCPStatusDisplay(status) {
            const icon = document.getElementById('mcp-status-icon');
            const title = document.getElementById('mcp-status-title');
            const desc = document.getElementById('mcp-status-desc');
            const toggleBtn = document.getElementById('mcp-toggle-btn');
            const restartBtn = document.getElementById('mcp-restart-btn');
            
            if (status.running) {
                // 服务器运行中
                icon.style.background = '#28a745';
                icon.style.color = 'white';
                icon.textContent = '✅';
                
                title.textContent = 'MCP 服务器运行中';
                desc.textContent = `服务器正在端口 ${status.port || '8081'} 上运行`;
                
                toggleBtn.textContent = '停止服务器';
                toggleBtn.className = 'btn btn-danger';
                toggleBtn.disabled = false;
                
                restartBtn.disabled = false;
            } else {
                // 服务器已停止
                icon.style.background = '#6c757d';
                icon.style.color = 'white';
                icon.textContent = '⏸️';
                
                title.textContent = 'MCP 服务器已停止';
                
                if (status.config && status.config.enabled) {
                    desc.textContent = '服务器已启用但未运行，点击启动按钮开始服务';
                    toggleBtn.textContent = '启动服务器';
                    toggleBtn.className = 'btn btn-success';
                    toggleBtn.disabled = false;
                } else {
                    desc.textContent = '服务器未启用，请先在配置中启用MCP服务器';
                    toggleBtn.textContent = '启动服务器';
                    toggleBtn.className = 'btn btn-secondary';
                    toggleBtn.disabled = true;
                }
                
                restartBtn.disabled = true;
            }
        }
        
        // 显示 MCP 错误状态
        function showMCPError(errorMessage) {
            const icon = document.getElementById('mcp-status-icon');
            const title = document.getElementById('mcp-status-title');
            const desc = document.getElementById('mcp-status-desc');
            const toggleBtn = document.getElementById('mcp-toggle-btn');
            const restartBtn = document.getElementById('mcp-restart-btn');
            
            icon.style.background = '#dc3545';
            icon.style.color = 'white';
            icon.textContent = '❌';
            
            title.textContent = 'MCP 服务器状态异常';
            desc.textContent = errorMessage;
            
            toggleBtn.disabled = true;
            restartBtn.disabled = true;
        }
        
        // 切换 MCP 配置详情显示
        function toggleMCPConfigDetails() {
            const checkbox = document.getElementById('enable_mcp_server');
            const details = document.getElementById('mcp-config-details');
            
            if (checkbox.checked) {
                details.style.display = 'block';
            } else {
                details.style.display = 'none';
            }
        }
        
        // 切换 MCP 服务器
        async function toggleMCPServer() {
            const toggleBtn = document.getElementById('mcp-toggle-btn');
            const isRunning = toggleBtn.textContent.includes('停止');
            
            const originalText = toggleBtn.textContent;
            toggleBtn.textContent = isRunning ? '停止中...' : '启动中...';
            toggleBtn.disabled = true;
            
            try {
                const action = isRunning ? 'stop' : 'start';
                const result = await apiRequest('/admin/mcp/control', {
                    method: 'POST',
                    body: JSON.stringify({ action: action })
                });
                
                if (result.code === 200) {
                    showAlert(result.message, 'success');
                    // 延迟一秒后刷新状态
                    setTimeout(() => {
                        loadMCPStatus();
                    }, 1000);
                } else {
                    showAlert(result.message, 'error');
                    toggleBtn.textContent = originalText;
                    toggleBtn.disabled = false;
                }
            } catch (error) {
                showAlert('操作失败: ' + error.message, 'error');
                toggleBtn.textContent = originalText;
                toggleBtn.disabled = false;
            }
        }
        
        // 重启 MCP 服务器
        async function restartMCPServer() {
            const restartBtn = document.getElementById('mcp-restart-btn');
            const originalText = restartBtn.textContent;
            
            restartBtn.textContent = '重启中...';
            restartBtn.disabled = true;
            
            try {
                const result = await apiRequest('/admin/mcp/restart', {
                    method: 'POST'
                });
                
                if (result.code === 200) {
                    showAlert(result.message, 'success');
                    // 延迟一秒后刷新状态
                    setTimeout(() => {
                        loadMCPStatus();
                    }, 1000);
                } else {
                    showAlert(result.message, 'error');
                }
            } catch (error) {
                showAlert('重启失败: ' + error.message, 'error');
            } finally {
                restartBtn.textContent = originalText;
                restartBtn.disabled = false;
            }
        }
        
        // 初始化 MCP 相关事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            // 监听 MCP 启用状态变化
            const enableMCPCheckbox = document.getElementById('enable_mcp_server');
            if (enableMCPCheckbox) {
                enableMCPCheckbox.addEventListener('change', toggleMCPConfigDetails);
            }
            
            // MCP 配置表单提交
            const mcpConfigForm = document.getElementById('mcp-config-form');
            if (mcpConfigForm) {
                mcpConfigForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const saveBtn = document.getElementById('save-mcp-config-btn');
                    const originalText = saveBtn.textContent;
                    
                    saveBtn.textContent = '保存中...';
                    saveBtn.disabled = true;
                    
                    try {
                        const config = {
                            enable_mcp_server: document.getElementById('enable_mcp_server').checked ? 1 : 0,
                            mcp_port: document.getElementById('mcp_port').value.trim() || '8081',
                            mcp_host: document.getElementById('mcp_host').value.trim() || '0.0.0.0'
                        };
                        
                        const result = await apiRequest('/admin/mcp/config', {
                            method: 'PUT',
                            body: JSON.stringify(config)
                        });
                        
                        if (result.code === 200) {
                            showAlert('MCP 配置保存成功', 'success');
                            
                            // 更新端口显示
                            document.getElementById('mcp-port-display').textContent = config.mcp_port;
                            
                            // 延迟一秒后刷新状态
                            setTimeout(() => {
                                loadMCPStatus();
                            }, 1000);
                        } else {
                            showAlert('保存失败: ' + result.message, 'error');
                        }
                    } catch (error) {
                        showAlert('保存失败: ' + error.message, 'error');
                    } finally {
                        saveBtn.textContent = originalText;
                        saveBtn.disabled = false;
                    }
                });
            }
        });
    </script>
</body>
</html>
